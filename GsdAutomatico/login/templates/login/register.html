{% extends 'Base.html' %}

{% block title %}Registar Novo Utilizador{% endblock %}

{% block extra_head %}
    <style>
        /* (Estilos permanecem os mesmos) */
        .militar-selector { display: flex; align-items: center; gap: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-main); }
        #selected-militar-name { flex-grow: 1; color: var(--text-secondary); font-style: italic; }
        #selected-militar-name.selected { color: var(--text-primary); font-style: normal; }
        .permissions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .permission-card { background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; transition: all 0.2s ease-in-out; }
        .permission-card:hover { border-color: var(--accent-color); }
        .permission-card input[type="checkbox"] { display: none; }
        .permission-card label { display: flex; align-items: center; cursor: pointer; font-weight: 500; }
        .permission-card label::before { content: ''; display: inline-block; width: 20px; height: 20px; margin-right: 12px; border: 2px solid var(--border-color); border-radius: 4px; background-color: var(--bg-content); transition: all 0.2s; }
        .permission-card input[type="checkbox"]:checked + label::before { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: center; }
        .militar-modal-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .militar-modal-list li { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .militar-modal-list li:hover { background-color: var(--sidebar-active-bg); }
        .militar-modal-list li:last-child { border-bottom: none; }
    </style>
{% endblock %}

{% block content %}
<h1>Registar Novo Utilizador</h1>
<p>Preencha os campos abaixo para criar um novo utilizador.</p>

<form method="post" class="model-form" id="register-form">
    {% csrf_token %}
    <div class="form-grid">
        <p>
            <label for="{{ form.username.id_for_label }}">Utilizador:</label>
            {{ form.username }}
            {% if form.username.help_text %}<small>{{ form.username.help_text }}</small>{% endif %}
            {% for error in form.username.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
        </p>

        <p>
            <label for="id_password1">Palavra-passe:</label>
            {{ form.password1 }}
            {% if form.password1.help_text %}<small>{{ form.password1.help_text|safe }}</small>{% endif %}
            {% for error in form.password1.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
        </p>
        
        <p>
            <label for="id_password2">Confirmação de palavra-passe:</label>
            {{ form.password2 }}
            {% if form.password2.help_text %}<small>{{ form.password2.help_text }}</small>{% endif %}
            {% for error in form.password2.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
        </p>

        <div>
            <label for="militar-select-btn">Militar Associado:</label>
            {{ form.militar }}
            <div class="militar-selector">
                <span id="selected-militar-name">Nenhum militar selecionado</span>
                <button type="button" class="btn btn-secondary btn-sm" id="militar-select-btn">Selecionar</button>
            </div>
            {% if form.militar.help_text %}<small>{{ form.militar.help_text }}</small>{% endif %}
            {% for error in form.militar.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
        </div>

        <div>
            <label>{{ form.grupos.label }}:</label>
            <div class="permissions-grid">
                {% for choice in form.grupos %}
                    <div class="permission-card">
                        {{ choice.tag }}
                        <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                    </div>
                {% endfor %}
            </div>
            {% if form.grupos.help_text %}<small>{{ form.grupos.help_text }}</small>{% endif %}
            {% for error in form.grupos.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Registar</button>
        <a href="{% url 'Ouvidoria:index' %}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<div class="modal-overlay" id="militar-modal">
    <div class="modal-content">
        <h3>Selecionar Militar</h3>
        <input type="text" id="militar-search-input" placeholder="Pesquisar por nome ou posto..." style="width: 100%; margin-bottom: 15px;">
        <ul class="militar-modal-list" id="militar-results-list">
            </ul>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-militar-select-btn">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // (JavaScript permanece o mesmo)
    const militarSelectBtn = document.getElementById('militar-select-btn');
    const militarModal = document.getElementById('militar-modal');
    const cancelMilitarSelectBtn = document.getElementById('cancel-militar-select-btn');
    const militarSearchInput = document.getElementById('militar-search-input');
    const militarResultsList = document.getElementById('militar-results-list');
    const hiddenMilitarInput = document.getElementById('id_militar');
    const selectedMilitarName = document.getElementById('selected-militar-name');
    let searchTimeout;

    militarSelectBtn.addEventListener('click', () => {
        militarModal.classList.add('active');
        loadMilitares('');
    });

    function closeModal() {
        militarModal.classList.remove('active');
    }
    cancelMilitarSelectBtn.addEventListener('click', closeModal);
    militarModal.addEventListener('click', (e) => {
        if (e.target === militarModal) closeModal();
    });

    function loadMilitares(query) {
        const url = `{% url 'Ouvidoria:search_militares_json' %}?q=${encodeURIComponent(query)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                militarResultsList.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(militar => {
                        const li = document.createElement('li');
                        li.textContent = `${militar.posto} ${militar.nome_guerra} - ${militar.nome_completo}`;
                        li.dataset.id = militar.id;
                        li.dataset.name = `${militar.posto} ${militar.nome_guerra}`;
                        militarResultsList.appendChild(li);
                    });
                } else {
                    militarResultsList.innerHTML = '<li>Nenhum militar encontrado.</li>';
                }
            });
    }

    militarSearchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadMilitares(militarSearchInput.value);
        }, 300);
    });

    militarResultsList.addEventListener('click', (e) => {
        if (e.target.tagName === 'LI' && e.target.dataset.id) {
            hiddenMilitarInput.value = e.target.dataset.id;
            selectedMilitarName.textContent = e.target.dataset.name;
            selectedMilitarName.classList.add('selected');
            closeModal();
        }
    });
});
</script>
{% endblock %}