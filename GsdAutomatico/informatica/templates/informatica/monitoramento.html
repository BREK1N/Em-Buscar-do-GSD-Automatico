{% extends 'informatica/base.html' %}
{% block title %}Painel de Servidor e Backup{% endblock %}

{% block content %}
<style>
    /* --- VARIÁVEIS DE CORES MODERNAS --- */
    :root {
        --bg-body: #f4f6f9;
        --bg-card: #ffffff;
        --text-main: #212529;
        --text-muted: #6c757d;
        --border-color: #dee2e6;
        --primary: #007bff;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
        --shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    }

    body.dark-theme {
        --bg-body: #343a40;
        --bg-card: #454d55;
        --text-main: #ffffff;
        --text-muted: #adb5bd;
        --border-color: #6c757d;
        --shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    /* Layout Principal */
    .content-wrapper {
        padding: 20px;
        background-color: var(--bg-body);
        min-height: 100vh;
    }

    /* Cards Estilo "Info-Box" */
    .info-box {
        display: flex;
        background: var(--bg-card);
        min-height: 80px;
        box-shadow: var(--shadow);
        border-radius: 0.25rem;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .info-box-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 70px;
        font-size: 1.8rem;
        color: #fff;
    }

    .info-box-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 5px 10px;
        flex: 1;
        color: var(--text-main);
    }

    .info-box-text {
        text-transform: uppercase;
        font-weight: bold;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .info-box-number {
        font-weight: bold;
        font-size: 1.2rem;
    }

    /* Cores de Fundo Sólidas para Ícones */
    .bg-info { background-color: var(--info) !important; }
    .bg-success { background-color: var(--success) !important; }
    .bg-warning { background-color: var(--warning) !important; color: #1f2d3d !important; }
    .bg-danger { background-color: var(--danger) !important; }
    .bg-primary { background-color: var(--primary) !important; }

    /* Card Principal */
    .card-pro {
        background: var(--bg-card);
        box-shadow: var(--shadow);
        border-radius: 0.25rem;
        margin-bottom: 1.5rem;
        border-top: 3px solid var(--primary);
        color: var(--text-main);
    }

    .card-header-pro {
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    /* Tabelas Limpas */
    .table-pro {
        width: 100%;
        margin-bottom: 0;
        color: var(--text-main);
    }
    .table-pro th, .table-pro td {
        padding: 0.75rem;
        vertical-align: middle;
        border-top: 1px solid var(--border-color);
    }
    .table-pro thead th {
        vertical-align: bottom;
        border-bottom: 2px solid var(--border-color);
        background-color: rgba(0,0,0,0.03);
    }

    /* Barras de Progresso Finas */
    .progress-group {
        margin-bottom: 0.5rem;
    }
    .progress-sm {
        height: 6px;
        background-color: #e9ecef;
        border-radius: 3px;
        margin-top: 4px;
    }
    body.dark-theme .progress-sm {
        background-color: #2c3136;
    }

    /* Badges */
    .badge-pro {
        padding: 0.4em 0.6em;
        font-size: 85%;
        font-weight: 700;
        border-radius: 0.25rem;
        color: #fff;
    }

    /* Timer no topo */
    .refresh-timer {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-align: right;
        margin-bottom: 10px;
    }

</style>

<div class="content-wrapper">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 style="color: var(--text-main); font-weight: 700;">
            <i class="fas fa-server"></i> Monitoramento GSD
        </h4>
        <div class="refresh-timer">
            <i class="fas fa-sync-alt fa-spin" id="spinner" style="display:none;"></i>
            Atualizando em <span id="timer" style="font-weight:bold;">10</span>s
        </div>
    </div>

    {% if online %}
        <div class="row">
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1"><i class="fas fa-microchip"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Uso de CPU</span>
                        <span class="info-box-number">
                            {{ dados.cpu_usage }}%
                            <small style="font-weight:normal; font-size:0.8rem;">({{ dados.cpu_temp }}°C)</small>
                        </span>
                        <div class="progress progress-sm">
                            <div class="progress-bar bg-info" style="width: {{ dados.cpu_usage }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-memory"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Memória RAM</span>
                        <span class="info-box-number">{{ dados.ram_percent }}%</span>
                        <div class="progress progress-sm">
                            <div class="progress-bar bg-danger" style="width: {{ dados.ram_percent }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-success elevation-1"><i class="fas fa-archive"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Backups</span>
                        <span class="info-box-number">{{ dados.total_backups }}</span>
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                    {% if dados.alerta %}
                        <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-exclamation-triangle"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Alerta Sistema</span>
                            <span class="info-box-number text-danger" style="font-size:0.9rem; line-height: 1.2;">{{ dados.mensagem_alerta }}</span>
                        </div>
                    {% else %}
                        <span class="info-box-icon bg-primary elevation-1"><i class="fas fa-check-circle"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Status Sistema</span>
                            <span class="info-box-number">ONLINE</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            
            <div class="col-md-6">
                <div class="card-pro" style="border-top-color: #6f42c1;">
                    <div class="card-header-pro">
                        <h3 class="card-title"><i class="fas fa-hdd mr-1"></i> Armazenamento e Discos</h3>
                        <div class="card-tools">
                            <span class="badge-pro bg-secondary">{{ dados.discos|length }} Discos</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-pro table-striped">
                            <thead>
                                <tr>
                                    <th>Dispositivo</th>
                                    <th>Ponto Montagem</th>
                                    <th>Uso</th>
                                    <th style="width: 40px">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for disco in dados.discos %}
                                <tr>
                                    <td>
                                        <span style="font-weight:bold;">{{ disco.device }}</span><br>
                                        <small class="text-muted">{{ disco.fstype }}</small>
                                    </td>
                                    <td>
                                        {% if disco.mountpoint %}
                                            <code style="color: var(--primary);">{{ disco.mountpoint }}</code>
                                        {% else %}
                                            <span class="text-muted font-italic">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if disco.mountpoint %}
                                            <div class="progress-group">
                                                <span class="progress-text small">{{ disco.used_gb }}GB / {{ disco.total_gb }}GB</span>
                                                <span class="float-right small" style="font-weight:bold;">{{ disco.percent }}%</span>
                                                <div class="progress progress-sm">
                                                    <div class="progress-bar {% if disco.percent > 90 %}bg-danger{% else %}bg-primary{% endif %}" style="width: {{ disco.percent }}%"></div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <button class="btn btn-xs btn-outline-primary" onclick="alert('Montagem manual necessária')">
                                                <i class="fas fa-plus-circle"></i> Montar
                                            </button>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if disco.mountpoint %}
                                            <span class="badge-pro bg-success">OK</span>
                                        {% else %}
                                            <span class="badge-pro bg-secondary">OFF</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card-pro" style="border-top-color: #28a745;">
                    <div class="card-header-pro">
                        <h3 class="card-title"><i class="far fa-file-alt mr-1"></i> Últimos Backups Recebidos</h3>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-pro table-hover">
                            <thead>
                                <tr>
                                    <th>Nome do Arquivo</th>
                                    <th>Tamanho</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for arquivo in dados.lista_arquivos %}
                                <tr>
                                    <td>
                                        <i class="far fa-file-archive text-warning mr-2"></i> {{ arquivo.nome }}
                                    </td>
                                    <td>{{ arquivo.tamanho }}</td>
                                    <td><small class="badge-pro bg-secondary">{{ arquivo.data }}</small></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">Nenhum arquivo recente.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    {% else %}
        <div class="row justify-content-center mt-5">
            <div class="col-md-6">
                <div class="card-pro text-center p-5" style="border-top-color: #dc3545;">
                    <i class="fas fa-plug fa-4x text-muted mb-3"></i>
                    <h3 class="text-danger">Conexão Perdida</h3>
                    <p class="lead" style="color: var(--text-muted);">Não foi possível contactar o servidor 10.52.18.29</p>
                    <hr>
                    <p class="small text-left text-muted code-bg p-2 rounded" style="background:rgba(0,0,0,0.05);">
                        Erro Técnico: {{ erro }}
                    </p>
                    <p>Tentando reconectar automaticamente...</p>
                </div>
            </div>
        </div>
    {% endif %}

</div>

<script>
    // Lógica de Atualização Automática Suave
    let timeLeft = 10;
    const timerElem = document.getElementById('timer');
    const spinner = document.getElementById('spinner');

    setInterval(() => {
        timeLeft--;
        if (timerElem) timerElem.innerText = timeLeft;

        if (timeLeft <= 0) {
            timeLeft = 10;
            if (spinner) spinner.style.display = 'inline-block';
            
            // Recarrega a página para buscar dados novos
            // (Para uma solução 100% sem refresh visual, seria necessário usar AJAX/Fetch, 
            // mas o reload é mais seguro para garantir que o Django renderize tudo certo).
            window.location.reload();
        }
    }, 1000);
</script>

{% endblock %}