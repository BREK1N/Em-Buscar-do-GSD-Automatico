{% extends 'informatica/base.html' %}
{% load static %} {# Adiciona load static #}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %} {# Adiciona estilos para abas e assinaturas #}
<style>
    /* Estilos básicos (mantidos) */
    .form-card { background-color: var(--bg-content); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: var(--box-shadow); }
    .form-card-header { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
    .form-card-header svg { width: 24px; height: 24px; color: var(--accent-color); }
    .form-card-header h2 { margin: 0; font-size: 1.2rem; }
    .form-card-body .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .form-card-body .form-item { display: flex; flex-direction: column; }
    .form-card-body .form-item label { margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
    .form-card-body .form-item input, .form-card-body .form-item select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-primary); box-sizing: border-box; }
    .alert-error { color: var(--danger-color); font-size: 0.8rem; margin-top: 5px; }
    .form-help-text { font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;}

    /* Estilos para abas (copiado de base.html) */
    .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .tabs-nav a { padding: 10px 20px; text-decoration: none; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; /* Alinha com a borda inferior */ cursor: pointer; }
    .tabs-nav a.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Estilos para lista de oficiais (copiado de base.html) */
    .oficiais-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; } /* Adicionado max-height e overflow */
    .oficiais-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
    .oficiais-list li:last-child { border-bottom: none; }
    .oficial-info { display: flex; align-items: center; gap: 15px; }
    .oficial-info .signature-preview { width: 100px; height: 40px; background-color: #fff; border: 1px solid var(--border-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .oficial-info .signature-preview img { max-width: 100%; max-height: 100%; }
    .oficial-info .no-signature { font-style: italic; font-size: 12px; color: var(--text-secondary); }

    /* Estilos para modal de assinatura (copiado de base.html) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .signature-modal-content { background-color: var(--bg-content); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: var(--box-shadow); transform: scale(0.9); transition: transform 0.3s; box-sizing: border-box; }
    .modal-overlay.active .signature-modal-content { transform: scale(1); }
    .signature-modal-content h3 { margin-top: 0; color: var(--text-primary); }
    .signature-modal-content p { color: var(--text-secondary); }
    .canvas-container { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; background-color: #fff; }
    #signature-canvas-pessoal { width: 100%; height: 200px; cursor: crosshair; }

</style>
{% endblock %}

{% block content %}
<h1>{{ page_title }}</h1>
<p>Ajuste as configurações gerais do sistema da Ouvidoria e gerencie as assinaturas dos oficiais.</p>

{# --- Adicionado: Navegação por Abas --- #}
<nav class="tabs-nav">
    <a href="#" class="tab-link active" data-target="tab-config-gerais">Configurações Gerais</a>
    <a href="#" class="tab-link" data-target="tab-assinaturas">Gerir Assinaturas</a>
</nav>

<div id="tab-config-gerais" class="tab-panel active">
    <form method="post" class="model-form">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="form-card">
             <div class="form-card-header">
                {# Ícone de Configurações #}
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 50 50">
                    <path d="M 22.199219 2 A 1.0001 1.0001 0 0 0 21.214844 2.8339844 L 20.205078 8.796875 C 19.01608 9.1476749 17.903339 9.6072866 16.835938 10.173828 L 11.875 6.6816406 A 1.0001 1.0001 0 0 0 10.59375 6.7929688 L 6.6933594 10.693359 A 1.0001 1.0001 0 0 0 6.5820312 11.974609 L 10.076172 16.939453 C 9.5032306 17.983292 9.0447681 19.109183 8.6992188 20.298828 L 2.8457031 21.212891 A 1.0001 1.0001 0 0 0 2 22.199219 L 2 27.699219 A 1.0001 1.0001 0 0 0 2.8339844 28.685547 L 8.7949219 29.693359 C 9.1451119 30.880887 9.6045402 31.990547 10.169922 33.056641 L 6.6875 37.917969 A 1.0001 1.0001 0 0 0 6.7929688 39.207031 L 10.693359 43.107422 A 1.0001 1.0001 0 0 0 11.974609 43.21875 L 16.939453 39.724609 C 17.985462 40.298683 19.114316 40.757752 20.306641 41.103516 L 21.314453 47.066406 A 1.0001 1.0001 0 0 0 22.300781 47.900391 L 27.800781 47.900391 A 1.0001 1.0001 0 0 0 28.783203 47.082031 L 29.884766 41.107422 C 31.077734 40.756262 32.193186 40.294742 33.263672 39.726562 L 38.224609 43.21875 A 1.0001 1.0001 0 0 0 39.507812 43.107422 L 43.40625 39.207031 A 1.0001 1.0001 0 0 0 43.509766 37.914062 L 39.931641 32.957031 C 40.500209 31.91951 40.957756 30.82106 41.300781 29.693359 L 47.169922 28.685547 A 1.0001 1.0001 0 0 0 48 27.699219 L 48 22.199219 A 1.0001 1.0001 0 0 0 47.166016 21.214844 L 41.199219 20.203125 C 40.855563 19.074235 40.397841 17.973827 39.828125 16.935547 L 43.318359 11.974609 A 1.0001 1.0001 0 0 0 43.207031 10.693359 L 39.306641 6.7929688 A 1.0001 1.0001 0 0 0 38.013672 6.6894531 L 33.052734 10.273438 C 32.009656 9.7017023 30.885686 9.2413677 29.697266 8.8964844 L 28.685547 2.8359375 A 1.0001 1.0001 0 0 0 27.699219 2 L 22.199219 2 z M 23.044922 4 L 26.853516 4 L 27.814453 9.7636719 A 1.0001 1.0001 0 0 0 28.556641 10.570312 C 30.07104 10.948913 31.478126 11.514935 32.675781 12.251953 A 1.0001 1.0001 0 0 0 33.785156 12.210938 L 38.494141 8.8085938 L 41.197266 11.511719 L 37.882812 16.224609 A 1.0001 1.0001 0 0 0 37.847656 17.324219 C 38.584675 18.521874 39.154586 19.937607 39.533203 21.357422 A 1.0001 1.0001 0 0 0 40.333984 22.085938 L 46 23.044922 L 46 26.857422 L 40.429688 27.814453 A 1.0001 1.0001 0 0 0 39.632812 28.542969 C 39.254196 29.962783 38.686237 31.378517 37.949219 32.576172 A 1.0001 1.0001 0 0 0 37.990234 33.685547 L 41.390625 38.394531 L 38.6875 41.097656 L 33.974609 37.78125 A 1.0001 1.0001 0 0 0 32.904297 37.732422 C 31.566632 38.496802 30.2627 39.053466 28.757812 39.429688 A 1.0001 1.0001 0 0 0 28.017578 40.21875 L 26.966797 45.900391 L 23.144531 45.900391 L 22.185547 40.232422 A 1.0001 1.0001 0 0 0 21.443359 39.429688 C 19.92896 39.051088 18.521874 38.485065 17.324219 37.748047 A 1.0001 1.0001 0 0 0 16.224609 37.78125 L 11.511719 41.097656 L 8.8066406 38.392578 L 12.113281 33.783203 A 1.0001 1.0001 0 0 0 12.167969 32.703125 C 11.403582 31.365465 10.846925 30.061529 10.470703 28.556641 A 1.0001 1.0001 0 0 0 9.6660156 27.814453 L 4 26.855469 L 4 23.056641 L 9.5546875 22.1875 A 1.0001 1.0001 0 0 0 10.371094 21.443359 C 10.749694 19.92896 11.313763 18.521874 12.050781 17.324219 A 1.0001 1.0001 0 0 0 12.017578 16.224609 L 8.7011719 11.511719 L 11.412109 8.8027344 L 16.125 12.117188 A 1.0001 1.0001 0 0 0 17.195312 12.167969 C 18.532978 11.403589 19.836909 10.846925 21.341797 10.470703 A 1.0001 1.0001 0 0 0 22.085938 9.6660156 L 23.044922 4 z M 25 17 C 20.570085 17 17 20.570085 17 25 C 17 29.429915 20.570085 33 25 33 C 29.429915 33 33 29.429915 33 25 C 33 20.570085 29.429915 17 25 17 z M 25 19 C 28.370085 19 31 21.629915 31 25 C 31 28.370085 28.370085 31 25 31 C 21.629915 31 19 28.370085 19 25 C 19 21.629915 21.629915 19 25 19 z"></path>
                </svg>
                <h2>Configurações Gerais</h2>
            </div>
            <div class="form-card-body">
                <div class="form-grid">
                    {% for field in form %}
                        <div class="form-item">
                            <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                            {{ field }}
                            {% if field.help_text %}<div class="form-help-text">{{ field.help_text|safe }}</div>{% endif %}
                            {% for error in field.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar Configurações</button>
            <a href="{% url 'informatica:dashboard' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

{# --- Adicionado: Painel de Assinaturas --- #}
<div id="tab-assinaturas" class="tab-panel">
    <div class="form-card">
         <div class="form-card-header">
             {# Ícone Assinatura #}
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"> <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /> </svg>
            <h2>Gerir Assinaturas Padrão</h2>
        </div>
         <div class="form-card-body">
             <div class="form-item" style="margin-bottom: 20px;">
                 <label for="search-oficial">Pesquisar Oficial:</label>
                 <input type="text" id="search-oficial" placeholder="Pesquisar por nome ou posto...">
             </div>
             <ul class="oficiais-list" id="oficiais-list-container">
                 <li>A carregar...</li>
             </ul>
         </div>
    </div>
</div>

{# --- Adicionado: Modal Assinatura Pessoal --- #}
<div class="modal-overlay" id="signature-modal-pessoal">
    <div class="signature-modal-content">
        <h3 id="signature-modal-title">Definir Assinatura Padrão</h3>
        <p>Desenhe a assinatura no campo abaixo.</p>
        <div class="canvas-container">
            <canvas id="signature-canvas-pessoal"></canvas>
        </div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="clear-signature-btn-pessoal">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn-pessoal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn-pessoal">Salvar Assinatura</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# --- Adicionado: Script do SignaturePad --- #}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isSuperuser = {{ request.user.is_superuser|yesno:"true,false" }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : null;

    // --- Lógica das Abas ---
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabPanels = document.querySelectorAll('.tab-panel');

    function handleTabClick(tab) {
        tabLinks.forEach(l => l.classList.remove('active'));
        tabPanels.forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        const targetPanelId = tab.getAttribute('data-target');
        const targetPanel = document.getElementById(targetPanelId);
        if (targetPanel) targetPanel.classList.add('active');

        // Carrega dados específicos da aba, se necessário
        if (targetPanelId === 'tab-assinaturas') {
            loadOficiais(); // Carrega a lista de oficiais ao ativar a aba
        }
    }

    tabLinks.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            handleTabClick(tab);
        });
    });

    // --- LÓGICA PARA ABA DE ASSINATURAS (Adaptada) ---
    const oficiaisListContainer = document.getElementById('oficiais-list-container');
    const signatureModalPessoal = document.getElementById('signature-modal-pessoal');
    const searchOficialInput = document.getElementById('search-oficial');
    let searchTimeoutOficiais;

    if (oficiaisListContainer && signatureModalPessoal && searchOficialInput) {
        const signatureCanvasPessoal = document.getElementById('signature-canvas-pessoal');
        const signaturePadPessoal = new SignaturePad(signatureCanvasPessoal, { backgroundColor: 'rgb(255, 255, 255)' });
        let currentOficialId = null;

        function resizeCanvasPessoal() {
            // ... (código resizeCanvasPessoal) ...
            if (!signatureCanvasPessoal || !signatureCanvasPessoal.parentElement) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const parentWidth = signatureCanvasPessoal.parentElement.offsetWidth;
            if (parentWidth <= 0) { setTimeout(resizeCanvasPessoal, 50); return; }
            signatureCanvasPessoal.width = parentWidth * ratio;
            signatureCanvasPessoal.height = signatureCanvasPessoal.offsetHeight * ratio;
            signatureCanvasPessoal.getContext("2d").scale(ratio, ratio);
            signaturePadPessoal.clear();
        }

        function loadOficiais(query = '') {
            // ... (código loadOficiais, usando URL da Ouvidoria) ...
             if (!oficiaisListContainer) return;
            oficiaisListContainer.innerHTML = '<p>A carregar oficiais...</p>';
            const url = `{% url 'Ouvidoria:lista_oficiais' %}?q=${encodeURIComponent(query)}`;

            fetch(url)
                .then(response => {
                     if (!response.ok) throw new Error('Network response was not ok');
                     return response.json();
                })
                .then(data => {
                    oficiaisListContainer.innerHTML = '';
                    if (!Array.isArray(data) || data.length === 0) {
                        oficiaisListContainer.innerHTML = '<p>Nenhum oficial encontrado.</p>';
                        return;
                    }
                    data.forEach(oficial => {
                        const listItem = document.createElement('li');
                        const signaturePreview = oficial.assinatura
                            ? `<img class="signature-image-embedded" src="${oficial.assinatura}" alt="Assinatura">`
                            : '<span class="no-signature">Sem assinatura</span>';

                        const manageButton = isSuperuser ? `
                            <button class="btn btn-sm btn-secondary manage-signature-btn" data-oficial-id="${oficial.id}" data-oficial-nome="${oficial.posto} ${oficial.nome_guerra}">
                                ${oficial.assinatura ? 'Alterar' : 'Adicionar'} Assinatura
                            </button>
                        ` : '';

                        listItem.innerHTML = `
                            <div class="oficial-info">
                                <div class="signature-preview">${signaturePreview}</div>
                                <span>${oficial.posto || ''} ${oficial.nome_guerra || ''}</span>
                            </div>
                            ${manageButton}
                        `;
                        oficiaisListContainer.appendChild(listItem);
                    });
                })
                .catch(error => {
                    oficiaisListContainer.innerHTML = '<p>Erro ao carregar a lista de oficiais.</p>';
                    console.error('Error fetching oficiais:', error);
                });
        }

        searchOficialInput.addEventListener('input', () => {
            clearTimeout(searchTimeoutOficiais);
            searchTimeoutOficiais = setTimeout(() => {
                loadOficiais(searchOficialInput.value);
            }, 300);
        });

        oficiaisListContainer.addEventListener('click', function(e) {
            // ... (código listener para abrir modal de assinatura) ...
            if (!isSuperuser) return;
            const targetButton = e.target.closest('.manage-signature-btn');
            if (targetButton) {
                currentOficialId = targetButton.dataset.oficialId;
                const oficialNome = targetButton.dataset.oficialNome;
                const modalTitle = signatureModalPessoal.querySelector('#signature-modal-title');
                if(modalTitle) modalTitle.textContent = `Assinatura de ${oficialNome || 'Oficial'}`;
                signatureModalPessoal.classList.add('active');
                resizeCanvasPessoal();
            }
        });

        const cancelSigBtn = document.getElementById('cancel-signature-btn-pessoal');
        const clearSigBtn = document.getElementById('clear-signature-btn-pessoal');
        const saveSigBtn = document.getElementById('save-signature-btn-pessoal');

        if (cancelSigBtn) cancelSigBtn.addEventListener('click', () => {
            // ... (código para cancelar assinatura) ...
             signatureModalPessoal.classList.remove('active');
            signaturePadPessoal.clear();
            currentOficialId = null;
        });
        if (clearSigBtn) clearSigBtn.addEventListener('click', () => {
             signaturePadPessoal.clear();
        });
        if (saveSigBtn) saveSigBtn.addEventListener('click', () => {
            // ... (código para salvar assinatura, usando URL da Ouvidoria) ...
             if (!currentOficialId || !csrfToken) return;
            const signatureData = signaturePadPessoal.isEmpty() ? "" : signaturePadPessoal.toDataURL('image/png');
            const url = `/Ouvidoria/militar/${currentOficialId}/salvar_assinatura_padrao/`; // URL da Ouvidoria

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'signature_data': signatureData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    signatureModalPessoal.classList.remove('active');
                    loadOficiais(searchOficialInput.value); // Recarrega
                } else {
                    alert('Erro ao salvar: ' + (data.message || 'Erro desconhecido.'));
                }
            })
            .catch(error => {
                console.error('Error saving signature:', error);
                alert('Erro de comunicação.');
            });
        });

         // Fecha modal clicando fora
        signatureModalPessoal.addEventListener('click', (e) => {
            if (e.target === signatureModalPessoal) {
                 signatureModalPessoal.classList.remove('active');
                 signaturePadPessoal.clear();
                 currentOficialId = null;
            }
        });

         // Redimensiona canvas se a janela mudar
        window.addEventListener('resize', () => {
             if (signatureModalPessoal.classList.contains('active')) {
                 resizeCanvasPessoal();
             }
        });

    } else {
        console.warn("Elementos para a gestão de assinaturas não encontrados na página de configuração.");
    }

    // --- Ativa a primeira aba ao carregar ---
    if (tabLinks.length > 0) {
        handleTabClick(tabLinks[0]);
    }

});
</script>
{% endblock %}
