{% extends 'informatica/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
{# Adiciona os estilos específicos #}
<style>
    /* Estilos básicos (mantidos) */
    .form-card { background-color: var(--bg-content); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: var(--box-shadow); }
    .form-card-header { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
    .form-card-header svg { width: 24px; height: 24px; color: var(--accent-color); }
    .form-card-header h2 { margin: 0; font-size: 1.2rem; }
    .form-card-body .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .form-card-body .form-item { display: flex; flex-direction: column; }
    .form-card-body .form-item label { margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
    .form-card-body .form-item input, .form-card-body .form-item select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-primary); box-sizing: border-box; }
    .form-item-checkbox { display: flex; flex-direction: row; align-items: center; gap: 10px; }
    .form-item-checkbox input { width: auto; }
    .alert-error { color: var(--danger-color); font-size: 0.8rem; margin-top: 5px; }
    .form-help-text { font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;}

    /* Estilos para seleção de grupos (adaptado de register.html) */
    .permissions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
    .permission-card { background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; transition: all 0.2s ease-in-out; }
    .permission-card:hover { border-color: var(--accent-color); }
    .permission-card input[type="checkbox"] { display: none; }
    .permission-card label { display: flex; align-items: center; cursor: pointer; font-weight: 500; margin: 0; }
    .permission-card label::before { content: ''; display: inline-block; width: 20px; height: 20px; margin-right: 12px; border: 2px solid var(--border-color); border-radius: 4px; background-color: var(--bg-content); transition: all 0.2s; }
    .permission-card input[type="checkbox"]:checked + label::before { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: center; }

    /* Estilo para o botão de redefinir senha */
    .password-reset-button { background: none; border: none; padding: 0; font: inherit; color: var(--accent-color); cursor: pointer; text-decoration: none; font-size: 0.9rem; }
    .password-reset-button:hover { text-decoration: underline; }

     /* Estilo para o modal (copiado do base.html) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-content { background-color: var(--bg-content); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: var(--box-shadow); transform: scale(0.9); transition: transform 0.3s; box-sizing: border-box; }
    .modal-overlay.active .modal-content { transform: scale(1); }
    .modal-content h3 { margin-top: 0; color: var(--text-primary); }
    .modal-content p { color: var(--text-secondary); margin-bottom: 25px; }
    #reset-username-placeholder { font-weight: bold; color: var(--text-primary); }
    #reset-feedback { margin-top: 15px; font-size: 0.9rem; }
    #reset-feedback.success { color: var(--success-color); }
    #reset-feedback.error { color: var(--danger-color); }

    /* --- Novo: Estilos para seleção de militar --- */
    .militar-selector { display: flex; align-items: center; gap: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-main); margin-top: 5px; /* Adiciona espaço acima */ }
    #selected-militar-name { flex-grow: 1; color: var(--text-secondary); font-style: italic; }
    #selected-militar-name.selected { color: var(--text-primary); font-style: normal; }
    .militar-modal-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
    .militar-modal-list li { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
    .militar-modal-list li:hover { background-color: var(--sidebar-active-bg); }
    .militar-modal-list li:last-child { border-bottom: none; }
    /* --- Fim: Estilos para seleção de militar --- */

</style>
{% endblock %}

{% block content %}
<h1>{{ page_title }}</h1>

<form method="post" class="model-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-card">
         <div class="form-card-header">
            {# Ícone de Utilizador #}
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <h2>Dados do Utilizador</h2>
        </div>
         <div class="form-card-body">
            <div class="form-grid">
                {# Renderiza campos básicos do utilizador (username, first_name, last_name, email, is_active, etc.) #}
                {% for field in form %}
                    {# Exclui groups, permissões e militar daqui #}
                    {% if field.name != 'groups' and field.name != 'user_permissions' and field.name != 'militar' %}
                        <div class="form-item">
                            <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                            {% if field.field.widget.input_type == 'checkbox' %}
                                <div class="form-item-checkbox">
                                    {{ field }}
                                </div>
                            {% else %}
                                {{ field }}
                            {% endif %}
                            {% if field.help_text %}<div class="form-help-text">{{ field.help_text|safe }}</div>{% endif %}
                            {% for error in field.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}

                {# Se for EDIÇÃO, mostra o botão de reset de senha #}
                {% if object %}
                <div class="form-item">
                    <label>Palavra-passe:</label>
                    <button type="button" class="password-reset-button" id="reset-password-btn">Redefinir palavra-passe para '12345678'</button>
                    <div class="form-help-text">Clique no botão para redefinir a palavra-passe deste utilizador para o padrão.</div>
                </div>
                {% else %}
                 {# Se for CRIAÇÃO, mostra um texto informativo #}
                 <div class="form-item">
                    <label>Palavra-passe:</label>
                    <p class="form-help-text">A palavra-passe inicial será definida como '12345678'. O utilizador deverá alterá-la no primeiro login.</p>
                 </div>
                {% endif %}

                 {# Campo de seleção de Militar (mostra APENAS na criação) #}
                {% if not object %}
                    {% if form.militar %} {# Verifica se o campo existe no formulário #}
                        <div class="form-item full-width"> {# Ocupa toda a largura #}
                            <label for="militar-select-btn">{{ form.militar.label }}:</label>
                            {{ form.militar }} {# Input hidden #}
                            <div class="militar-selector">
                                <span id="selected-militar-name">Nenhum militar selecionado</span>
                                <button type="button" class="btn btn-secondary btn-sm" id="militar-select-btn">Selecionar</button>
                            </div>
                            {% if form.militar.help_text %}<div class="form-help-text">{{ form.militar.help_text }}</div>{% endif %}
                            {% for error in form.militar.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                        </div>
                    {% endif %}
                {% endif %}

            </div> {# Fim form-grid #}
        </div> {# Fim form-card-body #}
    </div> {# Fim form-card #}

    {# Card separado para Grupos (garantir renderização) #}
    <div class="form-card">
        <div class="form-card-header">
            {# Ícone de Grupos #}
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"> <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 001.13-1.897M16.5 7.5V18L18 15.75l-1.5-3.75V7.5z" /> </svg>
            <h2>Grupos de Permissão</h2>
        </div>
        <div class="form-card-body">
            <div class="form-item full-width">
                {% if form.groups %} {# Verifica se o campo groups existe no formulário #}
                    <label>{{ form.groups.label }}:</label>
                    <div class="permissions-grid">
                        {% for choice in form.groups %}
                            <div class="permission-card">
                                {{ choice.tag }}
                                <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                            </div>
                        {% empty %}
                            <p>Nenhum grupo disponível.</p> {# Mensagem se não houver grupos #}
                        {% endfor %}
                    </div>
                    {% if form.groups.help_text %}<div class="form-help-text">{{ form.groups.help_text|safe }}</div>{% endif %}
                    {% for error in form.groups.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                {% else %}
                    <p>Campo de grupos não disponível neste formulário.</p> {# Mensagem de fallback #}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Salvar</button>
        {# Volta para a lista de utilizadores #}
        <a href="{% url 'informatica:user_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

{# Modal de Confirmação para Reset de Senha (mantido) #}
{% if object %} {# Mostra o modal apenas na edição #}
<div class="modal-overlay" id="reset-password-modal">
    <div class="modal-content">
        <h3>Confirmar Redefinição de Senha</h3>
        <p>Tem a certeza que deseja redefinir a palavra-passe do utilizador <span id="reset-username-placeholder"></span> para <strong>12345678</strong>?</p>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-reset-btn">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirm-reset-btn">Sim, Redefinir</button>
        </div>
        <div id="reset-feedback"></div>
    </div>
</div>
{% endif %}

{# Modal para Selecionar Militar (mantido para CRIAÇÃO) #}
{% if not object %} {# Mostra o modal apenas na criação #}
<div class="modal-overlay" id="militar-modal">
    <div class="modal-content">
        <h3>Selecionar Militar</h3>
        <input type="text" id="militar-search-input" placeholder="Pesquisar por nome ou posto..." style="width: 100%; margin-bottom: 15px; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-primary);">
        <ul class="militar-modal-list" id="militar-results-list">
             <li>A carregar...</li> {# Mensagem inicial #}
        </ul>
        <div class="form-actions" style="justify-content: flex-end; margin-top: 15px;">
            <button type="button" class="btn btn-secondary" id="cancel-militar-select-btn">Cancelar</button>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM Carregado."); // Log inicial
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value; // Usa optional chaining
    // --- Correção: Garantir que object existe antes de aceder a pk ---
    const isEditMode = "{{ object.pk|default:'' }}" !== "";
    console.log("Modo Edição:", isEditMode);

    // --- Lógica do Modal de Reset de Senha (apenas para Edição) ---
    if (isEditMode) {
        console.log("Tentando configurar modal de reset de senha...");
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const usernamePlaceholder = document.getElementById('reset-username-placeholder');
        const resetFeedback = document.getElementById('reset-feedback');
        const userId = "{{ object.pk }}";
        const username = "{{ object.username }}";

        // Verifica TODOS os elementos antes de adicionar listeners
        if (resetPasswordBtn && resetPasswordModal && cancelResetBtn && confirmResetBtn && usernamePlaceholder && resetFeedback) {
            console.log("Elementos do modal de reset encontrados. Adicionando listeners...");
            resetPasswordBtn.addEventListener('click', () => {
                console.log("Botão Reset Clicado.");
                usernamePlaceholder.textContent = username;
                resetFeedback.textContent = '';
                resetFeedback.className = '';
                confirmResetBtn.disabled = false;
                confirmResetBtn.textContent = 'Sim, Redefinir';
                resetPasswordModal.classList.add('active');
            });

            cancelResetBtn.addEventListener('click', () => {
                resetPasswordModal.classList.remove('active');
            });

            resetPasswordModal.addEventListener('click', (e) => {
                if (e.target === resetPasswordModal) {
                    resetPasswordModal.classList.remove('active');
                }
            });

            confirmResetBtn.addEventListener('click', () => {
                // ... (lógica fetch - mantida igual) ...
                confirmResetBtn.disabled = true;
                confirmResetBtn.textContent = 'Aguarde...';
                resetFeedback.textContent = '';
                resetFeedback.className = '';

                const url = `/informatica/users/${userId}/reset-password/`;
                console.log("Enviando POST para:", url);

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                })
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(({ status, body }) => {
                    console.log("Resposta do reset:", status, body);
                    if (status === 200 && body.status === 'success') {
                        resetFeedback.textContent = body.message || 'Senha redefinida com sucesso!';
                        resetFeedback.className = 'success';
                        setTimeout(() => { resetPasswordModal.classList.remove('active'); }, 2500);
                    } else {
                        resetFeedback.textContent = body.message || 'Ocorreu um erro ao redefinir a senha.';
                        resetFeedback.className = 'error';
                        confirmResetBtn.disabled = false;
                        confirmResetBtn.textContent = 'Sim, Redefinir';
                    }
                })
                .catch(error => {
                    console.error('Erro no fetch:', error);
                    resetFeedback.textContent = 'Erro de comunicação com o servidor.';
                    resetFeedback.className = 'error';
                    confirmResetBtn.disabled = false;
                    confirmResetBtn.textContent = 'Sim, Redefinir';
                });
            });
        } else {
             console.error("Erro: Falha ao encontrar um ou mais elementos do modal de reset de senha.");
             // Log específico de quais elementos faltam
             if (!resetPasswordBtn) console.error("- Botão #reset-password-btn");
             if (!resetPasswordModal) console.error("- Modal #reset-password-modal");
             if (!cancelResetBtn) console.error("- Botão #cancel-reset-btn");
             if (!confirmResetBtn) console.error("- Botão #confirm-reset-btn");
             if (!usernamePlaceholder) console.error("- Span #reset-username-placeholder");
             if (!resetFeedback) console.error("- Div #reset-feedback");
        }
    }

    // --- Lógica do Modal de Seleção de Militar (apenas para Criação) ---
    if (!isEditMode) {
        console.log("Modo Criação: Configurando modal de seleção de militar.");
        const militarSelectBtn = document.getElementById('militar-select-btn');
        const militarModal = document.getElementById('militar-modal');
        const cancelMilitarSelectBtn = document.getElementById('cancel-militar-select-btn');
        const militarSearchInput = document.getElementById('militar-search-input');
        const militarResultsList = document.getElementById('militar-results-list');
        const hiddenMilitarInput = document.getElementById('id_militar'); // Campo hidden do form
        const selectedMilitarName = document.getElementById('selected-militar-name');
        let searchTimeout;

        // Verifica se TODOS os elementos necessários existem
        if (militarSelectBtn && militarModal && cancelMilitarSelectBtn && militarSearchInput && militarResultsList && hiddenMilitarInput && selectedMilitarName) {
            console.log("Elementos do modal de seleção de militar encontrados. Adicionando listeners...");

            // Adiciona listener ao botão
            militarSelectBtn.addEventListener('click', () => {
                // --- TESTE ALERT ---
                //alert("Botão 'Selecionar' Militar clicado!"); // REMOVA OU COMENTE ESTE ALERT APÓS TESTAR
                // --- FIM TESTE ---
                console.log("Botão 'Selecionar' Militar clicado."); // Log do clique
                militarModal.classList.add('active'); // Mostra o modal
                loadMilitares(''); // Carrega a lista inicial de militares
            });

            // Função para fechar o modal
            function closeModal() {
                militarModal.classList.remove('active');
            }
            // Listener para o botão Cancelar
            cancelMilitarSelectBtn.addEventListener('click', closeModal);
            // Listener para fechar clicando fora do conteúdo
            militarModal.addEventListener('click', (e) => {
                if (e.target === militarModal) closeModal();
            });

            // Função para carregar a lista de militares via fetch
            function loadMilitares(query) {
                console.log("A carregar militares com a query:", query);
                const url = `{% url 'Ouvidoria:search_militares_json' %}?q=${encodeURIComponent(query)}`;
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro HTTP! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Militares recebidos:", data);
                        militarResultsList.innerHTML = ''; // Limpa a lista
                        if (data && Array.isArray(data) && data.length > 0) {
                            data.forEach(militar => {
                                const li = document.createElement('li');
                                li.textContent = `${militar.posto || ''} ${militar.nome_guerra || ''} - ${militar.nome_completo || ''}`.trim();
                                li.dataset.id = militar.id;
                                li.dataset.name = `${militar.posto || ''} ${militar.nome_guerra || ''}`.trim();
                                militarResultsList.appendChild(li);
                            });
                        } else {
                            militarResultsList.innerHTML = '<li>Nenhum militar encontrado.</li>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar militares:", error);
                        militarResultsList.innerHTML = '<li>Erro ao carregar militares. Verifique o console.</li>';
                    });
            }

            // Listener para o input de pesquisa (com debounce)
            militarSearchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadMilitares(militarSearchInput.value);
                }, 300);
            });

            // Listener para cliques na lista de resultados
            militarResultsList.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI' && e.target.dataset.id) {
                    console.log("Militar selecionado:", e.target.dataset.id, e.target.dataset.name);
                    hiddenMilitarInput.value = e.target.dataset.id;
                    selectedMilitarName.textContent = e.target.dataset.name || 'Militar selecionado';
                    selectedMilitarName.classList.add('selected');
                    // Dispara evento 'change'
                    const event = new Event('change', { bubbles: true });
                    hiddenMilitarInput.dispatchEvent(event);
                    closeModal();
                }
            });

             // Listener para limpar a seleção se o input hidden for limpo
            hiddenMilitarInput.addEventListener('change', () => {
                console.log("Input hidden 'id_militar' mudou:", hiddenMilitarInput.value);
                if (!hiddenMilitarInput.value) {
                    selectedMilitarName.textContent = 'Nenhum militar selecionado';
                    selectedMilitarName.classList.remove('selected');
                }
            });
        } else {
            // Log detalhado de quais elementos estão faltando
            console.error("Erro CRÍTICO: Elementos essenciais para o modal de seleção de militar NÃO foram encontrados no DOM:");
            if (!militarSelectBtn) console.error("- Botão #militar-select-btn");
            if (!militarModal) console.error("- Modal #militar-modal");
            if (!cancelMilitarSelectBtn) console.error("- Botão #cancel-militar-select-btn");
            if (!militarSearchInput) console.error("- Input #militar-search-input");
            if (!militarResultsList) console.error("- Lista #militar-results-list");
            if (!hiddenMilitarInput) console.error("- Input #id_militar");
            if (!selectedMilitarName) console.error("- Span #selected-militar-name");
        }
    } else {
        console.log("Modo Edição: Script do modal de seleção de militar não executado.");
    }

});
</script>
{% endblock %}

