{% extends 'base.html' %}

{% block title %}Detalhes da PATD Nº {{ patd.numero_patd }}{% endblock %}

{% block content %}
<style>
    .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .tabs-nav a { padding: 10px 20px; text-decoration: none; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; /* Alinha com a borda inferior */ cursor: pointer; }
    .tabs-nav a.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .document-view { width: 100%; min-height: 500px; padding: 20px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-primary); font-family: var(--font-family); /* Alterado para a fonte padrão da aplicação */ font-size: 14px; line-height: 1.7; box-sizing: border-box; white-space: pre-wrap; /* Preserva espaços e quebras de linha */ }
    .document-view .signature-image-embedded { max-height: 60px; width: auto; background-color: white; border: 1px solid #ccc; border-radius: 4px; padding: 2px; vertical-align: middle; }
    .document-view .no-signature-text { font-style: italic; color: var(--text-secondary); }
    .btn-success { background: linear-gradient(45deg, var(--success-color), #5cb85c); color: #fff; }
    .prazo-defesa { background-color: var(--sidebar-active-bg); border-left: 4px solid var(--warning-color); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    .prazo-defesa.expirado { border-left-color: var(--danger-color); }
    .prazo-defesa strong { display: block; margin-bottom: 5px; color: var(--text-primary); }
    .prazo-defesa small { display: block; margin-top: 8px; font-size: 12px; color: var(--text-secondary); }
    .analise-container { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; }
    .analise-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-card { background-color: var(--bg-main); padding: 15px; border-radius: 8px; }
    .form-card h4 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
    .form-card textarea, .form-card input { width: 100%; box-sizing: border-box; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); }
    .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; }
    /* --- CORREÇÃO APLICADA AQUI --- */
    .btn .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>

<h1>PATD Nº {{ patd.numero_patd }}</h1>

<nav class="tabs-nav">
    <a class="tab-link active" data-target="tab-detalhes">Detalhes</a>
    <a class="tab-link" data-target="tab-documento">Documento</a>
</nav>

<div id="tab-detalhes" class="tab-panel active">

    {% if patd.status == 'aguardando_justificativa' or patd.status == 'prazo_expirado' %}
    <div id="prazo-box" class="prazo-defesa">
        <strong>Prazo para Alegação de Defesa:</strong>
        <span id="countdown-timer">A calcular...</span>
        <small>Nota: O prazo é contado em dias úteis.</small>
    </div>
    {% endif %}

    <div class="detail-grid">
        <div class="detail-item">
            <strong>Militar Acusado:</strong>
            <p class="detail-item-value">
                <a href="{% url 'Ouvidoria:militar_patd_list' patd.militar.pk %}" class="militar-acusado-link">
                    {{ patd.militar.posto }} {{ patd.militar.especializacao }} {{ patd.militar.nome_completo }} (<strong>{{ patd.militar.nome_guerra }}</strong>)
                </a>
            </p>
        </div>
        <div class="detail-item">
            <strong>Status:</strong>
            <p id="patd-status" class="detail-item-value">{{ patd.get_status_display }}</p>
        </div>
        <div class="detail-item-full">
            <strong>Oficial Responsável:</strong>
            <div class="oficial-container">
                <p class="detail-item-value">{{ patd.oficial_responsavel|default:"Não atribuído" }}</p>
                <div class="signature-display-container">
                    {% if patd.oficial_responsavel and not patd.assinatura_oficial %}
                        <button type="button" class="btn btn-sm btn-secondary" id="add-signature-btn">Adicionar Assinatura</button>
                    {% elif patd.assinatura_oficial %}
                        <img src="{{ patd.assinatura_oficial }}" alt="Assinatura do Oficial" class="signature-image">
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="detail-item-full">
            <strong>Testemunhas:</strong>
            <div class="testemunha-container" style="display: flex; gap: 40px;">
                <div class="oficial-container">
                    <p class="detail-item-value">1ª: {{ patd.testemunha1|default:"Não atribuída" }}</p>
                    <div class="signature-display-container">
                        {% if patd.testemunha1 and patd.status in 'preclusao,apuracao_preclusao' and not patd.assinatura_testemunha1 %}
                            <button type="button" class="btn btn-sm btn-secondary add-signature-testemunha-btn" data-testemunha-num="1">Assinar</button>
                        {% elif patd.assinatura_testemunha1 %}
                            <img src="{{ patd.assinatura_testemunha1 }}" alt="Assinatura da 1ª Testemunha" class="signature-image">
                        {% endif %}
                    </div>
                </div>
                <div class="oficial-container">
                    <p class="detail-item-value">2ª: {{ patd.testemunha2|default:"Não atribuída" }}</p>
                     <div class="signature-display-container">
                        {% if patd.testemunha2 and patd.status in 'preclusao,apuracao_preclusao' and not patd.assinatura_testemunha2 %}
                            <button type="button" class="btn btn-sm btn-secondary add-signature-testemunha-btn" data-testemunha-num="2">Assinar</button>
                        {% elif patd.assinatura_testemunha2 %}
                            <img src="{{ patd.assinatura_testemunha2 }}" alt="Assinatura da 2ª Testemunha" class="signature-image">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="detail-item">
            <strong>Data da Ocorrência:</strong>
            <p class="detail-item-value">{{ patd.data_ocorrencia|date:"d/m/Y"|default:"Não informada" }}</p>
        </div>
        <div class="detail-item-full">
            <strong>Descrição da Transgressão:</strong>
            <p>{{ patd.transgressao|linebreaks }}</p>
        </div>
        <div class="detail-item-full">
            <strong>Ciência do Militar Acusado:</strong>
            <div class="signature-display-container">
                {% if patd.assinatura_militar_ciencia %}
                    <img src="{{ patd.assinatura_militar_ciencia }}" alt="Assinatura do Militar" class="signature-image">
                {% else %}
                    <p class="detail-item-value">Aguardando assinatura de ciência.</p>
                {% endif %}
            </div>
        </div>
        {% if patd.alegacao_defesa %}
        <div class="detail-item-full">
            <strong>Alegação de Defesa:</strong>
            <p>{{ patd.alegacao_defesa|linebreaks }}</p>
        </div>
        {% endif %}

        {% if patd.status == 'em_apuracao' or patd.status == 'apuracao_preclusao' %}
        <div class="detail-item-full analise-container">
            <h2>Análise Disciplinar</h2>
            <div id="analise-actions">
                <button class="btn btn-primary" id="btn-apurar">
                    <span class="spinner" style="display: none;"></span>
                    Apurar
                </button>
            </div>
            <div id="analise-form-wrapper" style="display: none; margin-top: 20px;">
                <form id="form-apuracao">
                    <div class="analise-form-grid">
                        <div class="form-card">
                            <h4>Itens Enquadrados</h4>
                            <textarea name="itens_enquadrados" id="input-itens" rows="5"></textarea>
                        </div>
                        <div class="form-card">
                            <h4>Circunstâncias</h4>
                            <label for="input-atenuantes">Atenuantes:</label>
                            <input type="text" name="atenuantes" id="input-atenuantes">
                            <label for="input-agravantes" style="margin-top:10px;">Agravantes:</label>
                            <input type="text" name="agravantes" id="input-agravantes">
                        </div>
                    </div>
                    <div class="form-card" style="margin-top: 20px;">
                        <h4>Sugestão de Punição</h4>
                        <textarea name="punicao_sugerida" id="input-punicao" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Salvar Apuração</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="form-actions" id="form-actions-container">
        {% if patd.status == 'ciencia_militar' and not patd.assinatura_militar_ciencia %}
        <button type="button" class="btn btn-success" id="add-signature-ciencia-btn">Assinar Ciência</button>
        {% endif %}
        {% if patd.status == 'aguardando_justificativa' and not patd.alegacao_defesa %}
        <button type="button" class="btn btn-primary" id="add-defesa-btn">Adicionar Alegação de Defesa</button>
        {% endif %}
        {% if patd.status == 'prazo_expirado' %}
        <button type="button" class="btn btn-warning" id="extender-prazo-btn">Extender Prazo</button>
        <button type="button" class="btn btn-danger" id="prosseguir-sem-defesa-btn">Prosseguir sem Alegação</button>
        {% endif %}
        <a href="{% url 'Ouvidoria:patd_update' patd.pk %}" class="btn btn-primary">Editar PATD</a>
        <a href="{% url 'Ouvidoria:patd_list' %}" class="btn btn-secondary">Voltar para a Lista</a>
        <button type="button" class="btn btn-delete" id="delete-patd-btn">Excluir</button>
    </div>
</div>

<div id="tab-documento" class="tab-panel">
    <div id="documento-view" class="document-view"></div>
    <div id="documento-raw-text" style="display: none;">{{ patd.documento_texto }}</div>
</div>

<div class="modal-overlay" id="delete-modal">
    <div class="modal-content">
        <h3>Confirmar Exclusão</h3>
        <p>Tem a certeza de que deseja excluir a PATD Nº {{ patd.numero_patd }}? Esta ação não pode ser desfeita.</p>
        <form method="post" action="{% url 'Ouvidoria:patd_delete' patd.pk %}" style="display: inline;">
            {% csrf_token %}
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-delete-btn">Cancelar</button>
                <button type="submit" class="btn btn-delete">Sim, Excluir</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="signature-modal">
    <div class="modal-content">
        <h3>Assinatura do Oficial</h3>
        <p>Desenhe a assinatura no campo abaixo.</p>
        <div class="canvas-container"><canvas id="signature-canvas"></canvas></div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="clear-signature-btn">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn">Salvar Assinatura</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="signature-modal-ciencia">
    <div class="signature-modal-content">
        <h3>Registrar Ciência da Acusação</h3>
        <p>Eu, {{ patd.militar }}, declaro ter ciência dos fatos a mim imputados.</p>
        <div class="canvas-container"><canvas id="signature-canvas-ciencia"></canvas></div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="clear-signature-btn-ciencia">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn-ciencia">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn-ciencia">Confirmar Ciência</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="defesa-modal">
    <div class="modal-content">
        <h3>Alegação de Defesa</h3>
        <p>Escreva abaixo a sua alegação de defesa referente aos fatos imputados.</p>
        <textarea id="alegacao-defesa-texto" style="width: 100%; min-height: 150px;"></textarea>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-defesa-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="submit-defesa-btn">Concluir</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="confirm-defesa-modal">
    <div class="modal-content">
        <h3>Confirmar Envio</h3>
        <p>Tem a certeza de que deseja enviar a sua alegação de defesa? Esta ação é final e não poderá ser alterada.</p>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-confirm-defesa-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="final-submit-defesa-btn">Sim, Enviar</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="extender-prazo-modal">
    <div class="modal-content">
        <h3>Extender Prazo de Defesa</h3>
        <p>Defina o novo prazo para a entrega da alegação de defesa a contar de agora.</p>
        <form id="extender-prazo-form" class="model-form">
            <div class="form-grid" style="grid-template-columns: 1fr {% if user.is_superuser %}1fr{% endif %}; gap: 15px;">
                <p><label for="extender-dias">Dias:</label><input type="number" id="extender-dias" value="{{ prazo_defesa_dias }}" min="0"></p>
                {% if user.is_superuser %}
                <p><label for="extender-minutos">Minutos:</label><input type="number" id="extender-minutos" value="{{ prazo_defesa_minutos }}" min="0"></p>
                {% endif %}
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-extender-prazo-btn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Confirmar Extensão</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="signature-modal-testemunha">
    <div class="signature-modal-content">
        <h3 id="signature-modal-testemunha-title">Assinatura da Testemunha</h3>
        <p>A testemunha deve desenhar a assinatura no campo abaixo.</p>
        <div class="canvas-container"><canvas id="signature-canvas-testemunha"></canvas></div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="clear-signature-btn-testemunha">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn-testemunha">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn-testemunha">Salvar Assinatura</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados da análise pré-carregados pelo Django
const analiseData = {{ analise_data_json|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let isExpired = `{{ patd.status }}` === 'prazo_expirado';

    // ... (toda a lógica de modais e contagem regressiva permanece a mesma) ...
    const deleteBtn = document.getElementById('delete-patd-btn');
    const deleteModal = document.getElementById('delete-modal');
    if (deleteBtn && deleteModal) {
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        deleteBtn.addEventListener('click', () => deleteModal.classList.add('active'));
        cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('active'));
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) deleteModal.classList.remove('active');
        });
    }
    const addSignatureCienciaBtn = document.getElementById('add-signature-ciencia-btn');
    const signatureModalCiencia = document.getElementById('signature-modal-ciencia');
    if (addSignatureCienciaBtn && signatureModalCiencia) {
        const canvasCiencia = document.getElementById('signature-canvas-ciencia');
        const signaturePadCiencia = new SignaturePad(canvasCiencia, { backgroundColor: 'rgb(255, 255, 255)' });
        function resizeCanvasCiencia() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvasCiencia.width = canvasCiencia.offsetWidth * ratio;
            canvasCiencia.height = canvasCiencia.offsetHeight * ratio;
            canvasCiencia.getContext("2d").scale(ratio, ratio);
            signaturePadCiencia.clear();
        }
        addSignatureCienciaBtn.addEventListener('click', () => {
            signatureModalCiencia.classList.add('active');
            resizeCanvasCiencia();
        });
        document.getElementById('cancel-signature-btn-ciencia').addEventListener('click', () => signatureModalCiencia.classList.remove('active'));
        document.getElementById('clear-signature-btn-ciencia').addEventListener('click', () => signaturePadCiencia.clear());
        document.getElementById('save-signature-btn-ciencia').addEventListener('click', () => {
            if (signaturePadCiencia.isEmpty()) {
                alert("Por favor, forneça a assinatura.");
                return;
            }
            const signatureData = signaturePadCiencia.toDataURL('image/png');
            const url = `{% url 'Ouvidoria:salvar_assinatura_ciencia' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'signature_data': signatureData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }
    const addDefesaBtn = document.getElementById('add-defesa-btn');
    const defesaModal = document.getElementById('defesa-modal');
    const confirmDefesaModal = document.getElementById('confirm-defesa-modal');
    if (addDefesaBtn && defesaModal) {
        const cancelDefesaBtn = document.getElementById('cancel-defesa-btn');
        const submitDefesaBtn = document.getElementById('submit-defesa-btn');
        const cancelConfirmDefesaBtn = document.getElementById('cancel-confirm-defesa-btn');
        const finalSubmitDefesaBtn = document.getElementById('final-submit-defesa-btn');
        const alegacaoText = document.getElementById('alegacao-defesa-texto');
        addDefesaBtn.addEventListener('click', () => defesaModal.classList.add('active'));
        cancelDefesaBtn.addEventListener('click', () => defesaModal.classList.remove('active'));
        submitDefesaBtn.addEventListener('click', () => {
            if (alegacaoText.value.trim() === "") {
                alert("O campo de alegação de defesa não pode estar vazio.");
                return;
            }
            defesaModal.classList.remove('active');
            confirmDefesaModal.classList.add('active');
        });
        cancelConfirmDefesaBtn.addEventListener('click', () => confirmDefesaModal.classList.remove('active'));
        finalSubmitDefesaBtn.addEventListener('click', () => {
            const url = `{% url 'Ouvidoria:salvar_alegacao_defesa' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'alegacao_defesa': alegacaoText.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }
    const extenderPrazoModal = document.getElementById('extender-prazo-modal');
    const extenderPrazoBtn = document.getElementById('extender-prazo-btn');
    const prosseguirBtn = document.getElementById('prosseguir-sem-defesa-btn');
    function handleProsseguirSemAlegacao() {
        if (confirm('Tem certeza que deseja prosseguir sem a alegação de defesa? Esta ação registrará a preclusão e não poderá ser desfeita.')) {
            const url = `{% url 'Ouvidoria:prosseguir_sem_alegacao' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        }
    }
    if (extenderPrazoBtn) {
        extenderPrazoBtn.addEventListener('click', () => extenderPrazoModal.classList.add('active'));
    }
    if (prosseguirBtn) {
        prosseguirBtn.addEventListener('click', handleProsseguirSemAlegacao);
    }
    if (extenderPrazoModal) {
        document.getElementById('cancel-extender-prazo-btn').addEventListener('click', () => extenderPrazoModal.classList.remove('active'));
        document.getElementById('extender-prazo-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const dias = document.getElementById('extender-dias').value;
            const minutosInput = document.getElementById('extender-minutos');
            const minutos = minutosInput ? minutosInput.value : 0;
            const url = `{% url 'Ouvidoria:extender_prazo' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'dias': dias, 'minutos': minutos })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }
    const countdownTimer = document.getElementById('countdown-timer');
    const prazoBox = document.getElementById('prazo-box');
    if (countdownTimer && '{{ patd.data_ciencia }}') {
        const dataCiencia = new Date('{{ patd.data_ciencia|date:"c" }}');
        const prazoDias = parseInt('{{ prazo_defesa_dias }}', 10) || 0;

        function addBusinessDays(startDate, days) {
            let currentDate = new Date(startDate);
            let addedDays = 0;
            while (addedDays < days) {
                currentDate.setDate(currentDate.getDate() + 1);
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    addedDays++;
                }
            }
            return currentDate;
        }
        let deadlineDate = addBusinessDays(dataCiencia, prazoDias);
        let deadline = new Date(deadlineDate.getFullYear(), deadlineDate.getMonth(), deadlineDate.getDate() + 1);

        const interval = setInterval(() => {
            const now = new Date();
            const diff = deadline - now;
            if (diff <= 0) {
                countdownTimer.textContent = "Prazo expirado.";
                if(prazoBox) prazoBox.classList.add('expirado');
                clearInterval(interval);
                if (!isExpired) {
                    isExpired = true;
                    showExpiredButtons();
                }
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            countdownTimer.textContent = `${d}d ${h}h ${m}m ${s}s`;
        }, 1000);
    }
    function showExpiredButtons() {
        const actionsContainer = document.getElementById('form-actions-container');
        const addDefesaBtn = document.getElementById('add-defesa-btn');
        const statusElement = document.getElementById('patd-status');
        if (addDefesaBtn) addDefesaBtn.remove();
        if (statusElement) statusElement.textContent = "Prazo expirado";
        if (!document.getElementById('extender-prazo-btn')) {
            const extenderBtn = document.createElement('button');
            extenderBtn.type = 'button';
            extenderBtn.className = 'btn btn-warning';
            extenderBtn.id = 'extender-prazo-btn';
            extenderBtn.textContent = 'Extender Prazo';
            extenderBtn.addEventListener('click', () => extenderPrazoModal.classList.add('active'));
            actionsContainer.insertBefore(extenderBtn, actionsContainer.firstChild);
        }
        if (!document.getElementById('prosseguir-sem-defesa-btn')) {
            const prosseguirBtn = document.createElement('button');
            prosseguirBtn.type = 'button';
            prosseguirBtn.className = 'btn btn-danger';
            prosseguirBtn.id = 'prosseguir-sem-defesa-btn';
            prosseguirBtn.textContent = 'Prosseguir sem Alegação';
            prosseguirBtn.addEventListener('click', handleProsseguirSemAlegacao);
            const extenderBtn = document.getElementById('extender-prazo-btn');
            if (extenderBtn) extenderBtn.insertAdjacentElement('afterend', prosseguirBtn);
            else actionsContainer.insertBefore(prosseguirBtn, actionsContainer.firstChild);
        }
    }
    const addSignatureTestemunhaBtns = document.querySelectorAll('.add-signature-testemunha-btn');
    if (addSignatureTestemunhaBtns.length > 0) {
        const signatureModalTestemunha = document.getElementById('signature-modal-testemunha');
        const modalTitle = document.getElementById('signature-modal-testemunha-title');
        const canvas = document.getElementById('signature-canvas-testemunha');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
        let currentTestemunhaNum = null;
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        addSignatureTestemunhaBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentTestemunhaNum = btn.dataset.testemunhaNum;
                modalTitle.textContent = `Assinatura da ${currentTestemunhaNum}ª Testemunha`;
                signatureModalTestemunha.classList.add('active');
                resizeCanvas();
            });
        });
        document.getElementById('cancel-signature-btn-testemunha').addEventListener('click', () => signatureModalTestemunha.classList.remove('active'));
        document.getElementById('clear-signature-btn-testemunha').addEventListener('click', () => signaturePad.clear());
        document.getElementById('save-signature-btn-testemunha').addEventListener('click', () => {
            if (signaturePad.isEmpty() || !currentTestemunhaNum) return;
            const signatureData = signaturePad.toDataURL('image/png');
            const url = `/Ouvidoria/patd/{{ patd.pk }}/salvar_assinatura_testemunha/${currentTestemunhaNum}/`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'signature_data': signatureData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabPanels = document.querySelectorAll('.tab-panel');
    tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            tabLinks.forEach(l => l.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            link.classList.add('active');
            const targetPanel = document.getElementById(link.dataset.target);
            if (targetPanel) targetPanel.classList.add('active');
        });
    });
    function renderDocument() {
        const rawTextContainer = document.getElementById('documento-raw-text');
        const viewer = document.getElementById('documento-view');
        if (!rawTextContainer || !viewer) return;
        let processedHtml = rawTextContainer.textContent;
        processedHtml = processedHtml.replace(/(data:image\/png;base64,[A-Za-z0-9+/=]+)/g, '<img class="signature-image-embedded" src="$1" alt="Assinatura">');
        processedHtml = processedHtml.replace(/\[Sem assinatura\]/g, '<span class="no-signature-text">[Sem assinatura]</span>');
        processedHtml = processedHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        processedHtml = processedHtml.replace(/\n/g, '<br>');
        viewer.innerHTML = processedHtml;
    }
    renderDocument();

    // --- NOVA LÓGICA PARA APURAÇÃO ---
    const btnApurar = document.getElementById('btn-apurar');
    const formWrapper = document.getElementById('analise-form-wrapper');
    const apuracaoForm = document.getElementById('form-apuracao');

    if (btnApurar) {
        btnApurar.addEventListener('click', function() {
            const spinner = this.querySelector('.spinner');
            spinner.style.display = 'inline-block';
            this.disabled = true;

            const url = `/Ouvidoria/patd/{{ patd.pk }}/analisar_punicao/`;
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Formata os itens para o textarea
                    const itensText = data.itens.map(i => `Item ${i.numero}: ${i.descricao}`).join('\n');
                    document.getElementById('input-itens').value = itensText;

                    // Popula as circunstâncias
                    document.getElementById('input-atenuantes').value = data.circunstancias.atenuantes.join(', ');
                    document.getElementById('input-agravantes').value = data.circunstancias.agravantes.join(', ');
                    
                    // Popula a punição
                    document.getElementById('input-punicao').value = data.punicao;

                    // Mostra o formulário
                    formWrapper.style.display = 'block';
                    this.style.display = 'none'; // Esconde o botão "Apurar"
                } else {
                    alert(`Erro na análise: ${data.message}`);
                }
            })
            .catch(err => {
                alert('Erro de comunicação ao iniciar a análise.');
                console.error(err);
            })
            .finally(() => {
                spinner.style.display = 'none';
                this.disabled = false;
            });
        });
    }

    if (apuracaoForm) {
        apuracaoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'A Salvar...';

            // Serializa os dados do formulário para JSON
            const itensText = document.getElementById('input-itens').value;
            const itensArray = itensText.split('\n').map(line => {
                const match = line.match(/Item (\d+): (.*)/);
                return match ? { numero: parseInt(match[1]), descricao: match[2] } : null;
            }).filter(Boolean);

            const dataToSave = {
                itens_enquadrados: itensArray,
                circunstancias: {
                    atenuantes: document.getElementById('input-atenuantes').value.split(',').map(s => s.trim()).filter(Boolean),
                    agravantes: document.getElementById('input-agravantes').value.split(',').map(s => s.trim()).filter(Boolean)
                },
                punicao_sugerida: document.getElementById('input-punicao').value
            };

            const url = `/Ouvidoria/patd/{{ patd.pk }}/salvar_apuracao/`;
            fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken 
                },
                body: JSON.stringify(dataToSave)
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    alert(data.message);
                    window.location.reload(); // Recarrega para mostrar o documento atualizado
                } else {
                    alert(`Erro ao salvar: ${data.message}`);
                }
            })
            .catch(err => {
                alert('Erro de comunicação ao salvar a apuração.');
                console.error(err);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Salvar Apuração';
            });
        });
    }
});
</script>
{% endblock %}