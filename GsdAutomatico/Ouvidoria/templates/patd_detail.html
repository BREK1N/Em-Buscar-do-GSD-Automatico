{% extends 'base.html' %}
{% load auth_extras %}

{% block title %}Detalhes da PATD Nº {{ patd.numero_patd }}{% endblock %}

{% block content %}
<style>
    /* Estilos CSS */
    .status-timeline {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0;
        list-style: none;
        position: relative;
    }
    .status-timeline::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--border-color);
        transform: translateY(-50%);
        z-index: 1;
    }
    .status-step {
        position: relative;
        text-align: center;
        width: 100%;
        z-index: 2;
    }
    .status-step .status-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: var(--border-color);
        margin: 0 auto 10px;
        border: 3px solid var(--bg-content);
        transition: background-color: 0.3s;
    }
    .status-step.completed .status-dot,
    .status-step.active .status-dot {
        background-color: var(--accent-color);
    }
    .status-step .status-label {
        font-size: 12px;
        color: var(--text-secondary);
    }
     .status-step.active .status-label {
        font-weight: bold;
        color: var(--text-primary);
    }

    .patd-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        flex-wrap: wrap; /* Permite que os botões quebrem em telas menores */
    }

    .patd-header h1 {
        border-bottom: none;
        padding-bottom: 0;
        margin-right: 20px; /* Espaço entre o título e os botões */
        font-size: 1.75rem;
    }

    .patd-actions {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
        align-items: center; /* Alinha os botões verticalmente */
    }

    .card {
        background-color: var(--bg-content);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: var(--box-shadow);
    }
    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    .card-header svg {
        width: 24px;
        height: 24px;
        color: var(--accent-color);
    }
    .card-header h2 {
        margin: 0;
        font-size: 1.1rem;
    }
    .card-body .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }
     .card-body .detail-item strong {
        display: block;
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
     .card-body .detail-item p, .card-body .detail-item .detail-value,
     /* Estilo para as listas de atenuantes/agravantes */
     .card-body .detail-item ul {
        margin: 0;
        color: var(--text-primary);
        font-weight: 500;
        padding-left: 20px; /* Adiciona indentação para a lista */
        list-style-type: none; /* Remove marcadores padrão */
        font-size: 0.9rem;
    }
    .card-body .detail-item ul li {
        margin-bottom: 5px; /* Espaçamento entre itens */
    }


    .full-width {
        grid-column: 1 / -1;
    }
    .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .tabs-nav a { padding: 10px 20px; text-decoration: none; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; cursor: pointer; }
    .tabs-nav a.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .btn-success { background: linear-gradient(45deg, var(--success-color), #5cb85c); color: #fff; }
    .btn-info { background: linear-gradient(45deg, #17a2b8, #2ca8ff); color: #fff; }
    .prazo-defesa { background-color: var(--sidebar-active-bg); border-left: 4px solid var(--warning-color); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    .prazo-defesa.expirado { border-left-color: var(--danger-color); }
    .analise-container .feedback-message { margin-top: 10px; padding: 10px; border-radius: 6px; font-weight: 500; }
    .feedback-message.processing { background-color: var(--sidebar-active-bg); border-left: 4px solid var(--warning-color); color: var(--text-primary); }
    .feedback-message.error { background-color: #f8d7da; border-left: 4px solid var(--danger-color); color: #721c24; }
    #apuracao-form { display: none; margin-top: 15px; }
    #apuracao-form .form-grid { grid-template-columns: 1fr 1fr; gap: 20px; }
    #apuracao-form textarea, #apuracao-form input, #apuracao-form select { width: 100%; box-sizing: border-box; } /* Adicionado select */
    #apuracao-form .form-item-full { grid-column: 1 / -1; }

    /* Animação do Spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none; /* Oculto por padrão */
    }
    .btn.loading .spinner { display: inline-block; }
    .btn.loading .btn-text { display: none; }

    /* Estilos para o histórico */
    .historico-list {
        list-style-type: none;
        padding-left: 0;
        max-height: 200px;
        overflow-y: auto;
    }
    .historico-item {
        background-color: var(--bg-main);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 4px solid var(--border-color);
    }
    .historico-item strong {
        color: var(--text-primary);
    }
    .historico-item span {
        font-size: 0.9rem;
        color: var(--text-secondary);
        display: block;
    }

    /* ESTILOS REFINADOS PARA VISUALIZADOR */
     .document-preview-container {
        flex-grow: 1;
        background-color: var(--bg-main); /* Fundo cinza claro para contraste */
        padding: 30px; /* Aumenta o padding externo */
        border-radius: 8px;
        overflow-y: auto; /* Scroll vertical para o container todo */
        overflow-x: hidden;
    }
    .page {
        background: white;
        color: black;
        width: 21cm;
        min-height: 29.7cm; /* Altura mínima A4 */
        margin: 0 auto 20px auto; /* Centraliza e adiciona espaço inferior entre páginas */
        /* --- INÍCIO DA MODIFICAÇÃO: Ajuste de margens para corresponder à exportação DOCX --- */
        padding-top: 1.5cm;
        padding-bottom: 2.54cm;
        padding-left: 2.15cm;
        padding-right: 2.5cm;
        /* --- FIM DA MODIFICAÇÃO --- */
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Sombra mais visível */
        box-sizing: border-box;
        font-family: 'Times New Roman', Times, serif;
        font-size: 12pt;
        position: relative; /* Alterado para relative para numeração de página */
        overflow: hidden; /* Evita que conteúdo interno vaze visualmente */
    }
    
    .page-number {
        position: absolute;
        bottom: 1.5cm; /* Posição dentro da margem inferior */
        right: 2.5cm;  /* Posição dentro da margem direita */
        font-family: 'Times New Roman', Times, serif;
        font-size: 10pt;
        color: #555;
    }

    /* Zera margens e paddings de TODOS os elementos diretos dentro de page-content */
    .page-content > * {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    /* Aplica espaçamento padrão APENAS a parágrafos com conteúdo */
    .page-content p:not(:empty) {
       margin-bottom: 0.5em !important; /* Espaçamento entre parágrafos com texto, reduzido */
       line-height: 1.5;
       orphans: 3; /* Evita que uma única linha de parágrafo fique isolada no topo da página */
       widows: 3;  /* Evita que uma única linha de parágrafo fique isolada na base da página */
    }

    /* Reset de margens para elementos de bloco comuns dentro do conteúdo da página */
    .page-content h1, .page-content h2, .page-content h3, .page-content h4, .page-content h5, .page-content h6,
    .page-content ul, .page-content ol, .page-content dl, .page-content blockquote, .page-content pre,
    .page-content table {
        margin-top: 0.5em !important;
        margin-bottom: 0.5em !important;
    }

     /* Trata especificamente a imagem do brasão */
    .page-content img[alt*="Brasão da República"] {
        display: block;
        width: 3cm !important; /* Define uma largura fixa */
        height: auto;
        margin: 0.5em auto 0.5em auto !important; /* Reduz margens verticais e centraliza */
    }

    /* Outras imagens genéricas */
    .page-content img {
        max-width: 100%;
        height: auto;
        display: block; /* Para evitar espaço extra abaixo da imagem */
        margin: 1em auto; /* Centraliza imagens */
    }


    /* Garante negrito */
    .page-content strong {
        font-weight: bold;
    }


    .signature-image-embedded {
        max-height: 150px; /* Define uma altura máxima para as imagens de assinatura */
        max-width: 350px; /* Define uma largura máxima para as imagens de assinatura */
        vertical-align: middle; /* Alinha a imagem verticalmente com o texto ao redor */
    }

    /* Estilos para a lista de anexos na Visão Geral */
    #anexos-card-geral ul {
        list-style-type: none;
        padding-left: 0;
    }
    #anexos-card-geral li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-radius: 6px;
        transition: background-color: 0.2s;
    }
    #anexos-card-geral li:hover {
        background-color: var(--bg-main);
    }
    #anexos-card-geral li span {
        font-weight: 500;
        color: var(--text-primary);
        word-break: break-all;
        padding-right: 15px;
    }
    .anexo-actions {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
    }
    
    /* --- ESTILOS MODIFICADOS/NOVOS PARA ANEXOS EMBUTIDOS --- */
    .embedded-anexo-container {
        margin-top: 20px;
        margin-bottom: 20px;
        border-top: 2px dashed #ccc; /* Linha de separação */
        border-bottom: 2px dashed #ccc; /* Linha de separação */
        padding: 20px 0;
    }
    .embedded-anexo-header {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333; /* Cor escura para o 'white' da página */
        margin-bottom: 15px;
        text-align: center;
    }
    .embedded-anexo-item {
        margin-bottom: 20px;
    }
    .embedded-anexo-item h4 {
        font-size: 1rem;
        font-weight: bold;
        color: #555;
        margin-bottom: 10px;
        text-align: center; /* Centraliza o nome do arquivo */
    }
    .embedded-anexo-link { /* Era .embedded-download-prompt */
        padding: 10px;
        text-align: center;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 10px;
    }
    .embedded-anexo-link p {
        font-size: 1rem;
        color: #333;
        margin-bottom: 15px !important; /* Sobrescreve o !important da página */
    }
    .embedded-anexo-link a.btn-download {
        display: inline-flex; /* Alterado para inline-flex */
        align-items: center; /* Alinha ícone e texto */
        gap: 8px; /* Espaço entre ícone e texto */
        padding: 10px 15px;
        background-color: #007bff; /* Cor consistente */
        color: #fff;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        font-family: var(--font-family); /* Garante a fonte correta */
        font-size: 0.9rem; /* Tamanho de fonte padrão de botão */
    }
    /* --- FIM DOS NOVOS ESTILOS --- */

    @media print {
        /* Oculta tudo que não for o visualizador de documento */
        .sidebar, .main-header, .patd-header, .status-timeline, .tabs-nav, #tab-detalhes, .patd-actions, .modal-overlay {
            display: none !important;
        }

        /* Garante que o visualizador e seu container ocupem o espaço */
        #tab-visualizador, .document-preview-container {
            display: block !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: visible !important;
        }

        /* Estilo da página para impressão */
        .page {
            overflow: visible !important; /* ESSENCIAL: para não cortar conteúdo */
            box-shadow: none;
            border: none;
            margin: 0;
            width: 100%; /* Ocupa a largura da área de impressão */
            height: auto;
            min-height: 0;
            padding: 0; /* A margem é controlada pelo @page */
            page-break-after: always; /* Quebra a página depois de cada div .page */
        }

        .page:last-of-type {
            page-break-after: auto; /* Não quebra depois da última página */
        }

        /* Controla as margens da página impressa */
        @page {
            size: A4;
            margin: 2.5cm;
        }

        /* Evita quebras de página dentro de elementos importantes */
        .page-content p,
        .page-content ul,
        .page-content ol,
        .page-content img,
        .embedded-anexo-container,
        .signature-block { /* Adicionar se tiver um container de assinatura */
            page-break-inside: avoid;
        }

        /* Oculta a numeração de página customizada para usar a do navegador */
        .page-number {
            display: none;
        }
    }

    /* --- INÍCIO: Estilos para o botão de navegação de assinatura --- */
    #signature-nav-button {
        position: fixed; /* Fixo na tela */
        right: 40px;
        bottom: 40px;
        z-index: 1050; /* Acima de outros elementos */
        display: none; /* Oculto por padrão */
        flex-direction: column;
        align-items: center;
        gap: 8px;
        background-color: var(--accent-color);
        color: white;
        padding: 12px;
        border-radius: 50%; /* Círculo */
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: background-color 0.3s, transform 0.2s;
        width: 60px;
        height: 60px;
        justify-content: center;
    }
    #signature-nav-button:hover {
        background-color: #0056b3; /* Um tom mais escuro de azul */
        transform: scale(1.05);
    }
    #signature-counter {
        font-size: 0.8rem;
        font-weight: bold;
    }
    #signature-nav-button svg {
        width: 24px;
        height: 24px;
    }
    /* --- FIM: Estilos para o botão de navegação de assinatura --- */

</style>

<div class="patd-header">
    <h1>PATD Nº {{ patd.numero_patd }}</h1>
    <div class="patd-actions">
        <a href="{% url 'Ouvidoria:exportar_patd_docx' patd.pk %}" class="btn btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Exportar DOCX
        </a>

        {# --- INÍCIO DA MODIFICAÇÃO: Condição para editar --- #}
        {% if not user|has_comandante_access and patd.status not in locked_statuses_for_edit %}
            <a href="{% url 'Ouvidoria:patd_update' patd.pk %}" class="btn btn-secondary">Editar</a>
        {% else %}
            <button class="btn btn-secondary" disabled title="O processo não pode ser editado nesta fase.">Editar12</button>
        {% endif %}
    

        {% if user|can_delete_patd %}
        <button type="button" class="btn btn-delete" id="delete-patd-btn">Excluir</button>
        {% endif %}
    </div>
</div>

<ul class="status-timeline">
    {% with current_status=patd.status %}
    <li class="status-step {% if current_status in 'definicao_oficial,aguardando_aprovacao_atribuicao,ciencia_militar,aguardando_justificativa,prazo_expirado,em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar,analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,aguardando_comandante_base,aguardando_nova_punicao,aguardando_preenchimento_npd_reconsideracao,aguardando_publicacao,finalizado' %}active{% endif %} {% if current_status != 'definicao_oficial' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Abertura</div>
    </li>
    <li class="status-step {% if current_status in 'ciencia_militar,aguardando_justificativa,prazo_expirado,em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar,analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,aguardando_comandante_base,aguardando_nova_punicao,aguardando_preenchimento_npd_reconsideracao,aguardando_publicacao,finalizado' %}active{% endif %} {% if current_status not in 'definicao_oficial,aguardando_aprovacao_atribuicao' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Defesa</div>
    </li>
    <li class="status-step {% if current_status in 'em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar,analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,aguardando_comandante_base,aguardando_nova_punicao,aguardando_preenchimento_npd_reconsideracao,aguardando_publicacao,finalizado' %}active{% endif %} {% if current_status not in 'definicao_oficial,aguardando_aprovacao_atribuicao,ciencia_militar,aguardando_justificativa,prazo_expirado' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Apuração</div>
    </li>
    <li class="status-step {% if current_status in 'analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,aguardando_comandante_base,aguardando_preenchimento_npd_reconsideracao,aguardando_publicacao,finalizado' %}active{% endif %} {% if current_status not in 'definicao_oficial,aguardando_aprovacao_atribuicao,ciencia_militar,aguardando_justificativa,prazo_expirado,em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Decisão GSD</div>
    </li>
    <li class="status-step {% if current_status in 'aguardando_comandante_base,aguardando_nova_punicao,aguardando_preenchimento_npd_reconsideracao,aguardando_publicacao,finalizado' %}active{% endif %} {% if current_status not in 'definicao_oficial,aguardando_aprovacao_atribuicao,ciencia_militar,aguardando_justificativa,prazo_expirado,em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar,analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Decisão Base</div>
    </li>
    <li class="status-step {% if current_status in 'aguardando_publicacao,finalizado' %}active{% endif %} {% if current_status == 'finalizado' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Publicação</div>
    </li>
    <li class="status-step {% if current_status == 'finalizado' %}active completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Finalizado</div>
    </li>
    {% endwith %}
</ul>

<nav class="tabs-nav">
    <a class="tab-link active" data-target="tab-detalhes">Visão Geral</a>
    <a class="tab-link" data-target="tab-visualizador">Visualizador de Documentos</a>
</nav>

<div id="tab-detalhes" class="tab-panel active">

    <div class="card">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h2>Ações e Prazos</h2>
        </div>
        <div class="card-body">
            {% if patd.status == 'aguardando_justificativa' or patd.status == 'prazo_expirado' %}
            <div id="prazo-box" class="prazo-defesa">
                <strong>Prazo para Alegação de Defesa:</strong>
                <span id="countdown-timer">A calcular...</span>
            </div>
            {% endif %}
            {% if patd.status == 'periodo_reconsideracao' %}
            <div id="reconsideracao-prazo-box" class="prazo-defesa">
                <strong>Prazo para Reconsideração:</strong>
                <span id="reconsideracao-countdown-timer">A calcular...</span>
            </div>
            {% endif %}

            {% if patd.status == 'aguardando_comandante_base' and user.profile.militar == patd.oficial_responsavel %}
            <div class="card-body" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <h4>Anexar Documento de Reconsideração</h4>
                <p>Anexe o documento (PDF, Word ou imagem) referente à sua análise do pedido de reconsideração para prosseguir.</p>
                <form action="{% url 'Ouvidoria:anexar_reconsideracao_oficial' patd.pk %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-item">
                        <input type="file" name="anexo_oficial" accept=".doc,.docx,.png,.jpg,.jpeg,.pdf" required style="width: 100%; padding: 10px;">
                    </div>
                    <div class="form-actions" style="justify-content: flex-start; margin-top: 15px;">
                        <button type="submit" class="btn btn-primary">Anexar e Avançar</button>
                    </div>
                </form>
            </div>
            {% endif %}

             <div class="form-actions" id="form-actions-container">
                {% if patd.status == 'aguardando_justificativa' and not patd.alegacao_defesa %}
                <button type="button" class="btn btn-primary" id="add-defesa-btn">Adicionar Alegação de Defesa</button>
                {% endif %}
                {% if patd.status == 'prazo_expirado' %}
                <button type="button" class="btn btn-warning" id="extender-prazo-btn">Extender Prazo</button>
                <button type="button" class="btn btn-danger" id="prosseguir-sem-defesa-btn">Prosseguir sem Alegação</button>
                {% endif %}
                {% if request.user.profile.militar == patd.oficial_responsavel %}
                    {% if patd.status == 'aguardando_punicao' or patd.status == 'aguardando_punicao_alterar' %}
                    <button type="button" class="btn btn-success" id="btn-avancar-comandante">Avançar para Comandante</button>
                    {% endif %}
                {% endif %}
                {% if patd.status == 'periodo_reconsideracao' %}
                <button type="button" class="btn btn-warning" id="btn-reconsideracao-modal">Solicitar Reconsideração</button>
                {% endif %}
                {% if patd.status == 'analise_comandante' and user|has_comandante_access %}
                <button type="button" class="btn btn-success open-aprovar-modal-btn" data-patd-pk="{{ patd.pk }}" data-patd-numero="{{ patd.numero_patd }}">
                Aprovar e Finalizar
                </button>
                <button type="button" class="btn btn-warning open-retornar-modal-btn" data-patd-pk="{{ patd.pk }}" data-patd-numero="{{ patd.numero_patd }}">Retornar para Alteração</button>
                {% endif %}
                {% if patd.status == 'aguardando_publicacao' and user|has_ouvidoria_access %}
                <button type="button" class="btn btn-success" id="btn-finalizar-modal">Finalizar Publicação</button>
                {% endif %}
                {% if patd.status == 'aguardando_nova_punicao' and request.user.profile.militar == patd.oficial_responsavel %}
                <button type="button" class="btn btn-primary" id="btn-nova-punicao-modal">Definir Nova Punição</button>
                {% endif %}
            </div>
        </div>
    </div>

    {% if patd.comentario_comandante and patd.status == 'aguardando_punicao_alterar' %}
    <div class="card" style="border-left: 4px solid var(--warning-color);">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="color: var(--warning-color);"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
            <h2>Observação do Comandante</h2>
        </div>
        <div class="card-body">
            <p><strong>A PATD foi retornada para alteração com o seguinte comentário:</strong></p>
            <p style="background-color: var(--bg-main); padding: 15px; border-radius: 8px;"><em>{{ patd.comentario_comandante|linebreaksbr }}</em></p>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12.75h.008M8.25 15h.008M8.25 18h.008m3.75-12h.008m2.25-3h.008M12 6h.008m-2.25 6h.008m2.25 6h.008M12 18h.008m-3.75-6h.008m2.25-6h.008" /></svg>
            <h2>Detalhes do Processo</h2>
        </div>
        <div class="card-body">
            <div class="detail-grid">
                <div class="detail-item">
                    <strong>Militar Acusado:</strong>
                    <p class="detail-value"><a href="{% url 'Ouvidoria:militar_patd_list' patd.militar.pk %}" class="militar-acusado-link">{{ patd.militar }}</a></p>
                </div>
                <div class="detail-item">
                    <strong>Data da Ocorrência:</strong>
                    <p class="detail-value">{{ patd.data_ocorrencia|date:"d/m/Y"|default:"Não informada" }}</p>
                </div>
                <div class="detail-item">
                    <strong>Protocolo COMAER:</strong>
                    <p class="detail-value">{{ patd.protocolo_comaer|default:"Não informado" }}</p>
                </div>
                 <div class="detail-item">
                    <strong>Ofício da Transgressão:</strong>
                    <p class="detail-value">{{ patd.oficio_transgressao|default:"Não informado" }}</p>
                </div>
                <div class="detail-item full-width">
                    <strong>Descrição da Transgressão:</strong>
                    <p>{{ patd.transgressao|linebreaks }}</p>
                </div>
                 {% if patd.alegacao_defesa %}
                <div class="detail-item full-width">
                    <strong>Alegação de Defesa:</strong>
                    <p>{{ patd.alegacao_defesa|linebreaks }}</p>
                </div>
                {% endif %}
                 <div class="detail-item">
                    <strong>Status:</strong>
                    <p id="patd-status" class="detail-value">{{ patd.get_status_display }}</p>
                </div>
                {% if patd.boletim_publicacao %}
                 <div class="detail-item">
                    <strong>Publicado no Boletim:</strong>
                    <p class="detail-value">{{ patd.boletim_publicacao }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if historico_punicoes %}
    <div class="card">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px;"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
            <h2>Histórico Disciplinar do Militar</h2>
        </div>
        <div class="card-body">
            <ul class="historico-list">
                {% for punicao in historico_punicoes %}
                    <li class="historico-item">
                        <strong>PATD Nº <a href="{% url 'Ouvidoria:patd_detail' punicao.pk %}">{{ punicao.numero_patd }}</a> ({{ punicao.data }})</strong>
                        <span>Punição: {{ punicao.punicao }}</span>
                        <span>Itens: {{ punicao.itens|default:"Não especificado" }}</span>
                        {% if punicao.circunstancias.atenuantes %}
                        <span>Atenuantes: {{ punicao.circunstancias.atenuantes|join:", " }}</span>
                        {% endif %}
                        {% if punicao.circunstancias.agravantes %}
                        <span>Agravantes: {{ punicao.circunstancias.agravantes|join:", " }}</span>
                        {% endif %}
                    </li>
                {% empty %}
                    <p>Nenhuma punição anterior encontrada.</p>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <div class="card">
         <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 001.13-1.897M16.5 7.5V18L18 15.75l-1.5-3.75V7.5z" /></svg>
            <h2>Envolvidos e Assinaturas</h2>
        </div>
        <div class="card-body">
             <div class="detail-grid">
                  <div class="detail-item full-width">
                    <strong>Oficial Responsável:</strong>
                     <div class="oficial-container">
                         <div class="detail-value">
                            {% if patd.status == 'definicao_oficial' %}
                                <a href="{% url 'Ouvidoria:atribuir_oficial' patd.pk %}" class="btn btn-sm btn-primary">Atribuir Oficial</a>
                            {% elif patd.status == 'aguardando_aprovacao_atribuicao' %}
                                Aguardando aceite de: <strong>{{ patd.oficial_responsavel }}</strong>
                                {% if user.profile.militar == patd.oficial_responsavel %}
                                     <button type="button" class="btn btn-sm btn-success" id="btn-aceitar-atribuicao-modal">Aceitar Atribuição</button>
                                {% endif %}
                            {% else %}
                                {{ patd.oficial_responsavel|default:"Não definido" }}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="detail-item">
                    <strong>1ª Testemunha:</strong>
                    <div class="detail-value">{{ patd.testemunha1|default:"Não atribuída" }}</div>
                </div>
                 <div class="detail-item">
                    <strong>2ª Testemunha:</strong>
                    <div class="detail-value">{{ patd.testemunha2|default:"Não atribuída" }}</div>
                </div>

             </div>
        </div>
    </div>

    <div class="card" id="anexos-card-geral" style="display: none;">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81-2.122-2.122z" /></svg>
            <h2>Anexos do Processo</h2>
        </div>
        <div class="card-body">
            <div id="anexos-defesa-container-geral" style="display: none; margin-bottom: 20px;">
                <h4>Anexos da Alegação de Defesa</h4>
                <ul id="anexos-defesa-list-geral"></ul>
            </div>
            <div id="anexos-reconsideracao-container-geral" style="display: none;">
                <h4>Anexos da Reconsideração</h4>
                <ul id="anexos-reconsideracao-list-geral"></ul>
            </div>
             <div id="anexos-reconsideracao-oficial-container-geral" style="display: none;">
                <h4>Anexo do Oficial (Reconsideração)</h4>
                <ul id="anexos-reconsideracao-oficial-list-geral"></ul>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h2>Ficha Individual</h2>
        </div>
        <div class="card-body">
            <form action="{% url 'Ouvidoria:upload_ficha_individual' patd.pk %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-item">
                    <label for="ficha_individual_file">Anexar Ficha Individual (PDF):</label>
                    <input type="file" name="ficha_individual" id="ficha_individual_file" accept=".pdf" required style="width: 100%; padding: 10px;">
                </div>
                <div class="form-actions" style="justify-content: flex-start; margin-top: 15px;">
                    <button type="submit" class="btn btn-primary">Anexar</button>
                </div>
            </form>
        </div>
    </div>

     {% if request.user.profile.militar == patd.oficial_responsavel and patd.status in 'em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar' %}
    <div class="card" id="analise-disciplinar-card">
        <div class="card-header">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-1.5 5.25H12" /></svg>
             <h2>Análise Disciplinar</h2>
        </div>
        <div class="card-body">
            <div id="analise-actions">
                <button class="btn btn-primary" id="btn-apurar">
                    <span class="spinner"></span>
                    <span class="btn-text">Visualizar Apuração</span>
                </button>
            </div>
             <form id="apuracao-form" class="model-form" style="display: none;">
                <h3>Resultado da Apuração (Editável)</h3>

                <div class="form-grid">
                    <div class="form-item-full">
                        <label for="itens_enquadrados">Itens Enquadrados:</label>
                        <textarea id="itens_enquadrados" name="itens_enquadrados" rows="4"></textarea>
                    </div>
                    <div>
                        <label for="atenuantes">Atenuantes:</label>
                        <input type="text" id="atenuantes" name="atenuantes">
                    </div>
                    <div>
                        <label for="agravantes">Agravantes:</label>
                        <input type="text" id="agravantes" name="agravantes">
                    </div>
                    
                    <div class="form-item-full" style="display: grid; grid-template-columns: 120px 1fr; gap: 20px; align-items: flex-end;">
                         <div class"form-item">
                            <label for="id_punicao_dias">Dias:</label>
                            <input type="number" id="id_punicao_dias" name="punicao_dias" min="0" value="0">
                        </div>
                        <div class"form-item">
                            <label for="id_punicao_tipo">Tipo de Punição:</label>
                            <select id="id_punicao_tipo" name="punicao_tipo">
                                <option value="">Selecione...</option>
                                <option value="detenção">Detenção</option>
                                <option value="prisão">Prisão</option>
                                <option value="repreensão por escrito">Repreensão por escrito</option>
                                <option value="repreensão verbal">Repreensão verbal</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="punicao_sugerida_original_llm" style="display: none;"></textarea>
                    </div>
                <div class="form-actions">
                    <button type="button" id="btn-salvar-apuracao" class="btn btn-primary">
                        <span class="spinner" style="display: none;"></span>
                        Salvar Apuração e Concluir
                    </button>
                    <button type="button" id="btn-justificar-patd" class="btn btn-info">
                        Justificar Transgressão
                    </button>
                    <button type="button" id="btn-reanalisar-apuracao" class="btn btn-warning">
                        <span class="spinner" style="display: none;"></span>
                        Analisar Novamente
                    </button>
                    <button type="button" id="btn-cancelar-apuracao" class="btn btn-secondary">Ocultar</button>
                </div>
            </form>
        </div>
    </div>
    {% elif patd.mostrar_resumo_analise %}
    <div class="card" id="resumo-analise-card">
        <div class="card-header">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-1.5 5.25H12" /></svg>
             <h2>Resumo da Análise Disciplinar</h2>
        </div>
        <div class="card-body">
            <div class="detail-grid">
                <div class="detail-item full-width">
                    <strong>Itens Enquadrados:</strong>
                    {% if patd.itens_enquadrados %}
                        <ul>
                        {% for item in patd.itens_enquadrados %}
                            <li>{{ item.numero }}: {{ item.descricao }}</li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p class="detail-value">Não definidos.</p>
                    {% endif %}
                </div>
                <div class="detail-item">
                    <strong>Atenuantes:</strong>
                    <p class="detail-value">{{ patd.circunstancias.atenuantes|join:", "|default:"Nenhuma" }}</p>
                </div>
                <div class="detail-item">
                    <strong>Agravantes:</strong>
                    <p class="detail-value">{{ patd.circunstancias.agravantes|join:", "|default:"Nenhuma" }}</p>
                </div>
                <div class="detail-item full-width">
                    <strong>Punição Sugerida/Aplicada:</strong>
                    <p class="detail-value">
                        {% if patd.justificado %}
                            Transgressão Justificada
                        {% elif patd.punicao %}
                            {% if patd.dias_punicao %}
                                {{ patd.dias_punicao }} de {{ patd.punicao }}
                            {% else %}
                                {{ patd.punicao }}
                            {% endif %}
                        {% else %}
                            {{ patd.punicao_sugerida|default:"Ainda não definida" }}
                        {% endif %}
                    </p>
                </div>
                <div class="detail-item">
                    <strong>Natureza da Transgressão:</strong>
                    <p class="detail-value">{{ patd.natureza_transgressao|default:"Não definida" }}</p>
                </div>
                 <div class="detail-item">
                    <strong>Comportamento Resultante:</strong>
                    <p class="detail-value">{{ patd.comportamento }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<div id="tab-visualizador" class="tab-panel">
    <!-- INÍCIO: Botão de Navegação de Assinatura -->
    <div id="signature-nav-button" title="Ir para a próxima assinatura pendente">
        <span id="signature-counter">0/0</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" />
        </svg>
    </div>
    <!-- FIM: Botão de Navegação de Assinatura -->

    <div id="document-preview-container" class="document-preview-container">
        </div>
</div>

<style>
    /* Aumenta a área de assinatura para mesas digitalizadoras */
    #signature-modal-generic .modal-content {
        max-width: 800px; /* Aumenta a largura do modal */
    }
    #signature-canvas-generic {
        height: 400px; /* Aumenta a altura do canvas */
        width: 100%;
    }
</style>

<style>
    @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); } 50% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); } }
    .signature-focus { animation: pulse-border 1.5s ease-out; border-radius: 8px; }
</style>

<div class="modal-overlay" id="delete-modal">
    <div class="modal-content">
        <h3>Confirmar Exclusão</h3>
        <p>Tem a certeza de que deseja excluir a PATD Nº {{ patd.numero_patd }}? Esta ação não pode ser desfeita.</p>
        <form method="post" action="{% url 'Ouvidoria:patd_delete' patd.pk %}" style="display: inline;">
            {% csrf_token %}
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-delete-btn">Cancelar</button>
                <button type="submit" class="btn btn-delete">Sim, Excluir</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="avancar-modal">
    <div class="modal-content">
        <h3>Avançar Processo</h3>
        <p>Tem certeza? Esta PATD vai para análise do comandante. Já revisou tudo?</p>
        <form id="avancar-form" method="post" action="{% url 'Ouvidoria:avancar_para_comandante' patd.pk %}" style="display: inline;">
            {% csrf_token %}
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-avancar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Continuar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="signature-modal-generic">
    <div class="modal-content">
        <h3 id="signature-modal-title">Assinatura</h3>
        <p id="signature-modal-prompt">Desenhe a assinatura no campo abaixo.</p>
        <div class="canvas-container"><canvas id="signature-canvas-generic"></canvas></div>
        <div class="form-actions" style="justify-content: flex-end;">
            <input type="file" id="signature-file-input" accept="image/*" style="display: none;">
            <button type="button" class="btn btn-secondary" id="import-signature-btn">Importar Assinatura</button>
            <button type="button" class="btn btn-secondary" id="paste-signature-btn">Colar da Área de Transferência</button>
            <button type="button" class="btn btn-secondary" id="clear-signature-btn-generic">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn-generic">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn-generic">Salvar Assinatura</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="defesa-modal">
    <div class="modal-content">
        <h3>Alegação de Defesa</h3>
        <form id="form-alegacao-defesa" enctype="multipart/form-data">
            <p>Escreva abaixo a sua alegação de defesa e/ou anexe ficheiros de suporte.</p>
            <textarea name="alegacao_defesa" id="alegacao-defesa-texto" style="width: 100%; min-height: 150px;"></textarea>

            <div class="form-item" style="margin-top: 15px;">
                <label for="anexos_defesa">Anexar Ficheiros:</label>
                <input type="file" name="anexos_defesa" id="anexos_defesa" multiple style="width: 100%; padding: 10px;">
            </div>

            <div class="form-actions" style="justify-content: flex-end; margin-top: 15px;">
                <button type="button" class="btn btn-secondary" id="cancel-defesa-btn">Cancelar</button>
                <button type="button" class="btn btn-primary" id="submit-defesa-btn">Concluir</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="confirm-defesa-modal">
    <div class="modal-content">
        <h3>Confirmar Envio</h3>
        <p>Tem a certeza de que deseja enviar a sua alegação de defesa? Esta ação é final e não poderá ser alterada.</p>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-confirm-defesa-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="final-submit-defesa-btn">Sim, Enviar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="extender-prazo-modal">
    <div class="modal-content">
        <h3>Extender Prazo de Defesa</h3>
        <p>Defina o novo prazo para a entrega da alegação de defesa a contar de agora.</p>
        <form id="extender-prazo-form" class="model-form">
            <div class="form-grid" style="grid-template-columns: 1fr {% if user.is_superuser %}1fr{% endif %}; gap: 15px;">
                <p><label for="extender-dias">Dias:</label><input type="number" id="extender-dias" value="{{ prazo_defesa_dias }}" min="0"></p>
                {% if user.is_superuser %}
                <p><label for="extender-minutos">Minutos:</label><input type="number" id="extender-minutos" value="{{ prazo_defesa_minutos }}" min="0"></p>
                {% endif %}
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-extender-prazo-btn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Confirmar Extensão</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="aceitar-atribuicao-modal">
    <div class="modal-content">
        <h3>Aceitar Atribuição</h3>
        <p>Para confirmar que aceita ser o oficial responsável por esta PATD, por favor, insira a sua senha.</p>
        <form id="aceitar-atribuicao-form" method="post" action="{% url 'Ouvidoria:aceitar_atribuicao' patd.pk %}" class="model-form">
            {% csrf_token %}
            <div class="form-grid">
                <p>
                    <label for="id_senha_aceite">Sua Senha:</label>
                    <input type="password" name="senha" required id="id_senha_aceite">
                </p>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-aceitar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Confirmar e Aceitar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="reconsideracao-modal">
    <div class="modal-content">
        <h3>Confirmar Reconsideração</h3>
        <p>Tem certeza de que deseja iniciar o processo de reconsideração para esta PATD? Um novo documento será adicionado para edição.</p>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-reconsideracao-btn">Cancelar</button>
            <button type="button" class="btn btn-warning" id="confirm-reconsideracao-btn">Sim, Solicitar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="reconsideracao-texto-modal">
    <div class="modal-content">
        <h3>Texto de Reconsideração</h3>
        <form id="form-reconsideracao" enctype="multipart/form-data">
            <p>Escreva abaixo o texto do pedido de reconsideração e/ou anexe ficheiros de suporte.</p>
            <textarea name="texto_reconsideracao" id="reconsideracao-texto-input" style="width: 100%; min-height: 150px;"></textarea>

            <div class="form-item" style="margin-top: 15px;">
                <label for="anexos_reconsideracao">Anexar Ficheiros:</label>
                <input type="file" name="anexos_reconsideracao" id="anexos_reconsideracao" multiple style="width: 100%; padding: 10px;">
            </div>

            <div class="form-actions" style="justify-content: flex-end; margin-top: 15px;">
                <button type="button" class="btn btn-secondary" id="cancel-reconsideracao-texto-btn">Cancelar</button>
                <button type="button" class="btn btn-primary" id="submit-reconsideracao-texto-btn">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="retornar-patd-modal">
    <div class="modal-content">
        <h3 id="retornar-modal-title">Retornar PATD</h3>
        <p>Por favor, insira abaixo o motivo para retornar esta PATD para alteração. O oficial apurador será notificado com sua observação.</p>
        <form id="retornar-patd-form" method="post" action="" class="model-form">
            {% csrf_token %}
            <div class="form-item">
                <label for="id_comentario_detalhe">Comentário:</label>
                <textarea name="comentario" required id="id_comentario_detalhe" rows="5" style="width: 100%;"></textarea>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-retornar-btn">Cancelar</button>
                <button type="submit" class="btn btn-warning">Confirmar Retorno</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="aprovar-patd-modal">
    <div class="modal-content">
        <h3 id="aprovar-modal-title">Aprovar PATD</h3>
        <p>Para confirmar a aprovação desta PATD e aplicar sua assinatura digital, por favor, insira sua senha.</p>
        <form id="aprovar-patd-form" method="post" action="" class="model-form">
            {% csrf_token %}
            <div class="form-item">
                <label for="id_senha_comandante">Sua Senha:</label>
                <input type="password" name="senha_comandante" required id="id_senha_comandante" autocomplete="current-password">
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-aprovar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Confirmar Aprovação</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="finalizar-publicacao-modal">
    <div class="modal-content">
        <h3>Finalizar Processo</h3>
        <p>Insira o número do boletim em que a decisão desta PATD foi publicada para finalizar o processo.</p>
        <form id="finalizar-publicacao-form" method="post" action="{% url 'Ouvidoria:finalizar_publicacao' patd.pk %}" class="model-form">
            {% csrf_token %}
            <div class="form-item">
                <label for="id_boletim_publicacao">Número do Boletim:</label>
                <input type="text" name="boletim_publicacao" required id="id_boletim_publicacao" placeholder="Ex: BCA Nº 123 - 25/12/2025">
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" id="cancel-finalizar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Finalizar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="nova-punicao-modal">
    <div class="modal-content">
        <h3>Definir Nova Punição Pós-Reconsideração</h3>
        <p>Insira os detalhes da nova punição que será aplicada.</p>
        <form id="form-nova-punicao" class="model-form">
            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                <p>
                    <label for="nova-punicao-dias-input">Dias de Punição:</label>
                    <input type="number" id="nova-punicao-dias-input" min="0" required>
                </p>
                <p>
                    <label for="nova-punicao-tipo-input">Tipo de Punição:</label>
                    <select id="nova-punicao-tipo-input" required>
                        <option value="detenção">Detenção</option>
                        <option value="prisão">Prisão</option>
                        <option value="repreensão">Repreensão</option>
                    </select>
                </p>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-nova-punicao-btn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Nova Punição</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{# Removidos os json_script dos mapeamentos daqui #}

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
// Dados da análise pré-carregados pelo Django
const analiseData = {{ analise_data_json|default:'null'|safe }};
const assinaturasMilitar = {{ assinaturas_militar_json|default:'[]'|safe }};
let documentPages = {{ documento_texto_json|default:'[]'|safe }};
const isSuperuser = {{ request.user.is_superuser|yesno:"true,false" }};

function createSignatureHtml(signatureUrl, altText, signatureType, signatureIndex) {
    let html = `<img class="signature-image-embedded" src="${signatureUrl}" alt="${altText}">`;
    if (isSuperuser) {
        html += ` <button class="btn btn-sm btn-danger remove-signature-btn" data-signature-type="${signatureType}"`;
        if (signatureIndex !== undefined) {
            html += ` data-signature-index="${signatureIndex}"`;
        }
        html += ` title="Remover assinatura">(Remover)</button>`;
    }
    return html;
}

// Dados das assinaturas específicas
const hasDefesaSig = '{{ patd.assinatura_alegacao_defesa|yesno:"true,false" }}' === 'true';
const defesaSigData = '{% if patd.assinatura_alegacao_defesa.name %}{{ patd.assinatura_alegacao_defesa.url }}{% endif %}';
const hasReconSig = '{{ patd.assinatura_reconsideracao|yesno:"true,false" }}' === 'true';
const reconSigData = '{% if patd.assinatura_reconsideracao.name %}{{ patd.assinatura_reconsideracao.url }}{% endif %}';
const testemunha1SigData = '{% if patd.assinatura_testemunha1.name %}{{ patd.assinatura_testemunha1.url }}{% endif %}';
const testemunha2SigData = '{% if patd.assinatura_testemunha2.name %}{{ patd.assinatura_testemunha2.url }}{% endif %}';
const oficialSigData = '{% if patd.assinatura_oficial.name %}{{ patd.assinatura_oficial.url }}{% endif %}';
const comandanteSigData = '{{ comandante_assinatura|default:"" }}';

// --- MODIFICAÇÃO: anexosDefesa, anexosReconsideracao, etc, agora contêm 'tipo_arquivo' e não 'content_html' ---
let anexosDefesa = {{ anexos_defesa_json|default:'[]'|safe }};
let anexosReconsideracao = {{ anexos_reconsideracao_json|default:'[]'|safe }};
let anexosReconsideracaoOficial = {{ anexos_reconsideracao_oficial_json|default:'[]'|safe }};


let signatureIndex = 0; // Contador de assinaturas movido para o escopo externo

document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let isExpired = `{{ patd.status }}` === 'prazo_expirado';

    const deleteBtn = document.getElementById('delete-patd-btn');
    const deleteModal = document.getElementById('delete-modal');
    if (deleteBtn && deleteModal) {
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        deleteBtn.addEventListener('click', () => deleteModal.classList.add('active'));
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('active'));
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) deleteModal.classList.remove('active');
        });
    }

    // --- LÓGICA DO MODAL GENÉRICO DE ASSINATURA ---
    const signatureModal = document.getElementById('signature-modal-generic');
    if (signatureModal) {
        const canvas = document.getElementById('signature-canvas-generic');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
        let currentSignatureConfig = {};

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const parentWidth = canvas.parentElement.offsetWidth;
            canvas.width = parentWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }

        document.body.addEventListener('click', function(e) {
            const btn = e.target.closest('.open-signature-modal');
            if (btn) {
                const type = btn.dataset.type;
                currentSignatureConfig = { type };

                const modalTitle = signatureModal.querySelector('#signature-modal-title');
                const modalParagraph = signatureModal.querySelector('#signature-modal-prompt');

                if (type === 'ciencia') {
                    currentSignatureConfig.index = parseInt(btn.dataset.index, 10);
                    modalTitle.textContent = 'Registrar Ciência da Acusação';
                    modalParagraph.textContent = `Eu, {{ patd.militar }}, declaro ter ciência dos fatos a mim imputados (Assinatura ${currentSignatureConfig.index + 1}).`;
                } else if (type === 'defesa') {
                    modalTitle.textContent = 'Assinar Alegação de Defesa';
                    modalParagraph.textContent = 'Confirmo que esta é a minha alegação de defesa.';
                } else if (type === 'reconsideracao') {
                    modalTitle.textContent = 'Assinar Pedido de Reconsideração';
                    modalParagraph.textContent = 'Confirmo que este é o meu pedido de reconsideração.';
                } else if (type === 'oficial') {
                    modalTitle.textContent = 'Assinatura do Oficial Apurador';
                    modalParagraph.textContent = 'Desenhe a assinatura no campo abaixo.';
                } else if (type === 'testemunha') {
                    currentSignatureConfig.num = btn.dataset.testemunhaNum;
                    modalTitle.textContent = `Assinatura da ${currentSignatureConfig.num}ª Testemunha`;
                    modalParagraph.textContent = 'A testemunha deve desenhar a assinatura no campo abaixo.';
                }

                signatureModal.classList.add('active');
                resizeCanvas();
            }
        });

        document.getElementById('cancel-signature-btn-generic').addEventListener('click', () => signatureModal.classList.remove('active'));
        document.getElementById('clear-signature-btn-generic').addEventListener('click', () => signaturePad.clear());
        document.getElementById('save-signature-btn-generic').addEventListener('click', () => {
            if (signaturePad.isEmpty()) {
                alert("Por favor, forneça a assinatura.");
                return;
            }
            let url, body;
            const signatureData = signaturePad.toDataURL('image/png');

            switch (currentSignatureConfig.type) {
                case 'ciencia':
                    url = `{% url 'Ouvidoria:salvar_assinatura_ciencia' patd.pk %}`;
                    body = JSON.stringify({ signature_data: signatureData, assinatura_index: currentSignatureConfig.index });
                    break;
                case 'defesa':
                    url = `{% url 'Ouvidoria:salvar_assinatura_defesa' patd.pk %}`;
                    body = JSON.stringify({ signature_data: signatureData });
                    break;
                case 'reconsideracao':
                    url = `{% url 'Ouvidoria:salvar_assinatura_reconsideracao' patd.pk %}`;
                    body = JSON.stringify({ signature_data: signatureData });
                    break;
                 case 'oficial':
                    url = `{% url 'Ouvidoria:salvar_assinatura' patd.pk %}`;
                    body = JSON.stringify({ signature_data: signatureData });
                    break;
                case 'testemunha':
                    url = `/Ouvidoria/patd/{{ patd.pk }}/salvar_assinatura_testemunha/${currentSignatureConfig.num}/`;
                    body = JSON.stringify({ signature_data: signatureData });
                    break;
                default:
                    return;
            }

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: body
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });

        // --- INÍCIO: Lógica para importar e colar assinatura ---
        const importSignatureBtn = document.getElementById('import-signature-btn');
        const pasteSignatureBtn = document.getElementById('paste-signature-btn');
        const signatureFileInput = document.getElementById('signature-file-input');

        if (importSignatureBtn && signatureFileInput) {
            importSignatureBtn.addEventListener('click', () => {
                signatureFileInput.click();
            });

            signatureFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        signaturePad.fromDataURL(e.target.result, {
                            width: canvas.width,
                            height: canvas.height
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Por favor, selecione um ficheiro de imagem válido.');
                }
                // Limpa o valor para permitir selecionar o mesmo ficheiro novamente
                signatureFileInput.value = '';
            });
        }

        if (pasteSignatureBtn) {
            pasteSignatureBtn.addEventListener('click', async () => {
                try {
                    const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                    if (permission.state === 'denied') {
                        throw new Error('A permissão para aceder à área de transferência foi negada.');
                    }

                    const clipboardItems = await navigator.clipboard.read();
                    const imageItem = clipboardItems.find(item => item.types.some(type => type.startsWith('image/')));

                    if (imageItem) {
                        const imageType = imageItem.types.find(type => type.startsWith('image/'));
                        const blob = await imageItem.getType(imageType);
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            signaturePad.fromDataURL(e.target.result, {
                                width: canvas.width,
                                height: canvas.height
                            });
                        };
                        reader.readAsDataURL(blob);
                    } else {
                        alert('Nenhuma imagem encontrada na área de transferência. Por favor, copie uma imagem primeiro.');
                    }
                } catch (error) {
                    console.error('Erro ao colar da área de transferência:', error);
                    alert('Não foi possível colar a imagem. Verifique as permissões da área de transferência do seu navegador ou tente usar um navegador compatível. ' + error.message);
                }
            });
        }
        // --- FIM: Lógica para importar e colar assinatura ---
    }

    const aceitarAtribuicaoModal = document.getElementById('aceitar-atribuicao-modal');
    if (aceitarAtribuicaoModal) {
        const openBtn = document.getElementById('btn-aceitar-atribuicao-modal');
        const cancelBtn = document.getElementById('cancel-aceitar-btn');
        if(openBtn) {
            openBtn.addEventListener('click', () => aceitarAtribuicaoModal.classList.add('active'));
        }
        if(cancelBtn) cancelBtn.addEventListener('click', () => aceitarAtribuicaoModal.classList.remove('active'));
        aceitarAtribuicaoModal.addEventListener('click', e => {
            if (e.target === aceitarAtribuicaoModal) aceitarAtribuicaoModal.classList.remove('active');
        });
    }

    // *******************************************************************
    // *** INÍCIO DO CÓDIGO ADICIONADO PARA CORREÇÃO ***
    // *******************************************************************

    // --- LÓGICA DO MODAL DE AVANÇAR PARA COMANDANTE ---
    const avancarModal = document.getElementById('avancar-modal');
    if (avancarModal) {
        const openBtn = document.getElementById('btn-avancar-comandante');
        const cancelBtn = document.getElementById('cancel-avancar-btn');
        if(openBtn) {
            openBtn.addEventListener('click', () => avancarModal.classList.add('active'));
        }
        if(cancelBtn) {
            cancelBtn.addEventListener('click', () => avancarModal.classList.remove('active'));
        }
        avancarModal.addEventListener('click', e => {
            if (e.target === avancarModal) avancarModal.classList.remove('active');
        });
        
        // Tratar alerta de erro vindo da view (query param)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('erro') && urlParams.get('erro') === 'testemunhas') {
            alert('Erro: Não é possível avançar. As duas testemunhas devem ser definidas na aba "Editar".');
            // Limpa o parâmetro da URL para não mostrar o alerta ao recarregar
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }

    // --- LÓGICA DO MODAL DE RETORNAR PATD (COMANDANTE) ---
    const retornarModal = document.getElementById('retornar-patd-modal');
    if (retornarModal) {
        const cancelBtn = document.getElementById('cancel-retornar-btn');
        if(cancelBtn) {
            cancelBtn.addEventListener('click', () => retornarModal.classList.remove('active'));
        }
        retornarModal.addEventListener('click', e => {
            if (e.target === retornarModal) retornarModal.classList.remove('active');
        });
        
        document.body.addEventListener('click', function(e) {
            const target = e.target.closest('.open-retornar-modal-btn');
            if (target) {
                const patdPk = target.dataset.patdPk;
                const patdNumero = target.dataset.patdNumero;
                const form = document.getElementById('retornar-patd-form');
                const title = document.getElementById('retornar-modal-title');
                
                if (form && title) {
                    form.action = `/Ouvidoria/patd/${patdPk}/retornar/`;
                    title.textContent = `Retornar PATD Nº ${patdNumero}`;
                    retornarModal.classList.add('active');
                }
            }
        });
    }

    // --- LÓGICA DOS MODAIS DE RECONSIDERAÇÃO ---
    const reconsideracaoModal = document.getElementById('reconsideracao-modal');
    const reconsideracaoTextoModal = document.getElementById('reconsideracao-texto-modal');

    if (reconsideracaoModal && reconsideracaoTextoModal) {
        const openBtn = document.getElementById('btn-reconsideracao-modal');
        const cancelBtn = document.getElementById('cancel-reconsideracao-btn');
        const confirmBtn = document.getElementById('confirm-reconsideracao-btn');
        
        const cancelTextoBtn = document.getElementById('cancel-reconsideracao-texto-btn');
        const submitTextoBtn = document.getElementById('submit-reconsideracao-texto-btn');

        // Modal 1: Confirmação
        if(openBtn) {
            openBtn.addEventListener('click', () => reconsideracaoModal.classList.add('active'));
        }
        if(cancelBtn) {
            cancelBtn.addEventListener('click', () => reconsideracaoModal.classList.remove('active'));
        }
        if(confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                const url = `{% url 'Ouvidoria:solicitar_reconsideracao' patd.pk %}`;
                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        reconsideracaoModal.classList.remove('active');
                        reconsideracaoTextoModal.classList.add('active');
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => console.error('Erro:', error));
            });
        }

        // Modal 2: Texto e Anexos
        if(cancelTextoBtn) {
            cancelTextoBtn.addEventListener('click', () => reconsideracaoTextoModal.classList.remove('active'));
        }

        // Listener para o botão de dentro do documento
        document.body.addEventListener('click', e => {
            if (e.target && e.target.id === 'add-reconsideracao-texto-btn-doc') {
                reconsideracaoTextoModal.classList.add('active');
            }
        });
        
        if(submitTextoBtn) {
            submitTextoBtn.addEventListener('click', () => {
                const form = document.getElementById('form-reconsideracao');
                const formData = new FormData(form);
                const url = `{% url 'Ouvidoria:salvar_reconsideracao' patd.pk %}`;
                
                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => console.error('Erro:', error));
            });
        }
    }

    // *******************************************************************
    // *** FIM DO CÓDIGO ADICIONADO PARA CORREÇÃO ***
    // *******************************************************************


    const defesaModal = document.getElementById('defesa-modal');
    if (defesaModal) {
        const addDefesaBtn = document.getElementById('add-defesa-btn');
        const confirmDefesaModal = document.getElementById('confirm-defesa-modal');
        const cancelDefesaBtn = document.getElementById('cancel-defesa-btn');
        const submitDefesaBtn = document.getElementById('submit-defesa-btn');
        const cancelConfirmDefesaBtn = document.getElementById('cancel-confirm-defesa-btn');
        const finalSubmitDefesaBtn = document.getElementById('final-submit-defesa-btn');
        const formDefesa = document.getElementById('form-alegacao-defesa');

        function openDefesaModal() {
            defesaModal.classList.add('active');
        }

        if (addDefesaBtn) addDefesaBtn.addEventListener('click', openDefesaModal);
        document.body.addEventListener('click', e => {
            if (e.target && e.target.id === 'add-defesa-btn-doc') openDefesaModal();
        });

        if(cancelDefesaBtn) cancelDefesaBtn.addEventListener('click', () => defesaModal.classList.remove('active'));
        if(submitDefesaBtn) submitDefesaBtn.addEventListener('click', () => {
             const alegacaoText = document.getElementById('alegacao-defesa-texto').value;
             const anexosInput = document.getElementById('anexos_defesa');
             if (alegacaoText.trim() === "" && anexosInput.files.length === 0) {
                 alert("É necessário fornecer um texto ou anexar pelo menos um ficheiro.");
                 return;
             }
            defesaModal.classList.remove('active');
            if(confirmDefesaModal) confirmDefesaModal.classList.add('active');
        });

        if(cancelConfirmDefesaBtn) cancelConfirmDefesaBtn.addEventListener('click', () => confirmDefesaModal.classList.remove('active'));

        if(finalSubmitDefesaBtn) finalSubmitDefesaBtn.addEventListener('click', () => {
            const formData = new FormData(formDefesa);
            const url = `{% url 'Ouvidoria:salvar_alegacao_defesa' patd.pk %}`;

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }

    const extenderPrazoModal = document.getElementById('extender-prazo-modal');
    const extenderPrazoBtn = document.getElementById('extender-prazo-btn');
    const prosseguirBtn = document.getElementById('prosseguir-sem-defesa-btn');
    function handleProsseguirSemAlegacao() {
        if (confirm('Tem certeza que deseja prosseguir sem a alegação de defesa? Esta ação registrará a preclusão e não poderá ser desfeita.')) {
            const url = `{% url 'Ouvidoria:prosseguir_sem_alegacao' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        }
    }
    if (extenderPrazoBtn) {
        extenderPrazoBtn.addEventListener('click', () => extenderPrazoModal.classList.add('active'));
    }
    if (prosseguirBtn) {
        prosseguirBtn.addEventListener('click', handleProsseguirSemAlegacao);
    }
    if (extenderPrazoModal) {
        const cancelExtenderBtn = document.getElementById('cancel-extender-prazo-btn');
        if(cancelExtenderBtn) cancelExtenderBtn.addEventListener('click', () => extenderPrazoModal.classList.remove('active'));

        const extenderForm = document.getElementById('extender-prazo-form');
        if(extenderForm) extenderForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const dias = document.getElementById('extender-dias').value;
            const minutosInput = document.getElementById('extender-minutos');
            const minutos = minutosInput ? minutosInput.value : 0;
            const url = `{% url 'Ouvidoria:extender_prazo' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'dias': dias, 'minutos': minutos })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }
    const countdownTimer = document.getElementById('countdown-timer');
    const prazoBox = document.getElementById('prazo-box');
    if (countdownTimer && '{{ patd.data_ciencia }}') {
        const dataCiencia = new Date('{{ patd.data_ciencia|date:"c" }}');
        const prazoDias = parseInt('{{ prazo_defesa_dias }}', 10) || 0;

        function addBusinessDays(startDate, days) {
            let currentDate = new Date(startDate);
            let addedDays = 0;
            while (addedDays < days) {
                currentDate.setDate(currentDate.getDate() + 1);
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    addedDays++;
                }
            }
            return currentDate;
        }
        let deadlineDate = addBusinessDays(dataCiencia, prazoDias);
        let deadline = new Date(deadlineDate.getFullYear(), deadlineDate.getMonth(), deadlineDate.getDate() + 1);

        const interval = setInterval(() => {
            const now = new Date();
            const diff = deadline - now;
            if (diff <= 0) {
                countdownTimer.textContent = "Prazo expirado.";
                if(prazoBox) prazoBox.classList.add('expirado');
                clearInterval(interval);
                if (!isExpired) {
                    isExpired = true;
                    showExpiredButtons();
                }
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            countdownTimer.textContent = `${d}d ${h}h ${m}m ${s}s`;
        }, 1000);
    }

    // --- INÍCIO DA NOVA LÓGICA PARA O TIMER DE RECONSIDERAÇÃO ---
    const reconsideracaoCountdownTimer = document.getElementById('reconsideracao-countdown-timer');
    const reconsideracaoPrazoBox = document.getElementById('reconsideracao-prazo-box');
    if (reconsideracaoCountdownTimer && '{{ patd.data_publicacao_punicao }}') {
        const dataPublicacao = new Date('{{ patd.data_publicacao_punicao|date:"c" }}');
        const prazoDias = 15; // O prazo de reconsideração é fixo em 15 dias corridos.
        const deadline = new Date(dataPublicacao.getTime() + prazoDias * 24 * 60 * 60 * 1000);

        const interval = setInterval(() => {
            const now = new Date();
            const diff = deadline - now;

            if (diff <= 0) {
                reconsideracaoCountdownTimer.textContent = "Prazo expirado.";
                if(reconsideracaoPrazoBox) reconsideracaoPrazoBox.classList.add('expirado');
                clearInterval(interval);
                // Opcional: Atualizar status da PATD via AJAX se o prazo expirou
                fetch('{% url "Ouvidoria:verificar_e_atualizar_prazos" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({}) // Corpo vazio, pois a função no servidor verifica todas as PATDs
                });
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            reconsideracaoCountdownTimer.textContent = `${d}d ${h}h ${m}m ${s}s`;
        }, 1000);
    }
    function showExpiredButtons() {
        const actionsContainer = document.getElementById('form-actions-container');
        const addDefesaBtn = document.getElementById('add-defesa-btn');
        const statusElement = document.getElementById('patd-status');
        if (addDefesaBtn) addDefesaBtn.remove();
        if (statusElement) statusElement.textContent = "Prazo expirado";
        if (!document.getElementById('extender-prazo-btn')) {
            const extenderBtn = document.createElement('button');
            extenderBtn.type = 'button';
            extenderBtn.className = 'btn btn-warning';
            extenderBtn.id = 'extender-prazo-btn';
            extenderBtn.textContent = 'Extender Prazo';
            extenderBtn.addEventListener('click', () => extenderPrazoModal.classList.add('active'));
            actionsContainer.insertBefore(extenderBtn, actionsContainer.firstChild);
        }
        if (!document.getElementById('prosseguir-sem-defesa-btn')) {
            const prosseguirBtn = document.createElement('button');
            prosseguirBtn.type = 'button';
            prosseguirBtn.className = 'btn btn-danger';
            prosseguirBtn.id = 'prosseguir-sem-defesa-btn';
            prosseguirBtn.textContent = 'Prosseguir sem Alegação';
            prosseguirBtn.addEventListener('click', handleProsseguirSemAlegacao);
            const extenderBtn = document.getElementById('extender-prazo-btn');
            if (extenderBtn) extenderBtn.insertAdjacentElement('afterend', prosseguirBtn);
            else actionsContainer.insertBefore(prosseguirBtn, actionsContainer.firstChild);
        }
    }
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            tabLinks.forEach(l => l.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            link.classList.add('active');
            
            const targetPanel = document.getElementById(link.dataset.target);
            if (targetPanel) {
                 targetPanel.classList.add('active');

                // --- INÍCIO DA CORREÇÃO: Lógica de exibição do botão de navegação ---
                const sigNavButton = document.getElementById('signature-nav-button');
                if (link.dataset.target === 'tab-visualizador') {
                    renderVisualizador(); // A função renderVisualizador irá decidir se mostra o botão.
                } else {
                    // Se a aba NÃO for o visualizador, garante que o botão esteja oculto.
                    if (sigNavButton) sigNavButton.style.display = 'none';
                }
                // --- FIM DA CORREÇÃO ---
            }
            localStorage.setItem('activePatdTab-{{ patd.pk }}', link.dataset.target);
        });
    });

    // --- INÍCIO DA NOVA LÓGICA DE ANEXOS (MODIFICADA) ---

    /**
     * Gera o HTML para um único anexo embutido (link de download).
     */
    function generateEmbeddedAnexoHTML(anexo) {
        const fileType = anexo.tipo_arquivo;
        
        // --- ALTERAÇÃO: Tentar <iframe> para PDF/Imagens, fallback para link ---
        // (Revertido para link simples para máxima compatibilidade)
        return `
            <div class="embedded-anexo-item">
                <div class="embedded-anexo-link">
                    <h4>${anexo.nome}</h4>
                    <p>Anexo (.${fileType}). Clique abaixo para abrir ou baixar.</p>
                    <a href="${anexo.url}" class="btn-download" target="_blank" rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                        Abrir/Baixar Anexo
                    </a>
                </div>
            </div>
        `;
    }

    /**
     * Gera um contêiner de grupo para múltiplos anexos. (Modificado)
     */
    function generateEmbeddedAnexosGroup(anexos, title) {
        if (!anexos || anexos.length === 0) return '';
        let itemsHtml = anexos.map(generateEmbeddedAnexoHTML).join('');
        return `
            <div class="embedded-anexo-container">
                <h3 class="embedded-anexo-header">${title}</h3>
                ${itemsHtml}
            </div>
        `;
    }

    // --- FIM DA NOVA LÓGICA DE ANEXOS ---


    function processPlaceholders(text) {
        let processedHtml = text;
        
        processedHtml = processedHtml.replace(/{Botao Adicionar Alegacao}/g, `<button id="add-defesa-btn-doc" class="btn btn-sm btn-primary">Adicionar Alegação de Defesa</button>`);
        processedHtml = processedHtml.replace(/{Botao Adicionar Reconsideracao}/g, `<button id="add-reconsideracao-texto-btn-doc" class="btn btn-sm btn-primary">Adicionar Texto de Reconsideração</button>`);

        // --- MODIFICAÇÃO: Injeta o HTML do visualizador de anexo embutido ---
        processedHtml = processedHtml.replace(/{ANEXOS_DEFESA_PLACEHOLDER}/g, 
            generateEmbeddedAnexosGroup(anexosDefesa, "Anexos da Alegação de Defesa"));
        processedHtml = processedHtml.replace(/{ANEXOS_RECONSIDERACAO_PLACEHOLDER}/g, 
            generateEmbeddedAnexosGroup(anexosReconsideracao, "Anexos da Reconsideração"));
        processedHtml = processedHtml.replace(/{ANEXO_OFICIAL_RECONSIDERACAO_PLACEHOLDER}/g, 
            generateEmbeddedAnexosGroup(anexosReconsideracaoOficial, "Anexo do Oficial (Reconsideração)"));
        // --- FIM DA MODIFICAÇÃO ---

        // Assinaturas que podem ter imagem ou botão
        processedHtml = processedHtml.replace(/{Assinatura Alegacao Defesa}/g, hasDefesaSig ? createSignatureHtml(defesaSigData, 'Assinatura da Defesa', 'defesa') : `<button class="btn btn-sm btn-success open-signature-modal" data-type="defesa">Assinar Alegação de Defesa</button>`);
        processedHtml = processedHtml.replace(/{Assinatura Reconsideracao}/g, hasReconSig ? createSignatureHtml(reconSigData, 'Assinatura da Reconsideração', 'reconsideracao') : `<button class="btn btn-sm btn-success open-signature-modal" data-type="reconsideracao">Assinar Reconsideração</button>`);

        // Assinaturas que SEMPRE são imagens (se existirem)
        processedHtml = processedHtml.replace(/{Assinatura_Imagem_Oficial_Apurador}/g, oficialSigData ? createSignatureHtml(oficialSigData, 'Assinatura do Oficial Apurador', 'oficial') : '[Sem assinatura]');
        processedHtml = processedHtml.replace(/{Assinatura_Imagem_Comandante_GSD}/g, comandanteSigData ? `<img class="signature-image-embedded" src="${comandanteSigData}" alt="Assinatura do Comandante">` : '[Sem assinatura]');
        processedHtml = processedHtml.replace(/{Assinatura_Imagem_Testemunha_1}/g, testemunha1SigData ? createSignatureHtml(testemunha1SigData, 'Assinatura da Testemunha 1', 'testemunha1') : '[Sem assinatura]');
        processedHtml = processedHtml.replace(/{Assinatura_Imagem_Testemunha_2}/g, testemunha2SigData ? createSignatureHtml(testemunha2SigData, 'Assinatura da Testemunha 2', 'testemunha2') : '[Sem assinatura]');

        // Assinatura do militar (pode ser várias)
        processedHtml = processedHtml.replace(/{Assinatura Militar Arrolado}/g, () => {
            const index = signatureIndex++;
            if (assinaturasMilitar[index]) {
                return createSignatureHtml(assinaturasMilitar[index], `Assinatura ${index + 1}`, 'ciencia', index);
            } else {
                 return `<button class="btn btn-sm btn-success open-signature-modal" data-type="ciencia" data-index="${index}">Assinar</button>`;
            }
        });

        // Botões de assinatura restantes
        processedHtml = processedHtml.replace(/{Botao Assinar Oficial}/g, `<button class="btn btn-sm btn-success open-signature-modal" data-type="oficial">Assinar</button>`);
        processedHtml = processedHtml.replace(/{Botao Assinar Testemunha 1}/g, `<button class="btn btn-sm btn-success open-signature-modal" data-type="testemunha" data-testemunha-num="1">Assinar (Testemunha 1)</button>`);
        processedHtml = processedHtml.replace(/{Botao Assinar Testemunha 2}/g, `<button class="btn btn-sm btn-success open-signature-modal" data-type="testemunha" data-testemunha-num="2">Assinar (Testemunha 2)</button>`);


        // Formatação final
        processedHtml = processedHtml.replace(/\[Sem assinatura\]/g, '<span class="no-signature-text">[Sem assinatura]</span>');
        processedHtml = processedHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        return processedHtml;
    }

    // --- LÓGICA DO VISUALIZADOR DE DOCUMENTO ---
    const pageContainer = document.getElementById('document-preview-container');
    pageContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('editable-date')) {
            scheduleSave();
        }
    });
    pageContainer.addEventListener('input', function(e) {
        if (e.target.classList.contains('editable-text')) {
            scheduleSave();
        }
    });
    // --- INÍCIO: Lógica de navegação de assinatura ---
    let pendingSignatureElements = [];
    let currentSignatureIndex = -1;
    // --- FIM: Lógica de navegação de assinatura ---
    let saveTimeout;

    function scheduleSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveDocumentChanges();
        }, 1500);
    }

    function saveDocumentChanges() {
        if (!pageContainer) return;

        const dates = {};
        pageContainer.querySelectorAll('.editable-date').forEach(input => {
            const fieldName = input.dataset.dateField;
            if (fieldName) {
                dates[fieldName] = input.value;
            }
        });

        const texts = {};
        pageContainer.querySelectorAll('.editable-text').forEach(input => {
            const fieldName = input.dataset.textField;
            if (fieldName) {
                texts[fieldName] = input.value;
            }
        });

        const tempContainer = pageContainer.cloneNode(true);

        const datePlaceholders = {
            'data_ocorrencia': '{data da Ocorrencia}',
            'data_oficio': '{data_oficio}',
            'data_ciencia': '{data ciência}',
            'data_alegacao': '{Data da alegação}',
            'data_publicacao_punicao': '{data_publicacao_punicao}',
            'data_reconsideracao': '{Data_reconsideracao}',
        };

        tempContainer.querySelectorAll('.editable-date').forEach(input => {
            const fieldName = input.dataset.dateField;
            const placeholder = datePlaceholders[fieldName];
            if (placeholder) {
                input.replaceWith(document.createTextNode(placeholder));
            }
        });

        tempContainer.querySelectorAll('.editable-text').forEach(input => {
            const fieldName = input.dataset.textField;
            if (fieldName === 'localidade') {
                input.replaceWith(document.createTextNode('{Localidade}'));
            }
        });

        const signaturePlaceholders = {
            'Assinatura da Defesa': '{Assinatura Alegacao Defesa}',
            'Assinatura da Reconsideração': '{Assinatura Reconsideracao}',
            'Assinatura da Testemunha 1': '{Assinatura_Imagem_Testemunha_1}',
            'Assinatura da Testemunha 2': '{Assinatura_Imagem_Testemunha_2}',
            'Assinatura do Oficial Apurador': '{Assinatura_Imagem_Oficial_Apurador}',
            'Assinatura do Comandante': '{Assinatura_Imagem_Comandante_GSD}'
        };

        tempContainer.querySelectorAll('img.signature-image-embedded').forEach(img => {
            let alt = img.getAttribute('alt');
            let placeholder = signaturePlaceholders[alt] || '{Assinatura Militar Arrolado}';
            if (alt && alt.startsWith('Assinatura ')) {
                placeholder = '{Assinatura Militar Arrolado}';
            }
            img.replaceWith(document.createTextNode(placeholder));
        });

        tempContainer.querySelectorAll('button.open-signature-modal').forEach(btn => {
            const type = btn.dataset.type;
            let placeholder = '';
            if (type === 'ciencia') placeholder = '{Assinatura Militar Arrolado}';
            else if (type === 'defesa') placeholder = '{Assinatura Alegacao Defesa}';
            else if (type === 'reconsideracao') placeholder = '{Assinatura Reconsideracao}';
            else if (type === 'oficial') placeholder = '{Botao Assinar Oficial}';
            else if (type === 'testemunha') placeholder = `{Botao Assinar Testemunha ${btn.dataset.testemunhaNum}}`;
            btn.replaceWith(document.createTextNode(placeholder));
        });

        tempContainer.querySelectorAll('button#add-defesa-btn-doc').forEach(btn => btn.replaceWith(document.createTextNode('{Botao Adicionar Alegacao}')));
        tempContainer.querySelectorAll('button#add-reconsideracao-texto-btn-doc').forEach(btn => btn.replaceWith(document.createTextNode('{Botao Adicionar Reconsideracao}')));

        tempContainer.querySelectorAll('.embedded-anexo-container').forEach(container => {
            const header = container.querySelector('.embedded-anexo-header');
            let placeholder = '';
            if (header) {
                if (header.textContent.includes("Defesa")) placeholder = '{ANEXOS_DEFESA_PLACEHOLDER}';
                else if (header.textContent.includes("Reconsideração")) placeholder = '{ANEXOS_RECONSIDERACAO_PLACEHOLDER}';
                else if (header.textContent.includes("Oficial")) placeholder = '{ANEXO_OFICIAL_RECONSIDERACAO_PLACEHOLDER}';
            }
            container.replaceWith(document.createTextNode(placeholder));
        });


        const pageDelimiter = 'PATD Nº {{ patd.numero_patd }}/BAGL-GSDGL/{{ patd.data_inicio|date:"dmy" }}';
        let fullContent = [];

        tempContainer.querySelectorAll('.page .page-content').forEach(contentDiv => {
            let pageContent = [];
            contentDiv.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    pageContent.push(node.textContent.trim());
                } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'P') {
                    let cleanText = node.innerHTML.replace(/<br\s*\/?>/gi, '\n');
                    cleanText = cleanText.replace(/&nbsp;/g, ' ');
                    cleanText = cleanText.replace(/<strong>(.*?)<\/strong>/g, '**$1**');

                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = cleanText;
                    pageContent.push(tempDiv.textContent || tempDiv.innerText || '');
                }
            });
            fullContent.push(pageContent.join('\n'));
        });

        const newDocumentText = fullContent.join(`\n${pageDelimiter}\n`);
        rawDocumentText = newDocumentText;

        const url = `{% url 'Ouvidoria:salvar_documento_patd' patd.pk %}`;
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ 
                'texto_documento': newDocumentText,
                'dates': dates,
                'texts': texts
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                 console.log("Documento e datas salvos automaticamente.");
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error)
        });
    }

    // --- LÓGICA DE RENDERIZAR VISUALIZADOR (MODIFICADA) ---
    function renderVisualizador() {
        if (!pageContainer) return;
        pageContainer.innerHTML = ''; // Limpa o container
        signatureIndex = 0; // Reseta o contador de assinaturas do militar
        let pageCounter = 1; // Zera o contador de página

        if (!documentPages || documentPages.length === 0) {
            pageContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">O conteúdo do documento está vazio ou não pôde ser carregado.</p>';
            return;
        }

        // Itera sobre cada 'documento' (ex: PATD_Coringa, PRECLUSAO, etc.)
        documentPages.forEach((docHtml, docIndex) => {
            
            // Divide o HTML do documento pelo marcador de quebra de página
            const logicalPages = docHtml.split('<div class="manual-page-break"></div>');

            // Itera sobre cada página lógica resultante da divisão
            logicalPages.forEach((pageHtml, logicalPageIndex) => {
                // Não renderiza páginas lógicas vazias (resultantes de quebras no final)
                if (pageHtml.trim() === "") return;

                const pageDiv = document.createElement('div');
                pageDiv.className = 'page'; // Aplica a classe CSS de página

                // Adiciona o número da página
                const pageNumberDiv = document.createElement('div');
                pageNumberDiv.className = 'page-number';
                pageNumberDiv.textContent = `Página ${pageCounter}`;
                
                // Cria o container do conteúdo
                const contentDiv = document.createElement('div');
                contentDiv.className = 'page-content';

                // Processa os placeholders (agora incluindo os de anexo)
                let processedHtml = processPlaceholders(pageHtml);
                
                // Limpa o HTML (lógica de limpeza existente)
                processedHtml = processedHtml.replace(/<p>(<br\s*\/?>|\s|&nbsp;)*<\/p>/gi, ''); 
                processedHtml = processedHtml.replace(/<p>(<br\s*\/?>\s*)+/gi, '<p>'); 
                processedHtml = processedHtml.replace(/(<br\s*\/?>\s*)+<\/p>/gi, '</p>');
                
                // NOVO: Reduz múltiplos <br> para apenas um, garantindo no máximo uma linha de espaço.
                processedHtml = processedHtml.replace(/(<br\s*\/?>\s*){2,}/gi, '<br>');

                processedHtml = processedHtml.replace(/\s{2,}/g, ' '); 
                processedHtml = processedHtml.replace(/(&nbsp;){2,}/g, '&nbsp;');

                contentDiv.innerHTML = processedHtml; // Insere o HTML processado

                // Adiciona o conteúdo e o número da página à div da página
                pageDiv.appendChild(contentDiv);
                pageDiv.appendChild(pageNumberDiv); 
                
                // Adiciona a página completa ao container principal
                pageContainer.appendChild(pageDiv);

                pageCounter++; // Incrementa o contador de página
            });
        });

        // --- INÍCIO: Lógica de contagem e navegação de assinaturas ---
        const signatureButtons = pageContainer.querySelectorAll('.open-signature-modal');
        const signatureImages = pageContainer.querySelectorAll('.signature-image-embedded');
        
        const totalSignatures = signatureButtons.length + signatureImages.length;
        const completedSignatures = signatureImages.length;

        const signatureCounter = document.getElementById('signature-counter');
        if (signatureCounter) {
            signatureCounter.textContent = `${completedSignatures}/${totalSignatures}`;
        }

        pendingSignatureElements = Array.from(signatureButtons);
        const sigNavButton = document.getElementById('signature-nav-button');

        if (pendingSignatureElements.length > 0) {
            sigNavButton.style.display = 'flex'; // Mostra o botão
        } else {
            sigNavButton.style.display = 'none'; // Oculta se não houver pendentes
        }
        // --- FIM: Lógica de contagem e navegação de assinaturas ---
    }

    // --- INÍCIO DA CORREÇÃO: Mover a configuração dos botões para o final ---
    // Adiciona os listeners DEPOIS que a função renderVisualizador está definida.

    // --- INÍCIO: Listener do botão de navegação ---
    const sigNavButton = document.getElementById('signature-nav-button');
    if (sigNavButton) {
        sigNavButton.addEventListener('click', () => {
            if (pendingSignatureElements.length === 0) return;

            currentSignatureIndex++;
            if (currentSignatureIndex >= pendingSignatureElements.length) {
                currentSignatureIndex = 0; // Volta para o início
            }

            const nextSignature = pendingSignatureElements[currentSignatureIndex];
            nextSignature.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            nextSignature.classList.add('signature-focus');
            setTimeout(() => nextSignature.classList.remove('signature-focus'), 1600);
        });
    }

    // --- LÓGICA PARA EXCLUIR ANEXOS ---
    document.body.addEventListener('click', function(e) {
        const target = e.target.closest('.excluir-anexo-btn');
        if (target) {
            const anexoId = target.dataset.anexoId;
            if (confirm('Tem a certeza de que deseja excluir este anexo?')) {
                const url = `/Ouvidoria/anexo/${anexoId}/excluir/`;
                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Remove o anexo dos dados JS e re-renderiza a lista de anexos
                        anexosDefesa = anexosDefesa.filter(a => a.id != anexoId);
                        anexosReconsideracao = anexosReconsideracao.filter(a => a.id != anexoId);
                        anexosReconsideracaoOficial = anexosReconsideracaoOficial.filter(a => a.id != anexoId);
                        renderAnexosGeral();
                        // --- ADICIONADO: Re-renderiza o visualizador principal ---
                        renderVisualizador();
                    } else {
                        alert('Erro ao excluir anexo: ' + data.message);
                    }
                })
                .catch(error => console.error('Erro:', error));
            }
        }
    });

    document.body.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-signature-btn');
        if (removeBtn) {
            e.preventDefault();
            if (!confirm('Tem certeza que deseja remover esta assinatura?')) {
                return;
            }

            const signatureType = removeBtn.dataset.signatureType;
            const signatureIndex = removeBtn.dataset.signatureIndex;
            const url = `{% url 'Ouvidoria:remover_assinatura' patd.pk %}`;
            const body = {
                signature_type: signatureType,
            };
            if (signatureIndex !== undefined) {
                body.signature_index = parseInt(signatureIndex, 10);
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Erro ao remover assinatura: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro de comunicação.');
            });
        }
    });

    // --- LÓGICA PARA JUSTIFICAR PATD ---
    const btnJustificarPatd = document.getElementById('btn-justificar-patd');
    if (btnJustificarPatd) {
        btnJustificarPatd.addEventListener('click', function() {
            if (confirm('Tem a certeza de que deseja justificar esta transgressão? A PATD será movida para "Aguardando Publicação" e não poderá ser revertida.')) {
                this.disabled = true;
                this.textContent = 'A justificar...';

                const url = `{% url 'Ouvidoria:justificar_patd' patd.pk %}`;
                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Erro ao justificar: ' + data.message);
                        this.disabled = false;
                        this.textContent = 'Justificar Transgressão';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro de comunicação ao justificar a transgressão.');
                    this.disabled = false;
                    this.textContent = 'Justificar Transgressão';
                });
            }
        });
    }

    // --- LÓGICA DO MODAL DE FINALIZAR PUBLICAÇÃO ---
    const finalizarModal = document.getElementById('finalizar-publicacao-modal');
    if (finalizarModal) {
        const openBtn = document.getElementById('btn-finalizar-modal');
        const cancelBtn = document.getElementById('cancel-finalizar-btn');

        if(openBtn) {
            openBtn.addEventListener('click', () => finalizarModal.classList.add('active'));
        }
        if(cancelBtn) {
            cancelBtn.addEventListener('click', () => finalizarModal.classList.remove('active'));
        }
        finalizarModal.addEventListener('click', e => {
            if (e.target === finalizarModal) finalizarModal.classList.remove('active');
        });
    }

    // --- LÓGICA PARA MOSTRAR/OCULTAR ANÁLISE DISCIPLINAR NO NOVO STATUS ---
    const patdStatus = '{{ patd.status }}';
    const isOficialResponsavel = '{{ request.user.profile.militar.pk }}' === '{{ patd.oficial_responsavel.pk }}';

    // --- INÍCIO DA MODIFICAÇÃO: Inverte a lógica de exibição ---
    if (patdStatus === 'aguardando_nova_punicao' && isOficialResponsavel) {
        const analiseCard = document.getElementById('analise-disciplinar-card');
        const resumoCard = document.getElementById('resumo-analise-card');
        if (analiseCard) {
            analiseCard.style.display = 'none'; // Oculta o card de edição
        }
        if (resumoCard) {
            resumoCard.style.display = 'block'; // Mostra o card de resumo
        }
    }
    // --- ****** LÓGICA DO MODAL VISUALIZADOR DE ANEXO (REMOVIDA) ****** ---
    // (Toda a lógica do anexo-viewer-modal foi removida)

    // --- INÍCIO: Lógica do Modal de Nova Punição ---
    const novaPunicaoModal = document.getElementById('nova-punicao-modal');
    if (novaPunicaoModal) {
        const openBtn = document.getElementById('btn-nova-punicao-modal');
        const cancelBtn = document.getElementById('cancel-nova-punicao-btn');
        const form = document.getElementById('form-nova-punicao');

        if(openBtn) {
            openBtn.addEventListener('click', () => novaPunicaoModal.classList.add('active'));
        }
        if(cancelBtn) {
            cancelBtn.addEventListener('click', () => novaPunicaoModal.classList.remove('active'));
        }
        if(form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const dias = document.getElementById('nova-punicao-dias-input').value;
                const tipo = document.getElementById('nova-punicao-tipo-input').value;

                const url = `{% url 'Ouvidoria:salvar_nova_punicao' patd.pk %}`;
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ dias: dias, tipo: tipo })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => console.error('Erro:', error));
            });
        }
    }
    // --- FIM: Lógica do Modal de Nova Punição ---

    // --- MODIFICADO: renderAnexosGeral (agora usa links <a>) ---
    function renderAnexosGeral() {
        const anexosCard = document.getElementById('anexos-card-geral');
        const defesaContainer = document.getElementById('anexos-defesa-container-geral');
        const defesaList = document.getElementById('anexos-defesa-list-geral');
        const reconsideracaoContainer = document.getElementById('anexos-reconsideracao-container-geral');
        const reconsideracaoList = document.getElementById('anexos-reconsideracao-list-geral');
        const reconsideracaoOficialContainer = document.getElementById('anexos-reconsideracao-oficial-container-geral');
        const reconsideracaoOficialList = document.getElementById('anexos-reconsideracao-oficial-list-geral');

        defesaList.innerHTML = '';
        reconsideracaoList.innerHTML = '';
        reconsideracaoOficialList.innerHTML = '';

        let hasAnexos = false;

        if (anexosDefesa.length > 0) {
            defesaContainer.style.display = 'block';
            anexosDefesa.forEach(anexo => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${anexo.nome}</span>
                    <div class="anexo-actions">
                        <a href="${anexo.url}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:16px; height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                            Abrir
                        </a>
                        <button class="btn btn-sm btn-delete excluir-anexo-btn" data-anexo-id="${anexo.id}">Excluir</button>
                    </div>
                `;
                defesaList.appendChild(li);
            });
            hasAnexos = true;
        } else {
            defesaContainer.style.display = 'none';
        }

        if (anexosReconsideracao.length > 0) {
            reconsideracaoContainer.style.display = 'block';
            anexosReconsideracao.forEach(anexo => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${anexo.nome}</span>
                    <div class="anexo-actions">
                        <a href="${anexo.url}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:16px; height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                            Abrir
                        </a>
                        <button class="btn btn-sm btn-delete excluir-anexo-btn" data-anexo-id="${anexo.id}">Excluir</button>
                    </div>
                `;
                reconsideracaoList.appendChild(li);
            });
            hasAnexos = true;
        } else {
            reconsideracaoContainer.style.display = 'none';
        }

        if (anexosReconsideracaoOficial.length > 0) {
            reconsideracaoOficialContainer.style.display = 'block';
            anexosReconsideracaoOficial.forEach(anexo => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${anexo.nome}</span>
                    <div class="anexo-actions">
                        <a href="${anexo.url}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:16px; height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                            Abrir
                        </a>
                        <button class="btn btn-sm btn-delete excluir-anexo-btn" data-anexo-id="${anexo.id}">Excluir</button>
                    </div>
                `;
                reconsideracaoOficialList.appendChild(li);
            });
            hasAnexos = true;
        } else {
            reconsideracaoOficialContainer.style.display = 'none';
        }

        anexosCard.style.display = hasAnexos ? 'block' : 'none';
    }


    // --- LÓGICA DE APURAÇÃO (Botão #btn-apurar e formulário) ---
    const btnApurar = document.getElementById('btn-apurar');
    const apuracaoForm = document.getElementById('apuracao-form');
    const btnSalvarApuracao = document.getElementById('btn-salvar-apuracao');
    const btnReanalisar = document.getElementById('btn-reanalisar-apuracao');
    const btnCancelarApuracao = document.getElementById('btn-cancelar-apuracao');

    // --- LÓGICA DA PUNIÇÃO (DIAS/TIPO) ---
    const punicaoDiasInput = document.getElementById('id_punicao_dias');
    const punicaoTipoSelect = document.getElementById('id_punicao_tipo');

    if (punicaoTipoSelect && punicaoDiasInput) {
        punicaoTipoSelect.addEventListener('change', () => {
            const selectedType = punicaoTipoSelect.value;
            if (selectedType === 'repreensão por escrito' || selectedType === 'repreensão verbal') {
                punicaoDiasInput.value = 0;
                punicaoDiasInput.disabled = true;
            } else {
                punicaoDiasInput.disabled = false;
            }
        });
    }

    // Função para preencher o formulário de apuração com dados
    function preencherFormApuracao(data) {
        if (!data) {
            console.warn("Nenhum dado de análise recebido para preencher o formulário.");
            return;
        }
        
        // Preenche Itens Enquadrados
        const itensTextarea = document.getElementById('itens_enquadrados');
        if (data.itens && Array.isArray(data.itens)) {
            itensTextarea.value = data.itens.map(item => `${item.numero}: ${item.descricao}`).join('\n');
        } else {
            itensTextarea.value = "Não foi possível extrair os itens.";
        }

        // Preenche Atenuantes e Agravantes
        const atenuantesInput = document.getElementById('atenuantes');
        const agravantesInput = document.getElementById('agravantes');
        if (data.circunstancias) {
            atenuantesInput.value = data.circunstancias.atenuantes ? data.circunstancias.atenuantes.join(', ') : "Nenhuma";
            agravantesInput.value = data.circunstancias.agravantes ? data.circunstancias.agravantes.join(', ') : "Nenhuma";
        } else {
            atenuantesInput.value = "Erro na análise";
            agravantesInput.value = "Erro na análise";
        }

        // Preenche Punição Sugerida (NOVOS CAMPOS)
        const punicaoString = data.punicao || "";
        document.getElementById('punicao_sugerida_original_llm').value = punicaoString; // Salva a string original
        
        const punicaoDiasInputJS = document.getElementById('id_punicao_dias');
        const punicaoTipoSelectJS = document.getElementById('id_punicao_tipo');

        // Tenta extrair dias e tipo da string
        const match = punicaoString.match(/(\d+)\s+dias\s+de\s+(.+)/i);
        if (match) {
            const dias = parseInt(match[1], 10);
            let tipo = match[2].toLowerCase().trim();

            // Ajusta "repreensão" para "repreensão por escrito" se for o caso
            if (tipo === "repreensão") {
                tipo = "repreensão por escrito";
            }
            
            punicaoDiasInputJS.value = dias;
            // Verifica se o tipo existe nas opções
            if ([...punicaoTipoSelectJS.options].some(opt => opt.value === tipo)) {
                punicaoTipoSelectJS.value = tipo;
            } else {
                punicaoTipoSelectJS.value = ''; // Valor não reconhecido
            }

        } else if (punicaoString.toLowerCase().includes('repreensão')) {
            // Caso seja só "Repreensão"
            punicaoDiasInputJS.value = 0;
            if (punicaoString.toLowerCase().includes('verbal')) {
                 punicaoTipoSelectJS.value = 'repreensão verbal';
            } else {
                 punicaoTipoSelectJS.value = 'repreensão por escrito';
            }
        } else if (punicaoString) {
            // Fallback para tipos não reconhecidos (ex: "Erro...")
            punicaoDiasInputJS.value = 0;
            punicaoTipoSelectJS.value = ''; // Reseta para "Selecione"
        }
        
        // Dispara o evento change para garantir que a lógica de "disabled" seja aplicada
        if (punicaoTipoSelectJS) {
            punicaoTipoSelectJS.dispatchEvent(new Event('change'));
        }

        // Exibe o formulário e oculta o botão de apurar
        if(apuracaoForm) apuracaoForm.style.display = 'block';
        if(btnApurar) btnApurar.style.display = 'none';
    }

    // Função para buscar e analisar a punição
    function fetchAnalisePunicao(forceReanalyze = false) {
        if(btnApurar) btnApurar.classList.add('loading');
        if(btnReanalisar) btnReanalisar.classList.add('loading');

        const url = `{% url 'Ouvidoria:analisar_punicao' patd.pk %}`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ force_reanalyze: forceReanalyze })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.analise_data) {
                preencherFormApuracao(data.analise_data);
            } else {
                alert('Erro ao buscar análise: ' + (data.message || 'Erro desconhecido.'));
                // Se já existiam dados (analiseData), preenche com eles
                if (analiseData && !forceReanalyze) {
                    preencherFormApuracao(analiseData);
                }
            }
        })
        .catch(error => {
            console.error('Erro no fetch da análise:', error);
            alert('Erro de comunicação ao buscar análise da punição.');
        })
        .finally(() => {
            if(btnApurar) btnApurar.classList.remove('loading');
            if(btnReanalisar) btnReanalisar.classList.remove('loading');
        });
    }

    // Listener para o botão "Visualizar Apuração"
    if (btnApurar) {
        btnApurar.addEventListener('click', () => {
            // Se os dados já foram pré-carregados (analiseData), usa-os.
            // Senão, faz o fetch.
            if (analiseData) {
                preencherFormApuracao(analiseData);
            } else {
                fetchAnalisePunicao(false);
            }
        });
    }

    // Listener para o botão "Analisar Novamente"
    if (btnReanalisar) {
        btnReanalisar.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja re-analisar? Isso pode sobrescrever os dados atuais.')) {
                fetchAnalisePunicao(true); // Força a re-análise
            }
        });
    }

    // Listener para o botão "Ocultar"
    if (btnCancelarApuracao) {
        btnCancelarApuracao.addEventListener('click', () => {
            if(apuracaoForm) apuracaoForm.style.display = 'none';
            if(btnApurar) btnApurar.style.display = 'inline-flex';
        });
    }

    // Listener para o botão "Salvar Apuração e Concluir" (MODIFICADO)
    if (btnSalvarApuracao) {
        btnSalvarApuracao.addEventListener('click', () => {
            const btnSpinner = btnSalvarApuracao.querySelector('.spinner');
            
            // Coleta os dados dos novos campos
            const punicaoDias = document.getElementById('id_punicao_dias').value;
            const punicaoTipo = document.getElementById('id_punicao_tipo').value;
            
            if (!punicaoTipo) {
                alert('Por favor, selecione um tipo de punição.');
                return;
            }
            
            if(btnSpinner) btnSpinner.style.display = 'inline-block';
            btnSalvarApuracao.disabled = true;

            // Gera a string de punição sugerida para compatibilidade
            let punicaoSugeridaString = "";
            if (punicaoTipo === 'repreensão por escrito' || punicaoTipo === 'repreensão verbal') {
                punicaoSugeridaString = punicaoTipo;
            } else {
                punicaoSugeridaString = `${punicaoDias} dias de ${punicaoTipo}`;
            }

            const data = {
                itens_enquadrados: document.getElementById('itens_enquadrados').value.split('\n')
                                    .filter(line => line.trim() !== "")
                                    .map(line => {
                                        const parts = line.split(':');
                                        return { numero: parts[0] ? parts[0].trim() : 'N/A', descricao: parts[1] ? parts[1].trim() : line };
                                    }),
                circunstancias: {
                    atenuantes: document.getElementById('atenuantes').value.split(',').map(s => s.trim()).filter(s => s && s !== "Nenhuma"),
                    agravantes: document.getElementById('agravantes').value.split(',').map(s => s.trim()).filter(s => s && s !== "Nenhuma")
                },
                // Envia a string formatada para o campo antigo (fallback)
                punicao_sugerida: punicaoSugeridaString,
                // Envia os campos estruturados (preferenciais)
                punicao_dias: parseInt(punicaoDias, 10),
                punicao_tipo: punicaoTipo
            };

            const url = `{% url 'Ouvidoria:salvar_apuracao' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Apuração salva com sucesso! A página será recarregada.');
                    window.location.reload();
                } else {
                    alert('Erro ao salvar apuração: ' + data.message);
                    if(btnSpinner) btnSpinner.style.display = 'none';
                    btnSalvarApuracao.disabled = false;
                }
            })
            .catch(error => {
                console.error('Erro ao salvar apuração:', error);
                alert('Erro de comunicação ao salvar a apuração.');
                if(btnSpinner) btnSpinner.style.display = 'none';
                btnSalvarApuracao.disabled = false;
            });
        });
    }
    // --- FIM DA LÓGICA DE APURAÇÃO ---
    
    
    // CHAMADAS INICIAIS
    renderAnexosGeral(); // Agora apenas renderiza a lista na Visão Geral

    const activeTabId = localStorage.getItem('activePatdTab-{{ patd.pk }}') || 'tab-detalhes';
    document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    
    // Adiciona verificação para caso o seletor não encontre o elemento
    const activeLink = document.querySelector(`.tab-link[data-target="${activeTabId}"]`);
    const activePanel = document.getElementById(activeTabId);
    
    if (activeLink) {
        activeLink.classList.add('active');
    } else {
        // Fallback se a aba salva não existir mais
        document.querySelector('.tab-link[data-target="tab-detalhes"]').classList.add('active');
    }

    if (activePanel) {
        activePanel.classList.add('active');
    } else {
        // Fallback se o painel salvo não existir mais
        document.getElementById('tab-detalhes').classList.add('active');
    }


    if (activeTabId === 'tab-visualizador' && activePanel) {
        renderVisualizador();
    } else if (!activePanel && activeTabId === 'tab-visualizador') {
         // Fallback se a aba era 'visualizador' mas o painel não foi encontrado
        renderVisualizador();
    }

// --- NOVA Lógica do Modal de Aprovação ---
const aprovarModal = document.getElementById('aprovar-patd-modal');
const aprovarForm = document.getElementById('aprovar-patd-form');
const aprovarModalTitle = document.getElementById('aprovar-modal-title');
const cancelAprovarBtn = document.getElementById('cancel-aprovar-btn');

document.body.addEventListener('click', function(e) {
    if (e.target.classList.contains('open-aprovar-modal-btn')) {
        const patdPk = e.target.dataset.patdPk;
        const patdNumero = e.target.dataset.patdNumero;
        // A action do form agora aponta para a URL de aprovação correta
        const url = `/Ouvidoria/patd/${patdPk}/aprovar/`;
        aprovarForm.action = url;
        aprovarModalTitle.textContent = `Aprovar PATD Nº ${patdNumero}`;
        aprovarModal.classList.add('active');
    }
});

if (cancelAprovarBtn) {
    cancelAprovarBtn.addEventListener('click', () => {
        aprovarModal.classList.remove('active');
    });
}

if (aprovarModal) {
    aprovarModal.addEventListener('click', (e) => {
        if (e.target === aprovarModal) {
            aprovarModal.classList.remove('active');
        }
    });
}

});
</script>
{% endblock %}