{% extends 'base.html' %}
{% load auth_extras %}

{% block title %}Detalhes da PATD Nº {{ patd.numero_patd }}{% endblock %}

{% block content %}
<style>
    .status-timeline {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0;
        list-style: none;
        position: relative;
    }
    .status-timeline::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--border-color);
        transform: translateY(-50%);
        z-index: 1;
    }
    .status-step {
        position: relative;
        text-align: center;
        width: 100%;
        z-index: 2;
    }
    .status-step .status-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: var(--border-color);
        margin: 0 auto 10px;
        border: 3px solid var(--bg-content);
        transition: background-color 0.3s;
    }
    .status-step.completed .status-dot,
    .status-step.active .status-dot {
        background-color: var(--accent-color);
    }
    .status-step .status-label {
        font-size: 12px;
        color: var(--text-secondary);
    }
     .status-step.active .status-label {
        font-weight: bold;
        color: var(--text-primary);
    }

    .patd-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .patd-header h1 {
        border-bottom: none;
        padding-bottom: 0;
    }

    .patd-actions {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
        margin-left: 20px;
    }

    .card {
        background-color: var(--bg-content);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: var(--box-shadow);
    }
    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    .card-header svg {
        width: 24px;
        height: 24px;
        color: var(--accent-color);
    }
    .card-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }
    .card-body .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }
     .card-body .detail-item strong {
        display: block;
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
     .card-body .detail-item p, .card-body .detail-item .detail-value {
        margin: 0;
        color: var(--text-primary);
        font-weight: 500;
    }

    .full-width {
        grid-column: 1 / -1;
    }

    .document-view {
        white-space: pre-wrap;
    }

    /* Estilos copiados para consistência */
    .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .tabs-nav a { padding: 10px 20px; text-decoration: none; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; cursor: pointer; }
    .tabs-nav a.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .document-view .signature-image-embedded { max-height: 60px; width: auto; background-color: white; border: 1px solid #ccc; border-radius: 4px; padding: 2px; vertical-align: middle; }
    .document-view .no-signature-text { font-style: italic; color: var(--text-secondary); }
    .btn-success { background: linear-gradient(45deg, var(--success-color), #5cb85c); color: #fff; }
    .prazo-defesa { background-color: var(--sidebar-active-bg); border-left: 4px solid var(--warning-color); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    .prazo-defesa.expirado { border-left-color: var(--danger-color); }
    .analise-container .feedback-message { margin-top: 10px; padding: 10px; border-radius: 6px; font-weight: 500; }
    .feedback-message.processing { background-color: var(--sidebar-active-bg); border-left: 4px solid var(--warning-color); color: var(--text-primary); }
    .feedback-message.error { background-color: #f8d7da; border-left: 4px solid var(--danger-color); color: #721c24; }
    #apuracao-form { display: none; margin-top: 15px; }
    #apuracao-form .form-grid { grid-template-columns: 1fr 1fr; gap: 20px; }
    #apuracao-form textarea, #apuracao-form input { width: 100%; box-sizing: border-box; }
    #apuracao-form .form-item-full { grid-column: 1 / -1; }
</style>

<div class="patd-header">
    <h1>PATD Nº {{ patd.numero_patd }}</h1>
    <div class="patd-actions">
        <a href="{% url 'Ouvidoria:patd_update' patd.pk %}" class="btn btn-secondary">Editar</a>
        <button type="button" class="btn btn-delete" id="delete-patd-btn">Excluir</button>
    </div>
</div>

<!-- Barra de Status -->
<ul class="status-timeline">
    {% with current_status=patd.status %}
    <li class="status-step {% if current_status in 'definicao_oficial,aguardando_aprovacao_atribuicao,ciencia_militar,aguardando_justificativa,prazo_expirado,em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar,analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,finalizado' %}active{% endif %} {% if current_status != 'definicao_oficial' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Abertura</div>
    </li>
    <li class="status-step {% if current_status in 'ciencia_militar,aguardando_justificativa,prazo_expirado,em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar,analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,finalizado' %}active{% endif %} {% if current_status not in 'definicao_oficial,aguardando_aprovacao_atribuicao' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Defesa</div>
    </li>
    <li class="status-step {% if current_status in 'em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar,analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,finalizado' %}active{% endif %} {% if current_status not in 'definicao_oficial,aguardando_aprovacao_atribuicao,ciencia_militar,aguardando_justificativa,prazo_expirado' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Apuração</div>
    </li>
    <li class="status-step {% if current_status in 'analise_comandante,aguardando_assinatura_npd,periodo_reconsideracao,em_reconsideracao,finalizado' %}active{% endif %} {% if current_status not in 'definicao_oficial,aguardando_aprovacao_atribuicao,ciencia_militar,aguardando_justificativa,prazo_expirado,em_apuracao,apuracao_preclusao,aguardando_punicao,aguardando_punicao_alterar' %}completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Decisão</div>
    </li>
    <li class="status-step {% if current_status == 'finalizado' %}active completed{% endif %}">
        <div class="status-dot"></div>
        <div class="status-label">Finalizado</div>
    </li>
    {% endwith %}
</ul>


<nav class="tabs-nav">
    <a class="tab-link active" data-target="tab-detalhes">Visão Geral</a>
    <a class="tab-link" data-target="tab-documento">Documento Completo</a>
</nav>

<div id="tab-detalhes" class="tab-panel active">
    
    <!-- Card de Ações e Prazos -->
    <div class="card">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h2>Ações e Prazos</h2>
        </div>
        <div class="card-body">
            {% if patd.status == 'aguardando_justificativa' or patd.status == 'prazo_expirado' %}
            <div id="prazo-box" class="prazo-defesa">
                <strong>Prazo para Alegação de Defesa:</strong>
                <span id="countdown-timer">A calcular...</span>
            </div>
            {% endif %}
            {% if patd.status == 'periodo_reconsideracao' %}
            <div id="reconsideracao-prazo-box" class="prazo-defesa">
                <strong>Prazo para Reconsideração:</strong>
                <span id="reconsideracao-countdown-timer">A calcular...</span>
            </div>
            {% endif %}

             <div class="form-actions" id="form-actions-container">
                {% if patd.status == 'aguardando_justificativa' and not patd.alegacao_defesa %}
                <button type="button" class="btn btn-primary" id="add-defesa-btn">Adicionar Alegação de Defesa</button>
                {% endif %}
                {% if patd.status == 'prazo_expirado' %}
                <button type="button" class="btn btn-warning" id="extender-prazo-btn">Extender Prazo</button>
                <button type="button" class="btn btn-danger" id="prosseguir-sem-defesa-btn">Prosseguir sem Alegação</button>
                {% endif %}
                {% if request.user.profile.militar == patd.oficial_responsavel %}
                    {% if patd.status == 'aguardando_punicao' or patd.status == 'aguardando_punicao_alterar' %}
                    <button type="button" class="btn btn-success" id="btn-avancar-comandante">Avançar para Comandante</button>
                    {% endif %}
                {% endif %}
                {% if patd.status == 'periodo_reconsideracao' %}
                <button type="button" class="btn btn-warning" id="btn-reconsideracao-modal">Solicitar Reconsideração</button>
                {% endif %}
                {% if patd.status == 'analise_comandante' and user|has_comandante_access %}
                <form action="{% url 'Ouvidoria:patd_aprovar' patd.pk %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">Aprovar PATD</button>
                </form>
                <form action="{% url 'Ouvidoria:patd_retornar' patd.pk %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">Retornar para Alteração</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Card de Detalhes do Processo -->
    <div class="card">
        <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12.75h.008M8.25 15h.008M8.25 18h.008m3.75-12h.008m2.25-3h.008M12 6h.008m-2.25 6h.008m2.25 6h.008M12 18h.008m-3.75-6h.008m2.25-6h.008" /></svg>
            <h2>Detalhes do Processo</h2>
        </div>
        <div class="card-body">
            <div class="detail-grid">
                <div class="detail-item">
                    <strong>Militar Acusado:</strong>
                    <p class="detail-value"><a href="{% url 'Ouvidoria:militar_patd_list' patd.militar.pk %}" class="militar-acusado-link">{{ patd.militar }}</a></p>
                </div>
                <div class="detail-item">
                    <strong>Data da Ocorrência:</strong>
                    <p class="detail-value">{{ patd.data_ocorrencia|date:"d/m/Y"|default:"Não informada" }}</p>
                </div>
                <div class="detail-item">
                    <strong>Protocolo COMAER:</strong>
                    <p class="detail-value">{{ patd.protocolo_comaer|default:"Não informado" }}</p>
                </div>
                 <div class="detail-item">
                    <strong>Ofício da Transgressão:</strong>
                    <p class="detail-value">{{ patd.oficio_transgressao|default:"Não informado" }}</p>
                </div>
                <div class="detail-item full-width">
                    <strong>Descrição da Transgressão:</strong>
                    <p>{{ patd.transgressao|linebreaks }}</p>
                </div>
                 {% if patd.alegacao_defesa %}
                <div class="detail-item full-width">
                    <strong>Alegação de Defesa:</strong>
                    <p>{{ patd.alegacao_defesa|linebreaks }}</p>
                </div>
                {% endif %}
                 <div class="detail-item">
                    <strong>Status:</strong>
                    <p id="patd-status" class="detail-value">{{ patd.get_status_display }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Card de Envolvidos -->
    <div class="card">
         <div class="card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 001.13-1.897M16.5 7.5V18L18 15.75l-1.5-3.75V7.5z" /></svg>
            <h2>Envolvidos e Assinaturas</h2>
        </div>
        <div class="card-body">
             <div class="detail-grid">
                  <div class="detail-item full-width">
                    <strong>Oficial Responsável:</strong>
                     <div class="oficial-container">
                         <div class="detail-value">
                            {% if patd.status == 'definicao_oficial' %}
                                <a href="{% url 'Ouvidoria:atribuir_oficial' patd.pk %}" class="btn btn-sm btn-primary">Atribuir Oficial</a>
                            {% elif patd.status == 'aguardando_aprovacao_atribuicao' %}
                                Aguardando aceite de: <strong>{{ patd.oficial_responsavel }}</strong>
                                {% if user.profile.militar == patd.oficial_responsavel %}
                                     <button type="button" class="btn btn-sm btn-success" id="btn-aceitar-atribuicao-modal">Aceitar Atribuição</button>
                                {% endif %}
                            {% else %}
                                {{ patd.oficial_responsavel|default:"Não definido" }}
                            {% endif %}
                        </div>
                        <div class="signature-display-container">
                            {% if patd.assinatura_oficial %}
                                <img src="{{ patd.assinatura_oficial }}" alt="Assinatura do Oficial" class="signature-image">
                            {% elif request.user.profile.militar == patd.oficial_responsavel and patd.oficial_responsavel and not patd.assinatura_oficial and patd.status != 'aguardando_aprovacao_atribuicao' and patd.status != 'definicao_oficial' %}
                                <button type="button" class="btn btn-sm btn-secondary" id="add-signature-btn">Adicionar Assinatura</button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="detail-item">
                    <strong>1ª Testemunha:</strong>
                    <div class="detail-value">{{ patd.testemunha1|default:"Não atribuída" }}</div>
                </div>
                 <div class="detail-item">
                    <strong>2ª Testemunha:</strong>
                    <div class="detail-value">{{ patd.testemunha2|default:"Não atribuída" }}</div>
                </div>

                 <div class="detail-item full-width">
                    <strong>Ciência do Militar Acusado:</strong>
                    <div id="assinaturas-militar-container" class="signature-display-container" style="flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        <!-- As assinaturas serão inseridas aqui pelo JS -->
                    </div>
                </div>
             </div>
        </div>
    </div>
    
     {% if request.user.profile.militar == patd.oficial_responsavel and patd.status in 'em_apuracao,apuracao_preclusao' %}
    <div class="card">
        <div class="card-header">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
             <h2>Análise Disciplinar</h2>
        </div>
        <div class="card-body">
            <div id="analise-actions">
                <button class="btn btn-primary" id="btn-apurar">
                    <span class="spinner" style="display: none;"></span>
                    Visualizar Apuração
                </button>
            </div>
             <form id="apuracao-form" class="model-form">
                <h3>Resultado da Apuração (Editável)</h3>
                <div class="form-grid">
                    <div class="form-item-full">
                        <label for="itens_enquadrados">Itens Enquadrados:</label>
                        <textarea id="itens_enquadrados" name="itens_enquadrados" rows="4"></textarea>
                    </div>
                    <div>
                        <label for="atenuantes">Atenuantes:</label>
                        <input type="text" id="atenuantes" name="atenuantes">
                    </div>
                    <div>
                        <label for="agravantes">Agravantes:</label>
                        <input type="text" id="agravantes" name="agravantes">
                    </div>
                    <div class="form-item-full">
                        <label for="punicao_sugerida">Punição Sugerida:</label>
                        <textarea id="punicao_sugerida" name="punicao_sugerida" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" id="btn-salvar-apuracao" class="btn btn-primary">
                        <span class="spinner" style="display: none;"></span>
                        Salvar Apuração e Concluir
                    </button>
                    <button type="button" id="btn-cancelar-apuracao" class="btn btn-secondary">Ocultar</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

</div>

<div id="tab-documento" class="tab-panel">
    <div class="card">
        <div class="card-body">
            <div id="documento-view" class="document-view"></div>
        </div>
    </div>
</div>
<!-- Modals... -->
<div class="modal-overlay" id="delete-modal">
    <div class="modal-content">
        <h3>Confirmar Exclusão</h3>
        <p>Tem a certeza de que deseja excluir a PATD Nº {{ patd.numero_patd }}? Esta ação não pode ser desfeita.</p>
        <form method="post" action="{% url 'Ouvidoria:patd_delete' patd.pk %}" style="display: inline;">
            {% csrf_token %}
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-delete-btn">Cancelar</button>
                <button type="submit" class="btn btn-delete">Sim, Excluir</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="avancar-modal">
    <div class="modal-content">
        <h3>Avançar Processo</h3>
        <p>Tem certeza? Esta PATD vai para análise do comandante. Já revisou tudo?</p>
        <form id="avancar-form" method="post" action="{% url 'Ouvidoria:avancar_para_comandante' patd.pk %}" style="display: inline;">
            {% csrf_token %}
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-avancar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Continuar</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="signature-modal">
    <div class="modal-content">
        <h3>Assinatura do Oficial</h3>
        <p>Desenhe a assinatura no campo abaixo.</p>
        <div class="canvas-container"><canvas id="signature-canvas"></canvas></div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="clear-signature-btn">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn">Salvar Assinatura</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="signature-modal-ciencia">
    <div class="signature-modal-content">
        <h3>Registrar Ciência da Acusação</h3>
        <p>Eu, {{ patd.militar }}, declaro ter ciência dos fatos a mim imputados.</p>
        <div class="canvas-container"><canvas id="signature-canvas-ciencia"></canvas></div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="clear-signature-btn-ciencia">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn-ciencia">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn-ciencia">Confirmar Ciência</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="defesa-modal">
    <div class="modal-content">
        <h3>Alegação de Defesa</h3>
        <p>Escreva abaixo a sua alegação de defesa referente aos fatos imputados.</p>
        <textarea id="alegacao-defesa-texto" style="width: 100%; min-height: 150px;"></textarea>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-defesa-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="submit-defesa-btn">Concluir</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="confirm-defesa-modal">
    <div class="modal-content">
        <h3>Confirmar Envio</h3>
        <p>Tem a certeza de que deseja enviar a sua alegação de defesa? Esta ação é final e não poderá ser alterada.</p>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-confirm-defesa-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="final-submit-defesa-btn">Sim, Enviar</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="extender-prazo-modal">
    <div class="modal-content">
        <h3>Extender Prazo de Defesa</h3>
        <p>Defina o novo prazo para a entrega da alegação de defesa a contar de agora.</p>
        <form id="extender-prazo-form" class="model-form">
            <div class="form-grid" style="grid-template-columns: 1fr {% if user.is_superuser %}1fr{% endif %}; gap: 15px;">
                <p><label for="extender-dias">Dias:</label><input type="number" id="extender-dias" value="{{ prazo_defesa_dias }}" min="0"></p>
                {% if user.is_superuser %}
                <p><label for="extender-minutos">Minutos:</label><input type="number" id="extender-minutos" value="{{ prazo_defesa_minutos }}" min="0"></p>
                {% endif %}
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-extender-prazo-btn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Confirmar Extensão</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="signature-modal-testemunha">
    <div class="modal-content">
        <h3 id="signature-modal-testemunha-title">Assinatura da Testemunha</h3>
        <p>A testemunha deve desenhar a assinatura no campo abaixo.</p>
        <div class="canvas-container"><canvas id="signature-canvas-testemunha"></canvas></div>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="clear-signature-btn-testemunha">Limpar</button>
            <button type="button" class="btn btn-secondary" id="cancel-signature-btn-testemunha">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-signature-btn-testemunha">Salvar Assinatura</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="aceitar-atribuicao-modal">
    <div class="modal-content">
        <h3>Aceitar Atribuição</h3>
        <p>Para confirmar que aceita ser o oficial responsável por esta PATD, por favor, insira a sua senha.</p>
        <form id="aceitar-atribuicao-form" method="post" action="{% url 'Ouvidoria:aceitar_atribuicao' patd.pk %}" class="model-form">
            {% csrf_token %}
            <div class="form-grid">
                <p>
                    <label for="id_senha_aceite">Sua Senha:</label>
                    <input type="password" name="senha" required id="id_senha_aceite">
                </p>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-aceitar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Confirmar e Aceitar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="reconsideracao-modal">
    <div class="modal-content">
        <h3>Confirmar Reconsideração</h3>
        <p>Tem certeza de que deseja iniciar o processo de reconsideração para esta PATD? Um novo documento será adicionado para edição.</p>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-reconsideracao-btn">Cancelar</button>
            <button type="button" class="btn btn-warning" id="confirm-reconsideracao-btn">Sim, Solicitar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="reconsideracao-texto-modal">
    <div class="modal-content">
        <h3>Texto de Reconsideração</h3>
        <p>Escreva abaixo o texto do pedido de reconsideração.</p>
        <textarea id="reconsideracao-texto-input" style="width: 100%; min-height: 150px;"></textarea>
        <div class="form-actions" style="justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" id="cancel-reconsideracao-texto-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="submit-reconsideracao-texto-btn">Salvar Texto</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados da análise pré-carregados pelo Django
const analiseData = {{ analise_data_json|safe }};
const assinaturasMilitar = {{ assinaturas_militar_json|safe }};
const rawDocumentText = {{ documento_texto_json|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let isExpired = `{{ patd.status }}` === 'prazo_expirado';

    const deleteBtn = document.getElementById('delete-patd-btn');
    const deleteModal = document.getElementById('delete-modal');
    if (deleteBtn && deleteModal) {
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        deleteBtn.addEventListener('click', () => deleteModal.classList.add('active'));
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('active'));
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) deleteModal.classList.remove('active');
        });
    }

    // --- LÓGICA DO MODAL DE ASSINATURA DO OFICIAL RESPONSÁVEL ---
    const addSignatureBtn = document.getElementById('add-signature-btn');
    const signatureModal = document.getElementById('signature-modal');
    if (addSignatureBtn && signatureModal) {
        const canvas = document.getElementById('signature-canvas');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
        
        function resizeCanvasOficial() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const parentWidth = canvas.parentElement.offsetWidth;
            canvas.width = parentWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }

        addSignatureBtn.addEventListener('click', () => {
            signatureModal.classList.add('active');
            resizeCanvasOficial();
        });

        document.getElementById('cancel-signature-btn').addEventListener('click', () => signatureModal.classList.remove('active'));
        document.getElementById('clear-signature-btn').addEventListener('click', () => signaturePad.clear());
        document.getElementById('save-signature-btn').addEventListener('click', () => {
            if (signaturePad.isEmpty()) {
                alert("Por favor, forneça a assinatura.");
                return;
            }
            const signatureData = signaturePad.toDataURL('image/png');
            const url = `{% url 'Ouvidoria:salvar_assinatura' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'signature_data': signatureData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Erro ao salvar assinatura: ' + data.message);
                }
            })
            .catch(error => console.error('Erro:', error));
        });
    }

    const aceitarAtribuicaoModal = document.getElementById('aceitar-atribuicao-modal');
    if (aceitarAtribuicaoModal) {
        const openBtn = document.getElementById('btn-aceitar-atribuicao-modal');
        const cancelBtn = document.getElementById('cancel-aceitar-btn');
        if(openBtn) {
            openBtn.addEventListener('click', () => aceitarAtribuicaoModal.classList.add('active'));
        }
        if(cancelBtn) cancelBtn.addEventListener('click', () => aceitarAtribuicaoModal.classList.remove('active'));
        aceitarAtribuicaoModal.addEventListener('click', e => {
            if (e.target === aceitarAtribuicaoModal) aceitarAtribuicaoModal.classList.remove('active');
        });
    }

    const signatureModalCiencia = document.getElementById('signature-modal-ciencia');
    if (signatureModalCiencia) {
        const canvasCiencia = document.getElementById('signature-canvas-ciencia');
        const signaturePadCiencia = new SignaturePad(canvasCiencia, { backgroundColor: 'rgb(255, 255, 255)' });
        let currentSignatureIndex = -1;

        function resizeCanvasCiencia() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const parentWidth = canvasCiencia.parentElement.offsetWidth;
            canvasCiencia.width = parentWidth * ratio;
            canvasCiencia.height = canvasCiencia.offsetHeight * ratio;
            canvasCiencia.getContext("2d").scale(ratio, ratio);
            signaturePadCiencia.clear();
        }
        
        // Listener para abrir o modal de assinatura
        document.body.addEventListener('click', function(e) {
            const btn = e.target.closest('.add-signature-ciencia-btn');
            if (btn) {
                currentSignatureIndex = parseInt(btn.dataset.index, 10);
                signatureModalCiencia.classList.add('active');
                resizeCanvasCiencia();
            }
        });

        document.getElementById('cancel-signature-btn-ciencia').addEventListener('click', () => signatureModalCiencia.classList.remove('active'));
        document.getElementById('clear-signature-btn-ciencia').addEventListener('click', () => signaturePadCiencia.clear());
        document.getElementById('save-signature-btn-ciencia').addEventListener('click', () => {
            if (signaturePadCiencia.isEmpty()) {
                alert("Por favor, forneça a assinatura.");
                return;
            }
            const signatureData = signaturePadCiencia.toDataURL('image/png');
            const url = `{% url 'Ouvidoria:salvar_assinatura_ciencia' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 
                    'signature_data': signatureData,
                    'assinatura_index': currentSignatureIndex
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }

    const defesaModal = document.getElementById('defesa-modal');
    if (defesaModal) {
        const addDefesaBtn = document.getElementById('add-defesa-btn');
        const confirmDefesaModal = document.getElementById('confirm-defesa-modal');
        const cancelDefesaBtn = document.getElementById('cancel-defesa-btn');
        const submitDefesaBtn = document.getElementById('submit-defesa-btn');
        const cancelConfirmDefesaBtn = document.getElementById('cancel-confirm-defesa-btn');
        const finalSubmitDefesaBtn = document.getElementById('final-submit-defesa-btn');
        const alegacaoText = document.getElementById('alegacao-defesa-texto');

        function openDefesaModal() {
            defesaModal.classList.add('active');
        }

        if (addDefesaBtn) {
            addDefesaBtn.addEventListener('click', openDefesaModal);
        }

        // Listener delegado para o botão no documento
        document.body.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'add-defesa-btn-doc') {
                openDefesaModal();
            }
        });

        if(cancelDefesaBtn) cancelDefesaBtn.addEventListener('click', () => defesaModal.classList.remove('active'));
        if(submitDefesaBtn) submitDefesaBtn.addEventListener('click', () => {
            if (alegacaoText.value.trim() === "") {
                alert("O campo de alegação de defesa não pode estar vazio.");
                return;
            }
            defesaModal.classList.remove('active');
            if(confirmDefesaModal) confirmDefesaModal.classList.add('active');
        });
        if(cancelConfirmDefesaBtn) cancelConfirmDefesaBtn.addEventListener('click', () => confirmDefesaModal.classList.remove('active'));
        if(finalSubmitDefesaBtn) finalSubmitDefesaBtn.addEventListener('click', () => {
            const url = `{% url 'Ouvidoria:salvar_alegacao_defesa' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'alegacao_defesa': alegacaoText.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }
    const extenderPrazoModal = document.getElementById('extender-prazo-modal');
    const extenderPrazoBtn = document.getElementById('extender-prazo-btn');
    const prosseguirBtn = document.getElementById('prosseguir-sem-defesa-btn');
    function handleProsseguirSemAlegacao() {
        if (confirm('Tem certeza que deseja prosseguir sem a alegação de defesa? Esta ação registrará a preclusão e não poderá ser desfeita.')) {
            const url = `{% url 'Ouvidoria:prosseguir_sem_alegacao' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        }
    }
    if (extenderPrazoBtn) {
        extenderPrazoBtn.addEventListener('click', () => extenderPrazoModal.classList.add('active'));
    }
    if (prosseguirBtn) {
        prosseguirBtn.addEventListener('click', handleProsseguirSemAlegacao);
    }
    if (extenderPrazoModal) {
        const cancelExtenderBtn = document.getElementById('cancel-extender-prazo-btn');
        if(cancelExtenderBtn) cancelExtenderBtn.addEventListener('click', () => extenderPrazoModal.classList.remove('active'));
        
        const extenderForm = document.getElementById('extender-prazo-form');
        if(extenderForm) extenderForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const dias = document.getElementById('extender-dias').value;
            const minutosInput = document.getElementById('extender-minutos');
            const minutos = minutosInput ? minutosInput.value : 0;
            const url = `{% url 'Ouvidoria:extender_prazo' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'dias': dias, 'minutos': minutos })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') window.location.reload();
                else alert('Erro: ' + data.message);
            })
            .catch(error => console.error('Erro:', error));
        });
    }
    const countdownTimer = document.getElementById('countdown-timer');
    const prazoBox = document.getElementById('prazo-box');
    if (countdownTimer && '{{ patd.data_ciencia }}') {
        const dataCiencia = new Date('{{ patd.data_ciencia|date:"c" }}');
        const prazoDias = parseInt('{{ prazo_defesa_dias }}', 10) || 0;

        function addBusinessDays(startDate, days) {
            let currentDate = new Date(startDate);
            let addedDays = 0;
            while (addedDays < days) {
                currentDate.setDate(currentDate.getDate() + 1);
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    addedDays++;
                }
            }
            return currentDate;
        }
        let deadlineDate = addBusinessDays(dataCiencia, prazoDias);
        let deadline = new Date(deadlineDate.getFullYear(), deadlineDate.getMonth(), deadlineDate.getDate() + 1);

        const interval = setInterval(() => {
            const now = new Date();
            const diff = deadline - now;
            if (diff <= 0) {
                countdownTimer.textContent = "Prazo expirado.";
                if(prazoBox) prazoBox.classList.add('expirado');
                clearInterval(interval);
                if (!isExpired) {
                    isExpired = true;
                    showExpiredButtons();
                }
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            countdownTimer.textContent = `${d}d ${h}h ${m}m ${s}s`;
        }, 1000);
    }
    function showExpiredButtons() {
        const actionsContainer = document.getElementById('form-actions-container');
        const addDefesaBtn = document.getElementById('add-defesa-btn');
        const statusElement = document.getElementById('patd-status');
        if (addDefesaBtn) addDefesaBtn.remove();
        if (statusElement) statusElement.textContent = "Prazo expirado";
        if (!document.getElementById('extender-prazo-btn')) {
            const extenderBtn = document.createElement('button');
            extenderBtn.type = 'button';
            extenderBtn.className = 'btn btn-warning';
            extenderBtn.id = 'extender-prazo-btn';
            extenderBtn.textContent = 'Extender Prazo';
            extenderBtn.addEventListener('click', () => extenderPrazoModal.classList.add('active'));
            actionsContainer.insertBefore(extenderBtn, actionsContainer.firstChild);
        }
        if (!document.getElementById('prosseguir-sem-defesa-btn')) {
            const prosseguirBtn = document.createElement('button');
            prosseguirBtn.type = 'button';
            prosseguirBtn.className = 'btn btn-danger';
            prosseguirBtn.id = 'prosseguir-sem-defesa-btn';
            prosseguirBtn.textContent = 'Prosseguir sem Alegação';
            prosseguirBtn.addEventListener('click', handleProsseguirSemAlegacao);
            const extenderBtn = document.getElementById('extender-prazo-btn');
            if (extenderBtn) extenderBtn.insertAdjacentElement('afterend', prosseguirBtn);
            else actionsContainer.insertBefore(prosseguirBtn, actionsContainer.firstChild);
        }
    }
    const addSignatureTestemunhaBtns = document.querySelectorAll('.add-signature-testemunha-btn');
    if (addSignatureTestemunhaBtns.length > 0) {
        const signatureModalTestemunha = document.getElementById('signature-modal-testemunha');
        if (signatureModalTestemunha) {
            const modalTitle = document.getElementById('signature-modal-testemunha-title');
            const canvas = document.getElementById('signature-canvas-testemunha');
            const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
            let currentTestemunhaNum = null;
            function resizeCanvasTestemunha() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                const parentWidth = canvas.parentElement.offsetWidth;
                canvas.width = parentWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
            }
            addSignatureTestemunhaBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentTestemunhaNum = btn.dataset.testemunhaNum;
                    modalTitle.textContent = `Assinatura da ${currentTestemunhaNum}ª Testemunha`;
                    signatureModalTestemunha.classList.add('active');
                    resizeCanvasTestemunha();
                });
            });
            document.getElementById('cancel-signature-btn-testemunha').addEventListener('click', () => signatureModalTestemunha.classList.remove('active'));
            document.getElementById('clear-signature-btn-testemunha').addEventListener('click', () => signaturePad.clear());
            document.getElementById('save-signature-btn-testemunha').addEventListener('click', () => {
                if (signaturePad.isEmpty() || !currentTestemunhaNum) return;
                const signatureData = signaturePad.toDataURL('image/png');
                const url = `/Ouvidoria/patd/{{ patd.pk }}/salvar_assinatura_testemunha/${currentTestemunhaNum}/`;
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ 'signature_data': signatureData })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') window.location.reload();
                    else alert('Erro: ' + data.message);
                })
                .catch(error => console.error('Erro:', error));
            });
        }
    }
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabPanels = document.querySelectorAll('.tab-panel');

    const savedTabId = localStorage.getItem('activePatdTab-{{ patd.pk }}');
    if (savedTabId) {
        tabLinks.forEach(l => l.classList.remove('active'));
        tabPanels.forEach(p => p.classList.remove('active'));

        const activeLink = document.querySelector(`.tab-link[data-target="${savedTabId}"]`);
        const activePanel = document.getElementById(savedTabId);

        if (activeLink && activePanel) {
            activeLink.classList.add('active');
            activePanel.classList.add('active');
        }
    }

    tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            tabLinks.forEach(l => l.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            link.classList.add('active');
            const targetPanel = document.getElementById(link.dataset.target);
            if (targetPanel) targetPanel.classList.add('active');
            localStorage.setItem('activePatdTab-{{ patd.pk }}', link.dataset.target);
        });
    });

    function renderDocument() {
        const viewer = document.getElementById('documento-view');
        if (!viewer) return;

        let processedHtml = rawDocumentText;

        processedHtml = processedHtml.replace(/\{Botao Adicionar Alegacao\}/g, `<button id="add-defesa-btn-doc" class="btn btn-sm btn-primary">Adicionar Alegação de Defesa</button>`);
        processedHtml = processedHtml.replace(/\{Botao Adicionar Reconsideracao\}/g, `<button id="add-reconsideracao-texto-btn-doc" class="btn btn-sm btn-primary">Adicionar Texto de Reconsideração</button>`);

        processedHtml = processedHtml.replace(/(data:image\/png;base64,[A-Za-z0-9+/=]+)/g, '<img class="signature-image-embedded" src="$1" alt="Assinatura">');
        
        let signatureIndex = 0;
        processedHtml = processedHtml.replace(/{Assinatura Militar Arrolado}/g, () => {
            const index = signatureIndex++;
            if (assinaturasMilitar[index]) {
                return `<img class="signature-image-embedded" src="${assinaturasMilitar[index]}" alt="Assinatura ${index + 1}">`;
            } else {
                 return `<button class="btn btn-sm btn-success add-signature-ciencia-btn" data-index="${index}">Assinar</button>`;
            }
        });
        
        const canSignTestemunha = ['preclusao', 'apuracao_preclusao', 'aguardando_assinatura_npd'].includes(`{{ patd.status }}`);
        
        if (canSignTestemunha && `{{ patd.testemunha1 }}`) {
            processedHtml = processedHtml.replace(/{SIGN_BTN_T1}/g, `<button class="btn btn-sm btn-success add-signature-testemunha-btn" data-testemunha-num="1">Assinar (Testemunha 1)</button>`);
        } else {
            processedHtml = processedHtml.replace(/{SIGN_BTN_T1}/g, '<span class="no-signature-text">[Assinatura Pendente]</span>');
        }

        if (canSignTestemunha && `{{ patd.testemunha2 }}`) {
            processedHtml = processedHtml.replace(/{SIGN_BTN_T2}/g, `<button class="btn btn-sm btn-success add-signature-testemunha-btn" data-testemunha-num="2">Assinar (Testemunha 2)</button>`);
        } else {
             processedHtml = processedHtml.replace(/{SIGN_BTN_T2}/g, '<span class="no-signature-text">[Assinatura Pendente]</span>');
        }

        processedHtml = processedHtml.replace(/\[Sem assinatura\]/g, '<span class="no-signature-text">[Sem assinatura]</span>');
        processedHtml = processedHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        processedHtml = processedHtml.replace(/\n/g, '<br>');
        viewer.innerHTML = processedHtml;

        renderAssinaturasMilitarTab();
    }
    
    function renderAssinaturasMilitarTab() {
        const container = document.getElementById('assinaturas-militar-container');
        if (!container) return;

        container.innerHTML = ''; 
        const placeholdersNoDoc = (rawDocumentText.match(/{Assinatura Militar Arrolado}/g) || []).length;
        
        if (placeholdersNoDoc === 0) {
             container.innerHTML = '<p class="detail-item-value">Nenhuma assinatura de ciência necessária.</p>';
             return;
        }

        let hasUnsigned = false;
        let signedCount = 0;
        for (let i = 0; i < placeholdersNoDoc; i++) {
            if (assinaturasMilitar[i]) {
                const img = document.createElement('img');
                img.src = assinaturasMilitar[i];
                img.alt = `Assinatura ${i + 1}`;
                img.className = 'signature-image';
                container.appendChild(img);
                signedCount++;
            } else {
                 hasUnsigned = true;
            }
        }

        if (hasUnsigned && (`{{patd.status}}` === 'ciencia_militar' || `{{patd.status}}` === 'aguardando_assinatura_npd')) {
            const firstUnsignedIndex = assinaturasMilitar.filter(s => s).length;
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-success add-signature-ciencia-btn';
            button.dataset.index = firstUnsignedIndex;
            button.textContent = `Assinar Ciência (${signedCount + 1}/${placeholdersNoDoc})`;
            container.appendChild(button);
        } else if (!hasUnsigned && placeholdersNoDoc > 0) {
            container.innerHTML += '<p class="detail-item-value">Todas as assinaturas coletadas.</p>';
        } else if (placeholdersNoDoc > 0 && assinaturasMilitar.length === 0) {
            container.innerHTML = '<p class="detail-item-value">Aguardando assinatura de ciência.</p>';
            if (`{{patd.status}}` === 'ciencia_militar' || `{{patd.status}}` === 'aguardando_assinatura_npd') {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-success add-signature-ciencia-btn';
                button.dataset.index = 0;
                button.textContent = `Assinar Ciência (1/${placeholdersNoDoc})`;
                container.appendChild(button);
            }
        }

    }

    renderDocument();

    // --- LÓGICA PARA AVANÇAR PARA COMANDANTE ---
    const btnAvancar = document.getElementById('btn-avancar-comandante');
    const avancarModal = document.getElementById('avancar-modal');

    if (btnAvancar && avancarModal) {
        const cancelAvancarBtn = document.getElementById('cancel-avancar-btn');

        btnAvancar.addEventListener('click', () => {
            avancarModal.classList.add('active');
        });

        if(cancelAvancarBtn) cancelAvancarBtn.addEventListener('click', () => {
            avancarModal.classList.remove('active');
        });

        avancarModal.addEventListener('click', (e) => {
            if (e.target === avancarModal) {
                avancarModal.classList.remove('active');
            }
        });
    }

    const btnApurar = document.getElementById('btn-apurar');
    const apuracaoForm = document.getElementById('apuracao-form');
    const btnSalvarApuracao = document.getElementById('btn-salvar-apuracao');
    const btnCancelarApuracao = document.getElementById('btn-cancelar-apuracao');

    if (btnApurar) {
        btnApurar.addEventListener('click', function() {
            const spinner = this.querySelector('.spinner');
            const analiseActions = document.getElementById('analise-actions');
            spinner.style.display = 'inline-block';
            this.disabled = true;
    
            // Limpa mensagens de feedback anteriores
            const existingFeedback = analiseActions.querySelector('.feedback-message');
            if (existingFeedback) {
                existingFeedback.remove();
            }
    
            const url = `{% url 'Ouvidoria:analisar_punicao' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Os dados estão prontos, preenche e exibe o formulário
                    const analise = data.analise_data;
                    const itensStr = (analise.itens || []).map(item => `${item.numero || 'N/A'}: ${item.descricao || ''}`).join('\n');
                    document.getElementById('itens_enquadrados').value = itensStr;
                    document.getElementById('atenuantes').value = (analise.circunstancias.atenuantes || []).join(', ');
                    document.getElementById('agravantes').value = (analise.circunstancias.agravantes || []).join(', ');
                    document.getElementById('punicao_sugerida').value = analise.punicao || '';
    
                    btnApurar.style.display = 'none';
                    if (apuracaoForm) apuracaoForm.style.display = 'block';
    
                } else { // Cobre 'processing' e qualquer outro status de erro
                    const feedback = document.createElement('div');
                    feedback.className = 'feedback-message';
                    feedback.classList.add(data.status === 'processing' ? 'processing' : 'error');
                    feedback.textContent = data.message;
                    analiseActions.appendChild(feedback);
                }
            })
            .catch(err => {
                console.error('Fetch Error:', err);
                const feedback = document.createElement('div');
                feedback.className = 'feedback-message error';
                feedback.textContent = 'Erro de comunicação ao buscar análise.';
                analiseActions.appendChild(feedback);
            })
            .finally(() => {
                spinner.style.display = 'none';
                this.disabled = false;
            });
        });
    }

    if (btnCancelarApuracao) {
        btnCancelarApuracao.addEventListener('click', function() {
            apuracaoForm.style.display = 'none';
            if (btnApurar) btnApurar.style.display = 'block';
        });
    }

    if (btnSalvarApuracao) {
        btnSalvarApuracao.addEventListener('click', function() {
            const spinner = this.querySelector('.spinner');
            spinner.style.display = 'inline-block';
            this.disabled = true;

            // Coleta os dados do formulário (que podem ter sido editados)
            const itensText = document.getElementById('itens_enquadrados').value;
            const itensList = itensText.split('\n').map(line => {
                const parts = line.split(':');
                if (parts.length > 1) {
                    return { numero: parseInt(parts[0].trim()), descricao: parts[1].trim() };
                }
                return null;
            }).filter(item => item);

            const dataToSave = {
                itens_enquadrados: itensList,
                circunstancias: {
                    atenuantes: document.getElementById('atenuantes').value.split(',').map(s => s.trim()).filter(Boolean),
                    agravantes: document.getElementById('agravantes').value.split(',').map(s => s.trim()).filter(Boolean),
                },
                punicao_sugerida: document.getElementById('punicao_sugerida').value
            };

            const url = `{% url 'Ouvidoria:salvar_apuracao' patd.pk %}`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(dataToSave)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(`Erro ao salvar apuração: ${data.message}`);
                }
            })
            .catch(err => {
                alert('Erro de comunicação ao salvar a apuração.');
                console.error(err);
            })
            .finally(() => {
                spinner.style.display = 'none';
                this.disabled = false;
            });
        });
    }
    
    // --- LÓGICA PARA RECONSIDERAÇÃO ---
    const reconsideracaoModal = document.getElementById('reconsideracao-modal');
    if (reconsideracaoModal) {
        const openBtn = document.getElementById('btn-reconsideracao-modal');
        const cancelBtn = document.getElementById('cancel-reconsideracao-btn');
        const confirmBtn = document.getElementById('confirm-reconsideracao-btn');

        if (openBtn) {
            openBtn.addEventListener('click', () => reconsideracaoModal.classList.add('active'));
        }
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => reconsideracaoModal.classList.remove('active'));
        }
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                const url = `{% url 'Ouvidoria:solicitar_reconsideracao' patd.pk %}`;
                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => console.error('Erro:', error));
            });
        }
        reconsideracaoModal.addEventListener('click', e => {
            if (e.target === reconsideracaoModal) reconsideracaoModal.classList.remove('active');
        });
    }

    // --- LÓGICA PARA O PRAZO DE RECONSIDERAÇÃO ---
    const reconsideracaoCountdownTimer = document.getElementById('reconsideracao-countdown-timer');
    const reconsideracaoPrazoBox = document.getElementById('reconsideracao-prazo-box');

    if (reconsideracaoCountdownTimer && '{{ patd.data_publicacao_punicao }}') {
        const dataPublicacao = new Date('{{ patd.data_publicacao_punicao|date:"c" }}');
        const deadline = new Date(dataPublicacao.getTime() + 15 * 24 * 60 * 60 * 1000); // Adiciona 15 dias

        const interval = setInterval(() => {
            const now = new Date();
            const diff = deadline - now;

            if (diff <= 0) {
                reconsideracaoCountdownTimer.textContent = "Prazo expirado.";
                if (reconsideracaoPrazoBox) reconsideracaoPrazoBox.classList.add('expirado');
                clearInterval(interval);
                // O backend cuidará da mudança de status, então apenas atualizamos a UI.
                return;
            }

            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            reconsideracaoCountdownTimer.textContent = `${d}d ${h}h ${m}m ${s}s restantes`;
        }, 1000);
    }

    // --- LÓGICA PARA MODAL DE TEXTO DE RECONSIDERAÇÃO ---
    const reconsideracaoTextoModal = document.getElementById('reconsideracao-texto-modal');
    if (reconsideracaoTextoModal) {
        const cancelBtn = document.getElementById('cancel-reconsideracao-texto-btn');
        const submitBtn = document.getElementById('submit-reconsideracao-texto-btn');
        const textArea = document.getElementById('reconsideracao-texto-input');

        // Listener no body para o botão que é renderizado dinamicamente
        document.body.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'add-reconsideracao-texto-btn-doc') {
                textArea.value = '{{ patd.texto_reconsideracao|default_if_none:""|escapejs }}';
                reconsideracaoTextoModal.classList.add('active');
            }
        });

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => reconsideracaoTextoModal.classList.remove('active'));
        }

        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                const texto = textArea.value;
                if (texto.trim() === "") {
                    alert("O campo de reconsideração não pode estar vazio.");
                    return;
                }
                const url = `{% url 'Ouvidoria:salvar_reconsideracao' patd.pk %}`;
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ 'texto_reconsideracao': texto })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Erro: ' + data.message);
                    }
                })
                .catch(error => console.error('Erro:', error));
            });
        }
        
        reconsideracaoTextoModal.addEventListener('click', e => {
            if (e.target === reconsideracaoTextoModal) reconsideracaoTextoModal.classList.remove('active');
        });
    }
});
</script>
{% endblock %}


