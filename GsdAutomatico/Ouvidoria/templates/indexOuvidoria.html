{% extends 'base.html' %}

{% block title %}Analisador de Documentos{% endblock %}

{% block content %}
<style>
    .analisador-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start; }
    @media (max-width: 992px) { .analisador-grid { grid-template-columns: 1fr; } }
    .upload-form .file-label { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 200px; padding: 20px; border-radius: 8px; border: 2px dashed var(--border-color); box-sizing: border-box; margin-bottom: 15px; text-align: center; cursor: pointer; color: var(--text-secondary); transition: border-color 0.3s, background-color 0.3s; }
    .upload-form .file-label svg { width: 48px; height: 48px; margin-bottom: 15px; color: var(--accent-color); }
    .upload-form .file-label:hover { border-color: var(--accent-color); background-color: var(--sidebar-active-bg); }
    .upload-form button { width: 100%; padding: 15px; background-color: var(--accent-color); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .upload-form button:hover { background-color: var(--accent-hover); }
    .upload-form button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
    .upload-form button .spinner { width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .analise-box { border: 1px solid var(--border-color); padding: 25px; border-radius: 8px; background-color: var(--bg-content); min-height: 280px; display: flex; flex-direction: column; }
    .analise-box h3 { margin-top: 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .analise-resultado p, .militar-nao-encontrado p { margin: 12px 0; font-size: 16px; line-height: 1.7; }
    .analise-resultado strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
    .loading-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; flex-grow: 1; text-align: center; color: var(--text-secondary); }
    .loading-state .big-spinner { width: 40px; height: 40px; border: 4px solid var(--sidebar-active-bg); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    .prompt-actions { margin-top: 20px; display: flex; gap: 10px; }
</style>

<h1>Analisador de Documentos</h1>
<p>Envie um PDF para extrair automaticamente as informações e criar uma PATD.</p>

<div class="analisador-grid" style="margin-top: 20px;">
    <div class="upload-column">
        <form id="analise-form" class="upload-form">
            {% csrf_token %}
            <label for="pdf_file_input" class="file-label" id="file-label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 18.75a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                <span id="file-label-text">Clique ou arraste o ficheiro PDF</span>
            </label>
            <input type="file" name="pdf_file" id="pdf_file_input" accept=".pdf" required style="display: none;">
            <button type="button" id="submit-btn">
                <span class="spinner"></span>
                <span class="button-text">Analisar e Criar PATD</span>
            </button>
        </form>
    </div>
    <div class="resultado-column">
        <div class="analise-box" id="analise-box">
            <h3>Aguardando Documento</h3>
            <p>O resultado da análise e da criação da PATD aparecerá aqui.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('pdf_file_input');
    const fileLabel = document.getElementById('file-label');
    const fileLabelText = document.getElementById('file-label-text');
    const submitButton = document.getElementById('submit-btn');
    const analiseBox = document.getElementById('analise-box');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // --- CORREÇÃO ADICIONADA AQUI ---
    // Adiciona um event listener para o input de ficheiro
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                // Se um ficheiro for selecionado, mostra o nome dele no label
                fileLabelText.textContent = this.files[0].name;
            } else {
                // Se a seleção for cancelada, volta ao texto original
                fileLabelText.textContent = 'Clique ou arraste o ficheiro PDF';
            }
        });
    }

    // --- CÓDIGO PARA FUNCIONALIDADE DE ARRASTAR E SOLTAR ---
    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileLabel.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    fileLabel.addEventListener('dragover', () => {
        fileLabel.style.borderColor = 'var(--accent-color)';
        fileLabel.style.backgroundColor = 'var(--sidebar-active-bg)';
    });

    fileLabel.addEventListener('dragleave', () => {
        fileLabel.style.borderColor = 'var(--border-color)';
        fileLabel.style.backgroundColor = 'transparent';
    });

    fileLabel.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        preventDefaults(e);
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length) {
            fileInput.files = files;
            fileLabelText.textContent = files[0].name;
        }

        // Restaura o estilo
        fileLabel.style.borderColor = 'var(--border-color)';
        fileLabel.style.backgroundColor = 'transparent';
    }
    // --- FIM DO CÓDIGO ADICIONADO ---

    // --- FUNÇÃO PARA TRATAR PATD EXISTENTE ---
    function handlePatdExists(data) {
        displayResult(`
            <h3>PATD Duplicada</h3>
            <div class="patd-existente">
                <p>${data.message}</p>
                <p>Deseja visualizar o processo já existente?</p>
                <div class="prompt-actions">
                    <a href="${data.url}" class="btn btn-primary">Ver PATD Existente</a>
                </div>
            </div>
        `);
    }
    
    // --- FUNÇÃO PARA LIDAR COM MILITAR NÃO ENCONTRADO ---
    function handleMilitarNotFound(resultado) {
        const formHtml = `
            <div class="militar-nao-encontrado">
                <h3>Militar Não Encontrado</h3>
                <p>O militar <strong>${resultado.nome_completo}</strong> não foi encontrado. Preencha os dados abaixo para cadastrá-lo e criar a PATD.</p>
                <form id="create-militar-form" class="model-form">
                    <div class="form-grid">
                        <p><label for="id_nome_completo">Nome Completo:</label><input type="text" name="nome_completo" value="${resultado.nome_completo}" required id="id_nome_completo"></p>
                        <p><label for="id_nome_guerra">Nome de Guerra:</label><input type="text" name="nome_guerra" required id="id_nome_guerra"></p>
                        <p><label for="id_saram">SARAM:</label><input type="number" name="saram" id="id_saram"></p>
                        <p><label for="id_posto">Posto/Grad.:</label><input type="text" name="posto" id="id_posto"></p>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="create-militar-btn" class="btn btn-primary">Cadastrar e Criar PATD</button>
                    </div>
                </form>
            </div>
        `;
        displayResult(formHtml);

        // Adiciona o listener para o novo formulário
        const createMilitarForm = document.getElementById('create-militar-form');
        if (createMilitarForm) {
            createMilitarForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const createBtn = document.getElementById('create-militar-btn');
                createBtn.textContent = 'Aguarde...';
                createBtn.disabled = true;

                const militarFormData = new FormData(createMilitarForm);
                militarFormData.append('action', 'create_militar_and_patd');
                militarFormData.append('transgressao', resultado.transgressao);
                militarFormData.append('data_ocorrencia', resultado.data_ocorrencia);

                fetch("{% url 'Ouvidoria:index' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: new URLSearchParams(militarFormData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayResult(`<h3>Sucesso</h3><p>${data.message}</p>`);
                    } else {
                        displayResult(`<h3 style="color: #d8000c;">Erro</h3><p>Não foi possível cadastrar o militar.</p>`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    displayResult(`<h3 style="color: #d8000c;">Erro</h3><p>Ocorreu um erro de comunicação.</p>`);
                });
            });
        }
    }


    submitButton.addEventListener('click', () => {
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Por favor, selecione um ficheiro PDF antes de analisar.');
            return;
        }

        const formData = new FormData();
        formData.append('pdf_file', fileInput.files[0]);
        formData.append('action', 'analyze');

        setUIState(true);

        fetch("{% url 'Ouvidoria:index' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayResult(`<h3>Sucesso</h3><p>${data.message}</p>`);
            } else if (data.status === 'militar_not_found') {
                handleMilitarNotFound(data.resultado);
            } else if (data.status === 'patd_exists') {
                handlePatdExists(data);
            } else {
                displayResult(`<h3 style="color: #d8000c;">Erro na Análise</h3><p>${data.message || data.error}</p>`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayResult(`<h3 style="color: #d8000c;">Erro na Análise</h3><p>${error.message || 'Não foi possível comunicar com o servidor.'}</p>`);
        })
        .finally(() => {
            const buttonText = submitButton.querySelector('.button-text');
            const spinner = submitButton.querySelector('.spinner');
            buttonText.textContent = 'Analisar e Criar PATD';
            spinner.style.display = 'none';
            submitButton.disabled = false;
        });
    });

    function setUIState(isSubmitting) {
        const spinner = submitButton.querySelector('.spinner');
        const buttonText = submitButton.querySelector('.button-text');
        if (isSubmitting) {
            buttonText.textContent = 'A analisar...';
            spinner.style.display = 'block';
            submitButton.disabled = true;
            analiseBox.innerHTML = `<div class="loading-state"><div class="big-spinner"></div><p>A processar o documento...<br>Isto pode levar alguns segundos.</p></div>`;
        } else {
            buttonText.textContent = 'Analisar e Criar PATD';
            spinner.style.display = 'none';
            submitButton.disabled = false;
        }
    }

    function displayResult(htmlContent) {
        analiseBox.innerHTML = htmlContent;
    }
});
</script>
{% endblock %}