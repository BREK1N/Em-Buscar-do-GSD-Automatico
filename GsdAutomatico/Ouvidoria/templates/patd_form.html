{% extends 'base.html' %}
{% load auth_extras %}

{% block title %}Editar PATD Nº {{ form.instance.numero_patd }}{% endblock %}

{% block content %}
<style>
    /* Estilos (mantêm-se os mesmos) */
    .form-card {
        background-color: var(--bg-content);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: var(--box-shadow);
    }
    .form-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    .form-card-header svg {
        width: 24px;
        height: 24px;
        color: var(--accent-color);
    }
    .form-card-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }
    .form-card-body .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    .form-card-body .form-item {
        display: flex;
        flex-direction: column;
    }
    .form-card-body .form-item.full-width {
        grid-column: 1 / -1;
    }
    .form-card-body .form-item label {
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-secondary);
    }
    .form-card-body .form-item input,
    .form-card-body .form-item select,
    .form-card-body .form-item textarea {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-main);
        color: var(--text-primary);
        box-sizing: border-box;
    }
    .form-card-body .form-item textarea {
        min-height: 100px;
        resize: vertical;
    }
    .form-card-body .form-item small {
        margin-top: 5px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    .form-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .regenerate-btn {
        background: none;
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
    }
    .alert-error { /* Adicionado para erros */
        color: var(--danger-color);
        font-size: 0.8rem;
        margin-top: 5px;
    }
</style>

<div class="patd-header">
    <h1>Editar PATD Nº {{ form.instance.numero_patd }}</h1>
    <p>Militar: <strong>{{ form.instance.militar }}</strong></p>
</div>

<form method="post" class="model-form">
    {% csrf_token %}
    {{ form.non_field_errors }} {# Exibe erros gerais do formulário #}

    <div class="form-card">
        <div class="form-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12.75h.008M8.25 15h.008M8.25 18h.008m3.75-12h.008m2.25-3h.008M12 6h.008m-2.25 6h.008m2.25 6h.008M12 18h.008m-3.75-6h.008m2.25-6h.008" /></svg>
            <h2>Informações da Transgressão</h2>
        </div>
        <div class="form-card-body">
            <div class="form-grid">
                <div class="form-item full-width">
                    <label for="{{ form.transgressao.id_for_label }}">{{ form.transgressao.label }}:</label>
                    {{ form.transgressao }}
                    {% for error in form.transgressao.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.data_ocorrencia.id_for_label }}">{{ form.data_ocorrencia.label }}:</label>
                    {{ form.data_ocorrencia }}
                    {% for error in form.data_ocorrencia.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="form-card">
        <div class="form-card-header">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 001.13-1.897M16.5 7.5V18L18 15.75l-1.5-3.75V7.5z" /></svg>
            <h2>Envolvidos</h2>
        </div>
        <div class="form-card-body">
            <div class="form-grid">
                 <div class="form-item">
                    <label for="{{ form.oficial_responsavel.id_for_label }}">{{ form.oficial_responsavel.label }}:</label>
                    {{ form.oficial_responsavel }}
                    {% for error in form.oficial_responsavel.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.testemunha1.id_for_label }}">{{ form.testemunha1.label }}:</label>
                    {{ form.testemunha1 }}
                    {% for error in form.testemunha1.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.testemunha2.id_for_label }}">{{ form.testemunha2.label }}:</label>
                    {{ form.testemunha2 }}
                    {% for error in form.testemunha2.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="form-card">
        <div class="form-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
             <h2>Dados da Apuração (IA)</h2>
        </div>
        <div class="form-card-body">
            <div class="form-grid">
                <div class="form-item full-width">
                    <div class="form-item-header">
                        <label for="{{ form.ocorrencia_reescrita.id_for_label }}">{{ form.ocorrencia_reescrita.label }}:</label>
                        <button type="button" class="regenerate-btn" id="regenerate-ocorrencia">Gerar com IA</button>
                    </div>
                    {{ form.ocorrencia_reescrita }}
                    {% for error in form.ocorrencia_reescrita.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item full-width">
                    <div class="form-item-header">
                        <label for="{{ form.alegacao_defesa_resumo.id_for_label }}">{{ form.alegacao_defesa_resumo.label }}:</label>
                        <button type="button" class="regenerate-btn" id="regenerate-resumo">Gerar com IA</button>
                    </div>
                    {{ form.alegacao_defesa_resumo }}
                    {% for error in form.alegacao_defesa_resumo.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item full-width">
                    <div class="form-item-header">
                        <label for="{{ form.texto_relatorio.id_for_label }}">{{ form.texto_relatorio.label }}:</label>
                        <button type="button" class="regenerate-btn" id="regenerate-relatorio">Gerar com IA</button>
                    </div>
                    {{ form.texto_relatorio }}
                    {% for error in form.texto_relatorio.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item full-width">
                    <label for="{{ form.itens_enquadrados_text.id_for_label }}">{{ form.itens_enquadrados_text.label }}:</label>
                    {{ form.itens_enquadrados_text }}
                    <small>{{ form.itens_enquadrados_text.help_text }}</small>
                    {% for error in form.itens_enquadrados_text.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.atenuantes.id_for_label }}">{{ form.atenuantes.label }}:</label>
                    {{ form.atenuantes }}
                    <small>{{ form.atenuantes.help_text }}</small>
                    {% for error in form.atenuantes.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.agravantes.id_for_label }}">{{ form.agravantes.label }}:</label>
                    {{ form.agravantes }}
                    <small>{{ form.agravantes.help_text }}</small>
                    {% for error in form.agravantes.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.punicao_sugerida_dias.id_for_label }}">{{ form.punicao_sugerida_dias.label }}:</label>
                    {{ form.punicao_sugerida_dias }}
                    <small>{{ form.punicao_sugerida_dias.help_text }}</small>
                    {% for error in form.punicao_sugerida_dias.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.punicao_sugerida_tipo.id_for_label }}">{{ form.punicao_sugerida_tipo.label }}:</label>
                    {{ form.punicao_sugerida_tipo }}
                    <small>{{ form.punicao_sugerida_tipo.help_text }}</small>
                    {% for error in form.punicao_sugerida_tipo.errors %}<div class="alert-error">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    {% if form.instance.status == 'aguardando_preenchimento_npd_reconsideracao' or form.instance.status == 'aguardando_publicacao' %}
    <div class="form-card">
        <div class="form-card-header">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
            <h2>Punição Pós-Reconsideração</h2>
        </div>
        <div class="form-card-body">
            <div class="form-grid">
                 <div class="form-item">
                    <label for="{{ form.nova_punicao_dias_num.id_for_label }}">{{ form.nova_punicao_dias_num.label }}:</label>
                    {{ form.nova_punicao_dias_num }}
                    <small>{{ form.nova_punicao_dias_num.help_text }}</small>
                     {% for error in form.nova_punicao_dias_num.errors %}<div class="alert-error" style="margin-top: 5px;">{{ error }}</div>{% endfor %}
                </div>
                <div class="form-item">
                    <label for="{{ form.nova_punicao_tipo.id_for_label }}">{{ form.nova_punicao_tipo.label }}:</label>
                    {{ form.nova_punicao_tipo }}
                     {% for error in form.nova_punicao_tipo.errors %}<div class="alert-error" style="margin-top: 5px;">{{ error }}</div>{% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        <a href="{% url 'Ouvidoria:patd_detail' form.instance.pk %}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<script>
// JavaScript existente para os botões "Gerar com IA"
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function handleRegenerate(buttonId, url, textareaId) {
        const button = document.getElementById(buttonId);
        if (!button) return;

        button.addEventListener('click', function() {
            button.textContent = 'Gerando...';
            button.disabled = true;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(textareaId).value = data.novo_texto;
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro de comunicação.');
            })
            .finally(() => {
                button.textContent = 'Gerar com IA';
                button.disabled = false;
            });
        });
    }

    handleRegenerate('regenerate-ocorrencia', `{% url 'Ouvidoria:regenerar_ocorrencia' form.instance.pk %}`, '{{ form.ocorrencia_reescrita.id_for_label }}');
    handleRegenerate('regenerate-resumo', `{% url 'Ouvidoria:regenerar_resumo_defesa' form.instance.pk %}`, '{{ form.alegacao_defesa_resumo.id_for_label }}');
    handleRegenerate('regenerate-relatorio', `{% url 'Ouvidoria:regenerar_texto_relatorio' form.instance.pk %}`, '{{ form.texto_relatorio.id_for_label }}');
});
</script>

{% endblock %}