{% extends 'base.html' %}

{% block title %}Dashboard do Comandante{% endblock %}

{% block content %}
<h1>PATDs Aguardando Decisão</h1>
<p>Processos que requerem sua análise para aprovação ou retorno.</p>

<div class="table-responsive">
    <table class="data-table">
        <thead>
            <tr>
                <th>N° PATD</th>
                <th>Militar Acusado</th>
                <th>Data da Ocorrência</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for patd in patds %}
            <tr>
                <td>{{ patd.numero_patd }}</td>
                <td>{{ patd.militar }}</td>
                <td>{{ patd.data_ocorrencia|date:"d/m/Y"|default:"-" }}</td>
                <td>{{ patd.get_status_display }}</td>
                <td class="actions-cell">
                    <a href="{% url 'Ouvidoria:patd_detail' patd.pk %}" class="btn btn-sm btn-secondary">Ver Detalhes</a>
                    <button type="button" class="btn btn-sm btn-success open-aprovar-modal-btn" data-patd-pk="{{ patd.pk }}" data-patd-numero="{{ patd.numero_patd }}">
                        Aprovar e Finalizar
                    </button>
                    <button type="button" class="btn btn-sm btn-warning open-retornar-modal-btn" data-patd-pk="{{ patd.pk }}" data-patd-numero="{{ patd.numero_patd }}">Retornar para Alteração</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 20px;">Nenhuma PATD aguardando decisão.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="retornar-patd-modal">
    <div class="modal-content">
        <h3 id="retornar-modal-title">Retornar PATD</h3>
        <p>Por favor, insira abaixo o motivo para retornar esta PATD para alteração. O oficial apurador será notificado com sua observação.</p>
        <form id="retornar-patd-form" method="post" action="" class="model-form">
            {% csrf_token %}
            <div class="form-item">
                <label for="id_comentario">Comentário:</label>
                <textarea name="comentario" required id="id_comentario" rows="5" style="width: 100%;"></textarea>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-retornar-btn">Cancelar</button>
                <button type="submit" class="btn btn-warning">Confirmar Retorno</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="aprovar-patd-modal">
    <div class="modal-content">
        <h3 id="aprovar-modal-title">Aprovar PATD</h3>
        <p>Para confirmar a aprovação desta PATD e aplicar sua assinatura digital, por favor, insira sua senha.</p>
        <form id="aprovar-patd-form" method="post" action="" class="model-form">
            {% csrf_token %}
            <div class="form-item">
                <label for="id_senha_comandante">Sua Senha:</label>
                <input type="password" name="senha_comandante" required id="id_senha_comandante" autocomplete="current-password">
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-aprovar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Confirmar Aprovação</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Lógica do Modal de Retorno (existente) ---
    const retornarModal = document.getElementById('retornar-patd-modal');
    const retornarForm = document.getElementById('retornar-patd-form');
    const retornarModalTitle = document.getElementById('retornar-modal-title');
    const cancelRetornarBtn = document.getElementById('cancel-retornar-btn');

    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('open-retornar-modal-btn')) {
            const patdPk = e.target.dataset.patdPk;
            const patdNumero = e.target.dataset.patdNumero;
            const url = `/Ouvidoria/patd/${patdPk}/retornar/`;
            retornarForm.action = url;
            retornarModalTitle.textContent = `Retornar PATD Nº ${patdNumero}`;
            retornarModal.classList.add('active');
        }
    });

    if (cancelRetornarBtn) {
        cancelRetornarBtn.addEventListener('click', () => {
            retornarModal.classList.remove('active');
        });
    }

    if (retornarModal) {
        retornarModal.addEventListener('click', (e) => {
            if (e.target === retornarModal) {
                retornarModal.classList.remove('active');
            }
        });
    }

    // --- NOVA Lógica do Modal de Aprovação ---
    const aprovarModal = document.getElementById('aprovar-patd-modal');
    const aprovarForm = document.getElementById('aprovar-patd-form');
    const aprovarModalTitle = document.getElementById('aprovar-modal-title');
    const cancelAprovarBtn = document.getElementById('cancel-aprovar-btn');

    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('open-aprovar-modal-btn')) {
            const patdPk = e.target.dataset.patdPk;
            const patdNumero = e.target.dataset.patdNumero;
            // A action do form agora aponta para a URL de aprovação correta
            const url = `/Ouvidoria/patd/${patdPk}/aprovar/`;
            aprovarForm.action = url;
            aprovarModalTitle.textContent = `Aprovar PATD Nº ${patdNumero}`;
            aprovarModal.classList.add('active');
        }
    });

    if (cancelAprovarBtn) {
        cancelAprovarBtn.addEventListener('click', () => {
            aprovarModal.classList.remove('active');
        });
    }

    if (aprovarModal) {
        aprovarModal.addEventListener('click', (e) => {
            if (e.target === aprovarModal) {
                aprovarModal.classList.remove('active');
            }
        });
    }
});
</script>
{% endblock %}