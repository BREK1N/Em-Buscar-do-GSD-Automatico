{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Ouvidoria{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <h2>Menu</h2>
            <ul>
                <li>
                    <a href="{% url 'Ouvidoria:index' %}" class="{% if request.resolver_match.url_name == 'index' %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <span>Analisador</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'Ouvidoria:militar_list' %}" class="{% if 'militar' in request.resolver_match.url_name %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-2.305c.394-.434.394-1.135 0-1.569a9.337 9.337 0 00-4.121-2.305 9.38 9.38 0 00-2.625.372M15 19.128v-3.857M15 19.128c-1.58 0-3.097-.63-4.242-1.757M15 19.128c.143.01.287.017.432.017h.008M15 19.128c-1.58 0-3.097-.63-4.242-1.757m0 0a9.38 9.38 0 01-2.625-.372 9.337 9.337 0 01-4.121 2.305c-.394.434-.394 1.135 0 1.569a9.337 9.337 0 014.121 2.305 9.38 9.38 0 012.625-.372m0 0v3.857m0 0c1.58 0 3.097.63 4.242 1.757" /></svg>
                        <span>Efetivo</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'Ouvidoria:patd_list' %}" class="{% if 'patd' in request.resolver_match.url_name %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z" /></svg>
                        <span>PATDs</span>
                    </a>
                </li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <a href="#" id="settings-btn">
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 50 50">
<path d="M 22.199219 2 A 1.0001 1.0001 0 0 0 21.214844 2.8339844 L 20.205078 8.796875 C 19.01608 9.1476749 17.903339 9.6072866 16.835938 10.173828 L 11.875 6.6816406 A 1.0001 1.0001 0 0 0 10.59375 6.7929688 L 6.6933594 10.693359 A 1.0001 1.0001 0 0 0 6.5820312 11.974609 L 10.076172 16.939453 C 9.5032306 17.983292 9.0447681 19.109183 8.6992188 20.298828 L 2.8457031 21.212891 A 1.0001 1.0001 0 0 0 2 22.199219 L 2 27.699219 A 1.0001 1.0001 0 0 0 2.8339844 28.685547 L 8.7949219 29.693359 C 9.1451119 30.880887 9.6045402 31.990547 10.169922 33.056641 L 6.6875 37.917969 A 1.0001 1.0001 0 0 0 6.7929688 39.207031 L 10.693359 43.107422 A 1.0001 1.0001 0 0 0 11.974609 43.21875 L 16.939453 39.724609 C 17.985462 40.298683 19.114316 40.757752 20.306641 41.103516 L 21.314453 47.066406 A 1.0001 1.0001 0 0 0 22.300781 47.900391 L 27.800781 47.900391 A 1.0001 1.0001 0 0 0 28.783203 47.082031 L 29.884766 41.107422 C 31.077734 40.756262 32.193186 40.294742 33.263672 39.726562 L 38.224609 43.21875 A 1.0001 1.0001 0 0 0 39.507812 43.107422 L 43.40625 39.207031 A 1.0001 1.0001 0 0 0 43.509766 37.914062 L 39.931641 32.957031 C 40.500209 31.91951 40.957756 30.82106 41.300781 29.693359 L 47.169922 28.685547 A 1.0001 1.0001 0 0 0 48 27.699219 L 48 22.199219 A 1.0001 1.0001 0 0 0 47.166016 21.214844 L 41.199219 20.203125 C 40.855563 19.074235 40.397841 17.973827 39.828125 16.935547 L 43.318359 11.974609 A 1.0001 1.0001 0 0 0 43.207031 10.693359 L 39.306641 6.7929688 A 1.0001 1.0001 0 0 0 38.013672 6.6894531 L 33.052734 10.273438 C 32.009656 9.7017023 30.885686 9.2413677 29.697266 8.8964844 L 28.685547 2.8359375 A 1.0001 1.0001 0 0 0 27.699219 2 L 22.199219 2 z M 23.044922 4 L 26.853516 4 L 27.814453 9.7636719 A 1.0001 1.0001 0 0 0 28.556641 10.570312 C 30.07104 10.948913 31.478126 11.514935 32.675781 12.251953 A 1.0001 1.0001 0 0 0 33.785156 12.210938 L 38.494141 8.8085938 L 41.197266 11.511719 L 37.882812 16.224609 A 1.0001 1.0001 0 0 0 37.847656 17.324219 C 38.584675 18.521874 39.154586 19.937607 39.533203 21.357422 A 1.0001 1.0001 0 0 0 40.333984 22.085938 L 46 23.044922 L 46 26.857422 L 40.429688 27.814453 A 1.0001 1.0001 0 0 0 39.632812 28.542969 C 39.254196 29.962783 38.686237 31.378517 37.949219 32.576172 A 1.0001 1.0001 0 0 0 37.990234 33.685547 L 41.390625 38.394531 L 38.6875 41.097656 L 33.974609 37.78125 A 1.0001 1.0001 0 0 0 32.904297 37.732422 C 31.566632 38.496802 30.2627 39.053466 28.757812 39.429688 A 1.0001 1.0001 0 0 0 28.017578 40.21875 L 26.966797 45.900391 L 23.144531 45.900391 L 22.185547 40.232422 A 1.0001 1.0001 0 0 0 21.443359 39.429688 C 19.92896 39.051088 18.521874 38.485065 17.324219 37.748047 A 1.0001 1.0001 0 0 0 16.224609 37.78125 L 11.511719 41.097656 L 8.8066406 38.392578 L 12.113281 33.783203 A 1.0001 1.0001 0 0 0 12.167969 32.703125 C 11.403582 31.365465 10.846925 30.061529 10.470703 28.556641 A 1.0001 1.0001 0 0 0 9.6660156 27.814453 L 4 26.855469 L 4 23.056641 L 9.5546875 22.1875 A 1.0001 1.0001 0 0 0 10.371094 21.443359 C 10.749694 19.92896 11.313763 18.521874 12.050781 17.324219 A 1.0001 1.0001 0 0 0 12.017578 16.224609 L 8.7011719 11.511719 L 11.412109 8.8027344 L 16.125 12.117188 A 1.0001 1.0001 0 0 0 17.195312 12.167969 C 18.532978 11.403589 19.836909 10.846925 21.341797 10.470703 A 1.0001 1.0001 0 0 0 22.085938 9.6660156 L 23.044922 4 z M 25 17 C 20.570085 17 17 20.570085 17 25 C 17 29.429915 20.570085 33 25 33 C 29.429915 33 33 29.429915 33 25 C 33 20.570085 29.429915 17 25 17 z M 25 19 C 28.370085 19 31 21.629915 31 25 C 31 28.370085 28.370085 31 25 31 C 21.629915 31 19 28.370085 19 25 C 19 21.629915 21.629915 19 25 19 z"></path>
</svg>
                <span>Configuração</span>
            </a>
        </div>
    </div>
    <div class="main-wrapper">
        <header class="main-header">
            <button class="mobile-nav-toggle" id="mobile-nav-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
            </button>
            <button class="theme-switcher" id="theme-toggle" title="Alterar tema">
                <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display:none;"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
            </button>
        </header>
        <div class="main-container">
            <div class="content-column">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="settings-modal-content">
            <nav class="settings-nav">
                <a href="#" class="settings-tab active" data-target="painel-aparencia">Aparência</a>
                <a href="#" class="settings-tab" data-target="painel-assinaturas">Assinaturas</a>
                <a href="#" class="settings-tab" data-target="painel-geral">Geral</a>
            </nav>
            <div class="settings-painels">
                <div id="painel-aparencia" class="settings-painel active">
                    <div class="settings-painel-header">
                        <div class="settings-modal-header">
                            <h3>Aparência</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                    </div>
                    <div class="settings-painel-body">
                        <p>Personalize a aparência da interface.</p>
                        <div class="form-group">
                            <label for="theme-select">Tema</label>
                            <select id="theme-select">
                                <option value="light-theme">Claro</option>
                                <option value="dark-theme">Escuro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="painel-assinaturas" class="settings-painel">
                    <div class="settings-painel-header">
                        <div class="settings-modal-header">
                            <h3>Gerir Assinaturas Padrão</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="form-group">
                            <input type="text" id="search-oficial" placeholder="Pesquisar por nome ou posto...">
                        </div>
                    </div>
                    <div class="settings-painel-body">
                        <ul class="oficiais-list" id="oficiais-list-container">
                            <!-- A lista de oficiais será carregada aqui via JS -->
                        </ul>
                    </div>
                </div>

                <div id="painel-geral" class="settings-painel">
                    <div class="settings-painel-header">
                         <div class="settings-modal-header">
                            <h3>Configurações Gerais</h3>
                             <button class="close-btn">&times;</button>
                        </div>
                    </div>
                    <div class="settings-painel-body">
                        <p>Opções gerais do sistema.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Assinatura (Reutilizado) -->
    <div class="modal-overlay" id="signature-modal-pessoal">
        <div class="signature-modal-content">
            <h3 id="signature-modal-title">Definir Assinatura Padrão</h3>
            <p>Desenhe a assinatura no campo abaixo.</p>
            <div class="canvas-container">
                <canvas id="signature-canvas-pessoal"></canvas>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="clear-signature-btn-pessoal">Limpar</button>
                <button type="button" class="btn btn-secondary" id="cancel-signature-btn-pessoal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-signature-btn-pessoal">Salvar Assinatura</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const body = document.body;
            const csrfToken = '{{ csrf_token }}';
            
            // --- LÓGICA DO SELETOR DE TEMA ---
            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            const themeSelect = document.getElementById('theme-select');

            function applyTheme(theme) {
                body.className = '';
                body.classList.add(theme);
                localStorage.setItem('theme', theme);
                updateIcon(theme);
                if (themeSelect) themeSelect.value = theme;
            }

            function updateIcon(theme) {
                if (sunIcon && moonIcon) {
                    sunIcon.style.display = (theme === 'dark-theme') ? 'none' : 'block';
                    moonIcon.style.display = (theme === 'dark-theme') ? 'block' : 'none';
                }
            }
            
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark-theme' : 'light-theme');
            applyTheme(savedTheme);

            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    let newTheme = body.classList.contains('dark-theme') ? 'light-theme' : 'dark-theme';
                    applyTheme(newTheme);
                });
            }
            
            if (themeSelect) {
                themeSelect.addEventListener('change', (e) => {
                    applyTheme(e.target.value);
                });
            }

        
            const settingsModal = document.getElementById('settings-modal');
            const openSettingsBtn = document.getElementById('settings-btn');
            const closeButtons = settingsModal.querySelectorAll('.close-btn');
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const settingspainels = document.querySelectorAll('.settings-painel');

            if(openSettingsBtn) {
                openSettingsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    settingsModal.classList.add('active');
                    if(document.querySelector('.settings-tab[data-target="painel-assinaturas"]').classList.contains('active')) {
                        loadOficiais();
                    }
                });
            }

            const closeModal = () => {
                settingsModal.classList.remove('active');
            };
            closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    closeModal();
                }
            });

            settingsTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    settingsTabs.forEach(t => t.classList.remove('active'));
                    settingspainels.forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    const targetpainel = document.getElementById(tab.getAttribute('data-target'));
                    if (targetpainel) {
                        targetpainel.classList.add('active');
                    }
                    if(tab.getAttribute('data-target') === 'painel-assinaturas') {
                        loadOficiais();
                    }
                });
            });

            
            const oficiaisListContainer = document.getElementById('oficiais-list-container');
            const signatureModalPessoal = document.getElementById('signature-modal-pessoal');
            const signatureCanvasPessoal = document.getElementById('signature-canvas-pessoal');
            const signaturePadPessoal = new SignaturePad(signatureCanvasPessoal, { backgroundColor: 'rgb(255, 255, 255)' });
            const searchOficialInput = document.getElementById('search-oficial');
            let currentOficialId = null;
            let searchTimeout;

            function resizeCanvasPessoal() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                signatureCanvasPessoal.width = signatureCanvasPessoal.offsetWidth * ratio;
                signatureCanvasPessoal.height = signatureCanvasPessoal.offsetHeight * ratio;
                signatureCanvasPessoal.getContext("2d").scale(ratio, ratio);
                signaturePadPessoal.clear();
            }

            function loadOficiais(query = '') {
                oficiaisListContainer.innerHTML = '<p>A carregar oficiais...</p>';
                const url = `{% url 'Ouvidoria:lista_oficiais' %}?q=${encodeURIComponent(query)}`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        oficiaisListContainer.innerHTML = '';
                        if (data.length === 0) {
                            oficiaisListContainer.innerHTML = '<p>Nenhum oficial encontrado.</p>';
                            return;
                        }
                        data.forEach(oficial => {
                            const listItem = document.createElement('li');
                            const signaturePreview = oficial.assinatura 
                                ? `<img src="${oficial.assinatura}" alt="Assinatura">`
                                : '<span class="no-signature">Sem assinatura</span>';

                            listItem.innerHTML = `
                                <div class="oficial-info">
                                    <div class="signature-preview">${signaturePreview}</div>
                                    <span>${oficial.posto} ${oficial.nome_guerra}</span>
                                </div>
                                <button class="btn btn-sm btn-secondary manage-signature-btn" data-oficial-id="${oficial.id}" data-oficial-nome="${oficial.posto} ${oficial.nome_guerra}">
                                    ${oficial.assinatura ? 'Alterar' : 'Adicionar'} Assinatura
                                </button>
                            `;
                            oficiaisListContainer.appendChild(listItem);
                        });
                    })
                    .catch(error => {
                        oficiaisListContainer.innerHTML = '<p>Erro ao carregar a lista de oficiais.</p>';
                        console.error('Error fetching oficiais:', error);
                    });
            }

            searchOficialInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadOficiais(searchOficialInput.value);
                }, 300); // Espera 300ms após o utilizador parar de digitar
            });

            oficiaisListContainer.addEventListener('click', function(e) {
                const targetButton = e.target.closest('.manage-signature-btn');
                if (targetButton) {
                    currentOficialId = targetButton.dataset.oficialId;
                    const oficialNome = targetButton.dataset.oficialNome;
                    document.getElementById('signature-modal-title').textContent = `Assinatura de ${oficialNome}`;
                    signatureModalPessoal.classList.add('active');
                    resizeCanvasPessoal();
                }
            });

            document.getElementById('cancel-signature-btn-pessoal').addEventListener('click', () => {
                signatureModalPessoal.classList.remove('active');
                signaturePadPessoal.clear();
                currentOficialId = null;
            });

            document.getElementById('clear-signature-btn-pessoal').addEventListener('click', () => {
                signaturePadPessoal.clear();
            });

            document.getElementById('save-signature-btn-pessoal').addEventListener('click', () => {
                if (!currentOficialId) return;
                const signatureData = signaturePadPessoal.isEmpty() ? "" : signaturePadPessoal.toDataURL('image/png');
                const url = `/Ouvidoria/militar/${currentOficialId}/salvar_assinatura_padrao/`;

                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ 'signature_data': signatureData })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        signatureModalPessoal.classList.remove('active');
                        loadOficiais(searchOficialInput.value);
                    } else {
                        alert('Erro ao salvar a assinatura: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ocorreu um erro de comunicação ao salvar a assinatura.');
                });
            });

            
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            const sidebar = document.getElementById('sidebar');

            if (mobileNavToggle && sidebar) {
                mobileNavToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.toggle('active');
                });

                document.addEventListener('click', (e) => {
                    const isClickInsideSidebar = sidebar.contains(e.target);
                    const isClickOnToggle = mobileNavToggle.contains(e.target);

                    if (sidebar.classList.contains('active') && !isClickInsideSidebar && !isClickOnToggle) {
                        sidebar.classList.remove('active');
                    }
                });
            }
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
