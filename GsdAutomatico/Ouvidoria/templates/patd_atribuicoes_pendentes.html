{% extends 'base.html' %}

{% block title %}Minhas Atribuições de PATD{% endblock %}

{% block content %}
<style>
    /* Estilos para as abas, similar ao patd_detail.html */
    .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .tabs-nav a { padding: 10px 20px; text-decoration: none; color: var(--text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; /* Alinha com a borda inferior */ cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .tabs-nav a.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
</style>

<h1>Minhas Atribuições de PATD</h1>
<p>Gerencie os processos administrativos que foram atribuídos a você.</p>

<nav class="tabs-nav">
    <a href="{% url 'Ouvidoria:patd_atribuicoes_pendentes' %}?tab=aprovar" class="tab-link {% if active_tab == 'aprovar' %}active{% endif %}">
        <span>Para Aprovar</span>
        {% if count_aprovar > 0 %}<span class="badge">{{ count_aprovar }}</span>{% endif %}
    </a>
    <a href="{% url 'Ouvidoria:patd_atribuicoes_pendentes' %}?tab=apuracao" class="tab-link {% if active_tab == 'apuracao' %}active{% endif %}">
        <span>Em Apuração</span>
        {% if count_apuracao > 0 %}<span class="badge">{{ count_apuracao }}</span>{% endif %}
    </a>
    <a href="{% url 'Ouvidoria:patd_atribuicoes_pendentes' %}?tab=reconsideracao" class="tab-link {% if active_tab == 'reconsideracao' %}active{% endif %}">
        <span>Reconsideração</span>
        {% if count_reconsideracao > 0 %}<span class="badge">{{ count_reconsideracao }}</span>{% endif %}
    </a>
    <a href="{% url 'Ouvidoria:patd_atribuicoes_pendentes' %}?tab=todas" class="tab-link {% if active_tab == 'todas' %}active{% endif %}">
        Todas as Atribuições
    </a>
</nav>

<div class="table-responsive">
    <table class="data-table">
        <thead>
            <tr>
                <th>N° PATD</th>
                <th>Militar Acusado</th>
                <th>Data da Ocorrência</th>
                <th>Status</th>
                <th>Ação</th>
            </tr>
        </thead>
        <tbody>
            {% for patd in patds %}
            <tr>
                <td>{{ patd.numero_patd }}</td>
                <td>
                    <a href="{% url 'Ouvidoria:patd_detail' patd.pk %}" class="militar-acusado-link">{{ patd.militar }}</a>
                </td>
                <td>{{ patd.data_ocorrencia|date:"d/m/Y"|default:"-" }}</td>
                <td>{{ patd.get_status_display }}</td>
                <td class="actions-cell">
                    {% if active_tab == 'aprovar' %}
                        <button type="button" class="btn btn-sm btn-success open-aceite-modal-btn" data-patd-pk="{{ patd.pk }}" data-patd-numero="{{ patd.numero_patd }}">
                            Aceitar Atribuição
                        </button>
                    {% else %}
                         <a href="{% url 'Ouvidoria:patd_detail' patd.pk %}" class="btn btn-sm btn-primary">Ver Detalhes</a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 20px;">Nenhuma PATD encontrada nesta categoria.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="aceitar-atribuicao-modal">
    <div class="modal-content">
        <h3 id="aceitar-modal-title">Aceitar Atribuição</h3>
        <p>Para confirmar que aceita ser o oficial responsável por esta PATD, por favor, insira a sua senha.</p>
        <form id="aceitar-atribuicao-form" method="post" action="" class="model-form">
            {% csrf_token %}
            <div class="form-grid">
                <p>
                    <label for="id_senha_aceite">Sua Senha:</label>
                    <input type="password" name="senha" required id="id_senha_aceite" autocomplete="current-password">
                </p>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancel-aceitar-btn">Cancelar</button>
                <button type="submit" class="btn btn-success">Confirmar e Aceitar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const aceitarModal = document.getElementById('aceitar-atribuicao-modal');
    const aceitarForm = document.getElementById('aceitar-atribuicao-form');
    const aceitarModalTitle = document.getElementById('aceitar-modal-title');
    const cancelAceitarBtn = document.getElementById('cancel-aceitar-btn');
    
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('open-aceite-modal-btn')) {
            const patdPk = e.target.dataset.patdPk;
            const patdNumero = e.target.dataset.patdNumero;
            
            // A action do form agora aponta para a URL de aceite correta
            const url = `/Ouvidoria/patd/${patdPk}/aceitar_atribuicao/`;
            aceitarForm.action = url;
            aceitarModalTitle.textContent = `Aceitar Atribuição - PATD Nº ${patdNumero}`;
            
            aceitarModal.classList.add('active');
        }
    });

    if (cancelAceitarBtn) {
        cancelAceitarBtn.addEventListener('click', () => {
            aceitarModal.classList.remove('active');
        });
    }

    if (aceitarModal) {
        aceitarModal.addEventListener('click', (e) => {
            if (e.target === aceitarModal) {
                aceitarModal.classList.remove('active');
            }
        });
    }
});
</script>
{% endblock %}